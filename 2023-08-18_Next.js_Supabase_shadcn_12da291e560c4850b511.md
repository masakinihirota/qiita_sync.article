<!--
title:   Next.js App Dir 認証機能付き (メール GitHub) 開発用テンプレート (Supabase shadcn/ui Storybook )
tags:    GitHub認証,Next.js,Supabase,shadcn,メール認証
id:      12da291e560c4850b511
private: true
-->

# テンプレートを使用する方法

このリポジトリ↓がテンプレートとして利用できます。

masakinihirota/template_next

https://github.com/masakinihirota/template_next

「Use this template」
緑ボタンを押します。

新しいリポジトリが出来るのでそこから開発を始めます。

これより下は、このテンプレートの作成時のメモ兼ハンズオンになります。



# この記事の趣旨

このリポジトリは既存のツールを組み合わせているだけなので何の機能もありません。
だからサンプルやデモではなくテンプレートです。

ただ、現在、複数の機能をまとめるだけでも微妙な設定変更が必要で、それには多くの調査が必要になるためここにテンプレートとして記録に残しておきます。

この記事ではNext.js の↓公式サンプルを利用したテンプレートを作成します。

next.js/examples/with-supabase at canary · vercel/next.js

https://github.com/vercel/next.js/tree/canary/examples/with-supabase



またこのリポジトリは
Supabaseで推奨↓されている方法です。

Supabase Auth with the Next.js App Router | Supabase Docs

https://supabase.com/docs/guides/auth/auth-helpers/nextjs

```
Automatic Configuration (recommended)#

npx create-next-app -e with-supabase

```

と書かれています。



# 以前作っていたサンプルからの変更理由

↑のサンプルは、Next.jsのApp Dirを利用した認証情報のサンプルです。また、Server Actionなどの実験的な機能も追加されています。このサンプルを土台にして、自分が作っていたテンプレートを載せる形になります。
↑のサンプルに以前作っていたテンプレート↓で使用していた技術をそのまま再利用します。



## 以前のテンプレート

Next.js app router 開発用テンプレート (Storybook Supabase shadcn/ui) - Qiita

https://qiita.com/masakinihirota/items/3ad7a1564d2b6c56d4db

Next.js App Router 開発用テンプレートに shadcn/ui でダークモードを実装する。 - Qiita

https://qiita.com/masakinihirota/items/7cf6181ba61fe9dc3802

※理由として、公式がApp Dir対応の認証付きサンプルを公開したためです。
この以前のテンプレート↑には認証は未実装でした。
app routerに対応した認証方法を各ユーザーが試行錯誤していた時期でした。
私自身も独自の認証よりは公式が採用している認証方式を採用して信頼度をあげたかったためそのまま採用しました。



# 前提条件

Supabaseのアカウントは作成して、
プロジェクトを作ってあるものとします。

開発環境や技術選定にあるツールはある程度知っているものとします。



# 開発環境

Windows 10
PowerShell
VSCode with GitHub Copilot chat
Next.js 13 app dir
Supabase
Storybook
shadcn/ui
Vercel
i18n
JSDoc



# 技術選定

Next.js
Supabase
メール認証（cookie）
GitHub認証
shadcn/ui
Storybook
ダークモード
i18n



# 追加予定

GitHub認証
Supabase
shadcn/ui
i18n
JSDoc
Storybook
Vercel



# 土台となるサンプルをインストール

Next.js公式サンプルをインストールします。

npx create-next-app -e with-supabase 

npm i eslint eslint-config-next

npm i @supabase/supabase-js @supabase/auth-helpers-nextjs



## 環境ファイルを作る

touch .env.local

```.env.local
NEXT_PUBLIC_SUPABASE_URL=https://zhlmcrnnjbsfhbnctenz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ey***********************************74

```

※Supabaseでプロジェクトを作成済みで、
プロジェクトの設定情報は知っているものとします。

.env.local.example
は削除します。



## 動作確認

npm run dev
を実行すると起動確認が出来るはずです。

これでサンプルのインストールまでは完了です。



# srcディレクトリの使用

src ディレクトリを作成してファイルを移動します。

srcディレクトリを作ります。

mkdir src

tsconfig.jsonファイルを一部変更

```tsconfig.json
    "paths": {
      "@/*": ["./src/*"]
    }

```



tailwind.config.jsファイルを一部変更

```tailwind.config.js
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],

```

※src/pages はNext.jsのpages dirを使っていたときの名残ですね。
Next.js 13 は pages dir と app dir の両方を同時に使えるので残しておきます。



package.jsonファイルを一部変更

```package.json
  "name": "vns.blue",
  "version": "0.1.0",

```

名前は自由につけてください。



## ディレクトリの移動

srcの下にappディレクトリとcomponentsディレクトリを移動します。



## 動作確認

npm run dev
でエラーが出ずに正常に表示されたら成功です。

Supabaseのダッシュボードでアプリを作成し
.env.localファイルの設定が正常にしてあると
ログインが出来るはずです。





# GitHub認証

最初のサンプルにはメール認証がついていましたが、
これにGitHub認証を追加してマルチ認証を実装します。



## 参考


4 Create an OAuth App with GitHub | egghead.io

https://egghead.io/lessons/supabase-create-an-oauth-app-with-github

Supabase GitHubでログイン - Oauth認証 - Qiita

https://qiita.com/maaaashi/items/05b4226f228a31088550

Next.jsでsupabaseを使って、認証からデータベースの更新までをやってみる

https://zenn.dev/hrtk/articles/3da84e46c97267



## SupabaseとGitHubの設定

まずは
Supabaseの左サイドバーのAuthenticationを選択します。
左サイドバーすぐ右側に Authenticationのリストが表示されます。
その中の Providers を選択すると、Auth Providers のリストが表示されます。

デフォルトでは Emailが Enable（有効化）されています。

GitHubを開き、
GitHubを選択して、
GitHub enabled ボタンを押します。

まず 一番下の Callback URL (for OAuth) がありますのでメモしておきます。

この Callback URL (for OAuth) は GitHubで使います。


次に
Client ID
Client Secret
この2つは GitHub の

Developer applications

https://github.com/settings/developers

このページから 右上にある New OAuth App ボタンを押して
これから作成するアプリを登録することで表示されます。



```
Register a new OAuth application
Application name
[アプリ名]

Homepage URL
[http://localhost:3000/]

Application description

Authorization callback URL
[Supabaseのダッシュボードから↓]
[https://jd***********wg.supabase.co/auth/v1/callback]

```

登録が完了したら

GitHubで
Client ID
Client Secret
をメモしておきます。

※Client Secret が表示されるのは一度だけですので取り扱いに気をつけてください。


Supabaseに戻ります。

Supabase の GitHubのところに戻ったら

Client ID
Client Secret
を登録して Save ボタンを押します。

これで Supabase と GitHub 相互に情報の登録が終わりました。

次にログインボタンを実装します。



# GitHub ログイン ボタンの実装







↓この動画を参考にします。


5 Authenticate Users with GitHub OAuth using Supabase and Next.js Client Components | egghead.io
https://egghead.io/lessons/supabase-authenticate-users-with-github-oauth-using-supabase-and-next-js-client-components


まずは
src\app\page.tsx
のページ表示部分をログイン以外削除します。


```src\app\page.tsx
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs"
import { cookies } from "next/headers"
import Link from "next/link"
import LogoutButton from "../components/LogoutButton"

export default async function Index() {
  const supabase = createServerComponentClient({ cookies })

  const {
    data: { user },
  } = await supabase.auth.getUser()

  return (
    <div>
      {user ? (
        <div className="flex items-center gap-4">
          Hey, {user.email}!
          <LogoutButton />
        </div>
      ) : (
        <Link
          href="/login"
          className="px-4 py-2 no-underline rounded-md bg-btn-background hover:bg-btn-background-hover"
        >
          Login
        </Link>
      )}
    </div>
  )
}

```



touch src\app\auth-button.tsx

```app\auth-button.tsx
"use client";

import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

export default function AuthButton() {
  const supabase = createClientComponentClient();

  const handleSignOut = async () => {
    await supabase.auth.signOut();
  };

  const handleSignIn = async () => {
    await supabase.auth.signInWithOAuth({
      provider: "github",
      options: {
        redirectTo: "http://localhost:3000/auth/callback",
      },
    });
  };

  return (
    <>
      <button onClick={handleSignIn}>Login</button>
      <button onClick={handleSignOut}>Logout</button>
    </>
  );
}

```




















































































































































後でインストール
.eslintrc.jsonが無い

