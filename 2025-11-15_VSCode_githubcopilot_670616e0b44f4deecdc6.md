<!--
title:   GitHub Copilot VSCode v1.106「ハンドオフ」機能 実際にエージェントを使いバトンリレーしてみる。
tags:    VSCode,githubcopilot
id:      670616e0b44f4deecdc6
private: true
-->
# ハンドオフ」機能 開発ワークフローを自動化する３つの活用例

カスタムエージェントの力を引き出す

## 1. 「ハンドオフ」とは？— 専門家AI間のスムーズなバトンリレー

カスタムエージェントとは、特定の開発ロールやタスクに合わせてAIを構成し、専門的なペルソナを採用できるようにする機能です。例えば、**セキュリティレビュアー**や**プランナー**、**ソリューションアーキテクト**といった専門的な役割を持つエージェントを作成することが可能です。

このカスタムエージェントの力を最大限に引き出すのが、「**ハンドオフ**」機能です。

ハンドオフは、エージェント間で**ガイド付きの順序だったワークフロー**を作成することを可能にします。これにより、関連するコンテキスト（背景情報）を維持したまま、ワンクリックで一つの専門エージェントから次の専門エージェントへスムーズに移行できます。

### ハンドオフの仕組み

チャットの応答が完了した後、画面に**ハンドオフボタン**が表示されます。利用者がこのボタンを選択すると、**関連するコンテキスト**と**あらかじめ入力されたプロンプト**とともに、次のターゲットエージェントに切り替わります。

この機能は、複数のステップが必要な**マルチステップのワークフローを調整する**のに非常に有用です。また、開発者が途中の各ステップを**レビューしたり承認したりするコントロール**を維持しながら、タスクを進めることができる点も大きな利点です。

## 2. ハンドオフを活用した開発ワークフローの３つの例

ここでは、開発プロセスをより効率的で確実にする、具体的な３つのハンドオフの活用方法をご紹介します。

### 活用例 1: 計画 (Planning) から 実装 (Implementation) へ

複雑なタスクに取り組む際、いきなりコーディングを始めるのではなく、まず詳細な計画を立てることが重要です。

1.  **計画エージェントによる設計:**
    まず、**計画エージェント**を使用して実装計画を生成します。このエージェントは、プロジェクトのコンテキストを収集し、詳細な実装計画を生成するように特別な指示を与えられていることがあります。また、意図しないコードの変更を防ぐために、リサーチや分析のための**読み取り専用のツールのみ**を使用するよう設定されている場合もあります。
2.  **ハンドオフによる移行:**
    計画が生成され、開発者によって承認された後、「**実装を開始**」といったラベルのハンドオフボタンを使用して、計画の内容をコンテキストとして引き継ぎます。引き継ぎ先は、実際のコード編集能力を持つ**実装エージェント**です。

VS Codeの新しいPlanエージェントのように、実装前に要件やコンテキストを事前に把握するため、明確化の質問を促し、開発者が計画を承認してから実装に進むことができる機能も推奨されています。

### 活用例 2: 実装 (Implementation) から レビュー (Review) へ

コードの実装が完了したら、その品質をすぐにチェックすることが求められます。

1.  **実装の完了:**
    実装エージェントがコードの変更を完了し、チャット応答を終えます。
2.  **ハンドオフによる移行:**
    ここで、「**コードレビューに回す**」といったハンドオフボタンを設定します。このバトンは、**コードレビューエージェント**に渡されます。このレビューエージェントは、**セキュリティの脆弱性を特定**したり、**改善点を提案したりする**ことに特化した専門的な指示を持っています。

これにより、実装とレビューのプロセスを途切れることなく連続させることができ、コードの品質を維持しやすくなります。

### 活用例 3: 失敗するテストの作成 から 合格するテストの作成 へ

この方法は、特に大きな実装を扱う際に、検証ステップを確実に踏むために役立ちます。

1.  **失敗するテストの生成と承認:**
    まず、AIにこれから実装する機能に対する**「失敗する」テストコード**を作成してもらいます。大規模な実装そのものよりも、失敗するテストのレビューの方が容易な場合があります。
2.  **ハンドオフによる移行:**
    このテストコードを承認した後、「**テストを合格させる実装へ**」というハンドオフを実行します。次のエージェントは、**テストをパスするために必要なコード変更を実装する**タスクを引き継ぎます。

このワークフローにより、検証しやすい単位で確実に作業を進めることができます。

## 3. ハンドオフの設定方法

ハンドオフ機能は、カスタムエージェントの定義ファイル（`.agent.md`という拡張子のMarkdownファイル）の**YAMLフロントマター**（ヘッダー部分）に設定を記述することで定義します。

設定する主な項目は以下の通りです：

| 設定項目 | 説明 | 例 |
| :--- | :--- | :--- |
| `handoffs.label` | ハンドオフボタンに表示するテキストです。 | `Start Implementation` |
| `handoffs.agent` | 移行先のターゲットとなるエージェントの識別子です。 | `implementation` |
| `handoffs.prompt` | ターゲットエージェントに送りたい指示テキストです。 | `Now implement the plan outlined above.` |
| `handoffs.send` | プロンプトを自動で送信するかどうかを指定するオプションの真偽値です (既定値は `false` です)。`true` にすると、ボタンを押した瞬間に次のステップが自動で開始されます。 | `false` |

このように、ハンドオフを適切に設定することで、まるでプロのチームがバトンを渡すように、AIエージェント間で専門的な作業をコントロールしながら、順序立てて実行していくことが可能になります。是非、この機能を利用して、開発ワークフローの効率化を図ってみてください。











かしこまりました。承知いたしました。

ご提示いただいた具体的な使い方 1：「**計画 (Planning) から 実装 (Implementation) へ**」の例に基づき、ハンドオフを設定するためのプロンプトの記述例と、それに付随するYAMLフロントマターの記述例を、ソースの内容を：「**計画 (Planning) から 実装 (Implementation) へ**」の例に基づき、ハンドオフを設定するためのプロンプトの記述例と、それに付随するYAMLフロントマターの記述例を、ソースの内容を引用しながら丁寧にご説明いたします。

## 具体的な使い方 1：計画 (Planning) から 実装 (Implementation) へのハンドオフ

このシナリオでは、まず「Planner（計画）」エージェントが詳細な実装計画を作成し、その計画が承認された後、「Implementation（実装）」エージェントにバトンを渡して、実際のコーディングを開始させる流れを作成します。

### 1. 「Planner（計画）」エージェント側の設定

まず、計画を作成するエージェントのファイル（例: `planner.agent.md`）のYAMLフロントマターに、次のエージェントへのハンドオフを設定します。

| 設定項目 | 記述例 | 役割とソースの裏付け |
| :--- | :--- | :--- |
| **`description`** | `Generate an implementation plan for new features or refactoring existing code.` | このエージェントの簡単な説明です。 |
| **`tools`** | `[ 'fetch' , 'githubRepo' , 'search' , 'usages' ]` | 計画エージェントは、リサーチや分析のために読み取り専用のツールのみを使用する場合があります。 |
| **`handoffs`** | (リストとして設定) | 次のステップへの移行をガイドする項目です。 |
| **`handoffs.label`** | `- label : Implement Plan` | ハンドオフボタンに表示されるテキストです。この例では「計画を実装する」という意味です。 |
| **`handoffs.agent`** | `agent : implementation` | 移行先のターゲットエージェントの識別子を指定します。ここでは「実装」エージェントを指定しています。 |
| **`handoffs.prompt`** | `prompt : Now implement the plan outlined above.` | **次のエージェント（Implementationエージェント）に自動的に送る指示テキスト（プロンプト）**です。 |
| **`handoffs.send`** | `send : false` | ユーザーがボタンを選択した後、プロンプトを自動で送信するかどうかを設定します。`false`（既定値）の場合、ユーザーがプロンプトを確認・編集してから送信できます。|

### 記述例（YAMLフロントマター）

ソース および の例を参考に、以下のように記述されます。

```yaml
---
description : Generate an implementation plan
tools : [ 'search' , 'fetch' ]
handoffs :
 - label : Start Implementation
   agent : implementation
   prompt : Now implement the plan outlined above.
   send : false
---
```

### 抽出されたプロンプト

この活用例 1 において、最も重要なハンドオフのプロンプトは以下のようになります。

> **`prompt : Now implement the plan outlined above.`**

#### このプロンプトの解説

このプロンプトは、Plannerエージェントが**直前に生成した詳細な実装計画**（Overview、Requirements、Implementation Steps、Testingなどを含むMarkdownドキュメントとして、チャット履歴に残っているコンテキスト） を参照して、**次のImplementationエージェントに「実装作業を開始するように」指示**しています。

これにより、Implementationエージェントは、計画エージェントが立てた「計画」という文脈（コンテキスト）をシームレスに引き継ぎ、すぐに次の専門的な作業（コーディング）に取り掛かることができます。これは、開発者が計画を承認してから、作業を確実に次のステップに進めるためのコントロールを可能にします。


















承知いたしました。会話履歴でご説明したハンドオフの３つの使い方のうち、**２つ目の具体例（実装 (Implementation) → レビュー (Review)）**に焦点を当てて、ハンドオフのYAML設定とプロンプトの具体例をご説明します。

---

## 具体的な使い方 2２つ目の具体例（実装 (Implementation) → レビュー (Review)）**に焦点を当てて、ハンドオフのYAML設定とプロンプトの具体例をご説明します。

---

## 具体的な使い方 2: 実装 (Implementation) から レビュー (Review) へのハンドオフ

このシナリオは、あるエージェント（例えば、「実装エージェント」）がコードの変更を完了した後、次のステップとして**品質やセキュリティの問題を確認する**ための専門家（「コードレビューエージェント」）にスムーズにバトンを渡す例です。

### 1. ワークフローの流れ

1.  **実装の完了:** 実装エージェントがタスクを完了し、チャット応答を終えます。
2.  **ハンドオフの提示:** 画面に「コードレビューに回す」といったボタンが表示されます。
3.  **レビューエージェントへの移行:** ユーザーがボタンを押すと、実装の結果（変更されたコードのコンテキスト）が引き継がれ、**セキュリティの脆弱性を特定したり、改善点を提案したりする**ことに特化した指示を持つ**コードレビューエージェント**に切り替わります。

### 2. ハンドオフのYAMLフロントマター記述例

このハンドオフは、実装エージェントのファイル（例: `implementation.agent.md`）のYAMLフロントマターに記述されます。

| 設定項目 | 記述例 | 役割とソースの裏付け |
| :--- | :--- | :--- |
| **`description`** | `Implement code changes based on an approved plan.` | このエージェント（実装エージェント）の説明です。 |
| **`tools`** | `[ 'edit' , 'search' , 'fetch' ]` | 実装エージェントは「完全な編集能力」を必要とします。 |
| **`handoffs.label`** | `- label : Request Code Review` | ハンドオフボタンに表示されるテキストです。この例では「コードレビューをリクエスト」という意味です。 |
| **`handoffs.agent`** | `agent : code_reviewer` | 移行先のターゲットエージェントの識別子を指定します。ここでは「code\_reviewer（コードレビュアー）」エージェントを指定しています。 |
| **`handoffs.prompt`** | `prompt : Review the implementation changes just completed for quality and security issues.` | **次のエージェント（コードレビューエージェント）に自動的に送る指示テキスト（プロンプト）**です。 |
| **`handoffs.send`** | `send : false` | 既定値は`false`です。ユーザーはプロンプトを確認してから送信できます。|

### 記述例（YAMLフロントマター）

```yaml
---
description : Implement code changes based on an approved plan.
tools : [ 'edit' , 'search' ]
handoffs :
 - label : Request Code Review
   agent : code_reviewer
   prompt : Review the implementation changes just completed for quality and security issues.
   send : false
---
```

### 抽出されたプロンプト

この活用例 2 のハンドオフで次のエージェントに送られるプロンプトは以下のようになります。

> **`prompt : Review the implementation changes just completed for quality and security issues.`**

#### このプロンプトの解説

このプロンプトは、ターゲットである**コードレビューエージェント**に対して、「直前に完了した実装による変更」をコンテキストとして捉え、**品質（Quality）とセキュリティ（Security）の問題点がないかを確認する**という専門的なタスクを明確に指示しています。

コードレビューエージェントは、通常、「セキュリティの脆弱性を特定し、改善点を提案する」といった**専門的な指示**を持って構成されています。このプロンプトと連携することで、レビューエージェントはすぐにその専門能力を発揮し、必要なチェックを開始します。














承知いたしました。承知いたしました。ハンドオフ機能の活用例として、**３つ目の具体例（失敗するテストの作成 → 合格するテストの作成）**について、その設定とプロンプトの具体的な記述例を、ソースに基づきご説明いたします。

## 具体的な使い方 3: 失敗するテストの作成 → 合格するテストの作成へのハンドオフ

このシナリオは、大規模な実装を一度にレビューするのではなく、検証しやすい小さなステップで作業を進めるための高度なワークフローです。まず、AIに意図的に失敗するテストコードを作成させ、そのテストが通るように次のエージェントに必要なコード変更の実装を指示します。

### 1. ワークフローの流れ

1.  **テスト作成エージェントの完了:**
    *   まず、**テスト作成エージェント**が、これから実装する機能がまだ存在しないために「失敗する」テストコードを生成します。
2.  **ハンドオフの提示:**
    *   このテストコードの内容を開発者が確認し、承認した後、「実装に進む」といったハンドオフボタンが表示されます。
3.  **実装エージェントへの移行:**
    *   ユーザーがボタンを選択すると、**生成された失敗テスト**をコンテキストとして引き継ぎ、次の「実装エージェント」に切り替わります。
    *   実装エージェントは、このテストを合格させるために必要なコード変更を行うタスクを引き継ぎます。

この手法は、テスト駆動開発（TDD）のアプローチをAIワークフローに取り込むことに似ており、実装の確実性を高めます。

### 2. ハンドオフのYAMLフロントマター記述例

このハンドオフは、失敗するテストを作成するエージェント（例: `failing_tester.agent.md`）のYAMLフロントマターに記述されます。

| 設定項目 | 記述例 | 役割とソースの裏付け |
| :--- | :--- | :--- |
| **`description`** | `Generate tests that currently fail for a feature that needs implementation.` | このエージェント（失敗テスト作成者）の説明です。 |
| **`handoffs.label`** | `- label : Implement to Pass Tests` | ハンドオフボタンに表示されるテキストです。 |
| **`handoffs.agent`** | `agent : implementation` | 移行先のターゲットエージェントの識別子を指定します（この場合、コード編集能力を持つ実装エージェント）。 |
| **`handoffs.prompt`** | `prompt : Implement the required code changes to make the tests outlined above pass.` | **次のエージェント（実装エージェント）に送る指示テキスト（プロンプト）**です。 |
| **`handoffs.send`** | `send : false` | ユーザーがボタンを選択した後、プロンプトを自動で送信するかどうかを設定します (既定値は `false` です)。|

### 記述例（YAMLフロントマター）

```yaml
---
description : Generate failing tests that need implementation to pass.
tools : [ 'search' , 'fetch' ]
handoffs :
 - label : Implement to Pass Tests
   agent : implementation
   prompt : Implement the required code changes to make the tests outlined above pass.
   send : false
---
```

### 抽出されたプロンプト

この活用例 3 のハンドオフで次のエージェントに送られるプロンプトは以下のようになります。

> **`prompt : Implement the required code changes to make the tests outlined above pass.`**

#### このプロンプトの解説

このプロンプトは、次の**実装エージェント**に対し、「直前のコンテキスト（つまり、**失敗するテスト**）を参照し、**そのテストが合格するために必要なコード変更を実装する**」という具体的なタスクを指示しています。

この指示により、実装エージェントは、実装の目標が抽象的な機能ではなく、目の前にある具体的なテストケースをクリアすることであると理解し、**必要なコード変更のみに集中して**作業を進めることが可能になります。















アイデア＞計画＞要件定義＞ 設計＞TDDでの実装＞失敗するテスト＞成功するテスト＞＞＞完成  というような感じでハンドオフを書いてみて



お客様のご提示された高度で体系的な開発ワークフロー（アイデアから完成まで）を実現するために、カスタムエージェントの「ハンドオフ」機能を連鎖させた具体的な設定例を作成いたします。

このワークフローでは、それぞれのフェーズ（役割）ごとに専門のカスタムエージェントが設定されていると仮定し、前のエージェントの出力（コンテキスト）を次のエージェントにプロンプトを介して確実に引き継ぎます。

### ワークフローの構成

| ステップ | 開発フェーズ | 担当エージェント (Source) | 移行先エージェント (Target) | 関連するソース情報 |
| :--- | :--- | :--- | :--- | :--- |
| **Step 1** | アイデア → 計画/設計 | `idea_agent` | `planner` | 専門的な役割の作成, 計画エージェントの存在 |
| **Step 2** | 計画/設計 → TDDテスト準備 | `planner` | `failing_tester` | 計画から実装への移行例 |
| **Step 3** | 失敗するテスト → 実装/成功 | `failing_tester` | `implementation` | 失敗テストを合格テストへ導く例 |
| **Step 4** | 実装 → 完成/レビュー | `implementation` | `code_reviewer` | 実装からレビューへの移行例 |

---

## 1. Step 1: アイデア → 計画・要件定義・設計

最初のエージェントが生成した「アイデア」を、計画・設計の専門家である`planner`エージェントに引き継ぎます。

### 移行元: `idea_agent.agent.md` (アイデア生成エージェント) の設定

このエージェントは、ユーザーとの対話を通じて初期のアイデアや目標を明確化した後に、ハンドオフを実行します。

| 設定項目 | 記述例 |
| :--- | :--- |
| `handoffs.label` | `詳細な計画と設計を開始` |
| `handoffs.agent` | `planner` |
| `handoffs.prompt` | **`このアイデアと目標に基づき、要件定義、高レベル設計、および実装ステップを含む詳細な計画を生成してください。`** |

```yaml
---
description : Initial brainstorming and idea definition.
handoffs :
 - label : 詳細な計画と設計を開始
   agent : planner
   prompt : このアイデアと目標に基づき、要件定義、高レベル設計、および実装ステップを含む詳細な計画を生成してください。
   send : false
---
```
*解説: `planner`エージェントは、プロジェクトのコンテキストを収集し、詳細な実装計画を生成するよう指示されている役割です。*

## 2. Step 2: 計画・設計 → TDDでの失敗テスト作成

`planner`エージェントによって要件定義と設計が承認された後、TDDワークフローを開始するために、失敗するテストを作成するエージェントに引き継ぎます。

### 移行元: `planner.agent.md` (計画エージェント) の設定

| 設定項目 | 記述例 |
| :--- | :--- |
| `handoffs.label` | `TDD用の失敗テストを作成` |
| `handoffs.agent` | `failing_tester` |
| `handoffs.prompt` | **`承認された要件と設計に基づき、実装対象の機能に対応する、現在は失敗するテストケースを最初に作成してください。`** |

```yaml
---
description : Generate implementation plans, requirements, and design overview.
tools : [ 'search' , 'fetch' ]
handoffs :
 - label : TDD用の失敗テストを作成
   agent : failing_tester
   prompt : 承認された要件と設計に基づき、実装対象の機能に対応する、現在は失敗するテストケースを最初に作成してください。
   send : false
---
```
*解説: 大規模な実装を一度にレビューする代わりに、失敗するテストを先に生成することは、より検証しやすいステップで進めるために役立ちます。*

## 3. Step 3: 失敗するテスト → 実装（成功するテスト）

失敗するテストが承認された後、いよいよコードの実装を行い、そのテストを合格させるタスクを実装エージェントに引き継ぎます。これは、ソースで言及されている「Write Failing Tests → Write Passing Tests」のプロセスを体現します。

### 移行元: `failing_tester.agent.md` (失敗テスト作成エージェント) の設定

| 設定項目 | 記述例 |
| :--- | :--- |
| `handoffs.label` | `実装を開始し、テストを合格させる` |
| `handoffs.agent` | `implementation` |
| `handoffs.prompt` | **`直前に提示された失敗テストをすべて合格させるために必要なコード変更を実装し、ファイルに適用してください。`** |

```yaml
---
description : Generate failing tests based on the implementation plan.
handoffs :
 - label : 実装を開始し、テストを合格させる
   agent : implementation
   prompt : 直前に提示された失敗テストをすべて合格させるために必要なコード変更を実装し、ファイルに適用してください。
   send : false
---
```

## 4. Step 4: 実装（成功するテスト） → 完成・レビュー

実装が完了し、テストが成功した（合格するテストが揃った）後、最終的な品質とセキュリティのチェックを行うレビューエージェントに引き継ぎ、「完成」のステップへと進めます。

### 移行元: `implementation.agent.md` (実装エージェント) の設定

| 設定項目 | 記述例 |
| :--- | :--- |
| `handoffs.label` | `最終コードレビューに提出` |
| `handoffs.agent` | `code_reviewer` |
| `handoffs.prompt` | **`完了した実装（テスト合格済み）のコード変更全体について、品質、セキュリティ、および設計との整合性をレビューしてください。`** |

`yaml
---
description : Implement code changes and ensure tests pass.
tools : [ 'edit' , 'search' ]
handoffs :
 - label : 最終コードレビューに提出
   agent : code_reviewer
   prompt : 完了した実装（テスト合格済み）のコード変更全体について、品質、セキュリティ、および設計との整合性をレビューしてください。
   send : false
---
`
*解説: レビューエージェントは、セキュリティの脆弱性を特定し、改善点を提案することに特化した専門的な指示を持つことができます。*

この一連のハンドオフを設定することで、お客様の望む「アイデア」から「完成」に至るまでの一貫した、統制の取れた開発ワークフローをAIエージェント間で実現できます。この機能は、開発者に各ステップの**レビューと承認のコントロール**を維持させながら、マルチステップのワークフローをオーケストレーションします。