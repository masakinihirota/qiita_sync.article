<!--
title:   nextjs14 ã§conform ã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã€‚
tags:    Next.js,conform
id:      2119937371c2db97ed1a
private: false
-->

# Conform

Conform

https://ja.conform.guide/


## å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Conform Next.js

Conform / Next.js

https://ja.conform.guide/integration/nextjs



Conformã¯ã€Next.jsã‚„Remixãªã©ã®ã‚µãƒ¼ãƒãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’å®Œå…¨ã«ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•ãªãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
Next.js ã® Server Actions ã«å¯¾å¿œ

# ã‚¤ãƒ¡ãƒ¼ã‚¸

## Login

![conform_Login.PNG](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44761/f79c61a9-2b83-2bac-58d1-125752dbc9b3.png)



## Signup

![conform_Signup.PNG](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44761/71d039f4-0d8f-0661-0842-f802bc2a2222.png)



## Todo list

![conform_Todo list.PNG](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44761/c6a01e11-e9c6-2e27-b779-46567b83e75c.png)



# ãƒªãƒã‚¸ãƒˆãƒª

edmundhung/conform: A type-safe form validation library utilizing web fundamentals to progressively enhance HTML Forms with full support for server frameworks like Remix and Next.js.

https://github.com/edmundhung/conform

ğŸ‘†ã“ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã¯ã€
conformã®å…¬å¼ã‚µãƒ³ãƒ—ãƒ« Next.jsç‰ˆ

ğŸ‘‡ã“ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã¯ã€
conformã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¦‹ã‚„ã™ãæ•´ç†ã—ãŸã‚‚ã®ã€‚

masakinihirota/nextjs14_conform

https://github.com/masakinihirota/nextjs14_conform



# ãƒãƒ³ã‚ºã‚ªãƒ³

ã“ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã«ã¯æ•´ç†ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

## nextjs 14 ã§conformã‚’å‹•ã‹ã™ã€‚

```terminal
> pnpm dlx create-next-app nextjs14
âˆš Would you like to use TypeScript? ... No / [Yes]
âˆš Would you like to use ESLint? ... No / [Yes]
âˆš Would you like to use Tailwind CSS? ... No / [Yes]
âˆš Would you like to use `src/` directory? ... No / [Yes]
âˆš Would you like to use App Router? (recommended) ... No / [Yes]
âˆš Would you like to customize the default import alias (@/*)? ... No / [Yes]
âˆš What import alias would you like configured? ... @/*

```

```terminal
pnpm install zod
pnpm install --save @conform-to/react @conform-to/zod

```

## appãƒ•ã‚©ãƒ«ãƒ€ä¸‹ Layout.tsx

```nextjs14\src\app\layout.tsx
import type { Metadata } from "next";
import Link from 'next/link';

export const metadata: Metadata = {
  title: 'NextJS - Conform Example',
  description: 'This is a NextJS project with Conform'
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  // console.log('RootLayout:children', children);

  return (
    <html lang="ja">
      <body>
        <main>
          {/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ãƒªãƒ³ã‚¯ã‚’ä½œã‚‹ã€‚ */}
          <ul className="flex ">
            <li>
              <Link href="login">Login</Link>
            </li>
            <li>
              <Link href="signup">Signup</Link>
            </li>
            <li>
              <Link href="todos">Todo list</Link>
            </li>
          </ul>
          <hr />
          {children}
        </main>
      </body>
    </html>
  );
}

```

## appãƒ•ã‚©ãƒ«ãƒ€ä¸‹ Page.tsx

```nextjs14\src\app\page.tsx
export default function Index({
  searchParams
}: {
  searchParams: { [key: string]: string | string[] | undefined };
}) {
  const value = searchParams['value'];

  if (!value) {
    return null;
  }

  return (
    <div>
      Submitted the following value:
      <pre>{JSON.stringify(JSON.parse(value.toString()), null, 2)}</pre>
    </div>
  );
}

```

## ä»–ã®appãƒ•ã‚©ãƒ«ãƒ€ä¸‹ã¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã¿

```nextjs14\src\app\login\page.tsx
import { LoginForm } from '@/components/form';

export default function Login() {
  return <LoginForm />;
}

```

```nextjs14\src\app\signup\page.tsx
import { SignupForm } from '@/components/form';

export default function Signup() {
  return <SignupForm />;
}

```

```nextjs14\src\app\todos\page.tsx
import { TodoForm } from '@/components/form';

export default function Todos() {
  return <TodoForm />;
}

```

## æ©Ÿèƒ½ã¯componentsä¸‹ã«é…ç½®

```nextjs14\src\components\form.tsx
'use client';

import {
  useForm,
  getFormProps,
  getInputProps,
  getFieldsetProps
} from '@conform-to/react';
import { parseWithZod } from '@conform-to/zod';
import { useFormState, useFormStatus } from 'react-dom';
import { createTodos, login, signup } from './actions';
import { todosSchema, loginSchema, createSignupSchema } from './schema';

function Button(props: React.ButtonHTMLAttributes<HTMLButtonElement>) {
  const { pending } = useFormStatus();

  return <button {...props} disabled={pending || props.disabled} />;
}

export function TodoForm() {
  const [lastResult, action] = useFormState(createTodos, undefined);
  const [form, fields] = useForm({
    lastResult,
    onValidate({ formData }) {
      return parseWithZod(formData, { schema: todosSchema });
    },
    shouldValidate: 'onBlur'
  });
  const tasks = fields.tasks.getFieldList();

  return (
    <form action={action} {...getFormProps(form)}>
      <div>
        <label>Title</label>
        <input
          className={!fields.title.valid ? 'error' : ''}
          {...getInputProps(fields.title, { type: 'text' })}
          key={fields.title.key}
        />
        <div>{fields.title.errors}</div>
      </div>
      <hr />
      <div className="form-error">{fields.tasks.errors}</div>
      {tasks.map((task, index) => {
        const taskFields = task.getFieldset();

        return (
          <fieldset key={task.key} {...getFieldsetProps(task)}>
            <div>
              <label>Task #{index + 1}</label>
              <input
                className={!taskFields.content.valid ? 'error' : ''}
                {...getInputProps(taskFields.content, { type: 'text' })}
                key={taskFields.content.key}
              />
              <div>{taskFields.content.errors}</div>
            </div>
            <div>
              <label>
                <span>Completed</span>
                <input
                  className={!taskFields.completed.valid ? 'error' : ''}
                  {...getInputProps(taskFields.completed, {
                    type: 'checkbox'
                  })}
                  key={taskFields.completed.key}
                />
              </label>
            </div>
            <Button
              {...form.remove.getButtonProps({
                name: fields.tasks.name,
                index
              })}
            >
              Delete
            </Button>
            <Button
              {...form.reorder.getButtonProps({
                name: fields.tasks.name,
                from: index,
                to: 0
              })}
            >
              Move to top
            </Button>
            <Button
              {...form.update.getButtonProps({
                name: task.name,
                value: { content: '' }
              })}
            >
              Clear
            </Button>
          </fieldset>
        );
      })}
      <Button {...form.insert.getButtonProps({ name: fields.tasks.name })}>
        Add task
      </Button>
      <hr />
      <Button>Save</Button>
    </form>
  );
}

export function LoginForm() {
  const [lastResult, action] = useFormState(login, undefined);
  const [form, fields] = useForm({
    // Sync the result of last submission
    lastResult,

    // Reuse the validation logic on the client
    onValidate({ formData }) {
      return parseWithZod(formData, { schema: loginSchema });
    },

    // Validate the form on blur event triggered
    shouldValidate: 'onBlur'
  });

  return (
    <form action={action} {...getFormProps(form)}>
      <div>
        <label>Email</label>
        <input
          className={!fields.email.valid ? 'error' : ''}
          {...getInputProps(fields.email, { type: 'text' })}
          key={fields.email.key}
        />
        <div>{fields.email.errors}</div>
      </div>
      <div>
        <label>Password</label>
        <input
          className={!fields.password.valid ? 'error' : ''}
          {...getInputProps(fields.password, { type: 'password' })}
          key={fields.password.key}
        />
        <div>{fields.password.errors}</div>
      </div>
      <label>
        <div>
          <span>Remember me</span>
          <input {...getInputProps(fields.remember, { type: 'checkbox' })} />
        </div>
      </label>
      <hr />
      <Button>Login</Button>
    </form>
  );
}

export function SignupForm() {
  const [lastResult, action] = useFormState(signup, undefined);
  const [form, fields] = useForm({
    lastResult,
    onValidate({ formData }) {
      return parseWithZod(formData, {
        // Create the schema without any constraint defined
        schema: (control) => createSignupSchema(control)
      });
    },
    shouldValidate: 'onBlur',
    shouldRevalidate: 'onInput'
  });

  return (
    <form action={action} {...getFormProps(form)}>
      <label>
        <div>Username</div>
        <input
          className={!fields.username.valid ? 'error' : ''}
          {...getInputProps(fields.username, { type: 'text' })}
          key={fields.username.key}
        />
        <div>{fields.username.errors}</div>
      </label>
      <label>
        <div>Password</div>
        <input
          className={!fields.password.valid ? 'error' : ''}
          {...getInputProps(fields.password, { type: 'password' })}
          key={fields.password.key}
        />
        <div>{fields.password.errors}</div>
      </label>
      <label>
        <div>Confirm Password</div>
        <input
          className={!fields.confirmPassword.valid ? 'error' : ''}
          {...getInputProps(fields.confirmPassword, { type: 'password' })}
          key={fields.confirmPassword.key}
        />
        <div>{fields.confirmPassword.errors}</div>
      </label>
      <hr />
      <Button>Signup</Button>
    </form>
  );
}

```



```nextjs14\src\components\actions.ts
'use server';

import { parseWithZod } from '@conform-to/zod';
import { redirect } from 'next/navigation';
import { loginSchema, todosSchema, createSignupSchema } from './schema';

export async function login(prevState: unknown, formData: FormData) {
  const submission = parseWithZod(formData, {
    schema: loginSchema
  });

  if (submission.status !== 'success') {
    return submission.reply();
  }

  redirect(`/?value=${JSON.stringify(submission.value)}`);
}

export async function createTodos(prevState: unknown, formData: FormData) {
  const submission = parseWithZod(formData, {
    schema: todosSchema
  });

  if (submission.status !== 'success') {
    return submission.reply();
  }

  redirect(`/?value=${JSON.stringify(submission.value)}`);
}

export async function signup(prevState: unknown, formData: FormData) {
  const submission = await parseWithZod(formData, {
    schema: (control) =>
      // create a zod schema base on the control
      createSignupSchema(control, {
        isUsernameUnique(username) {
          return new Promise((resolve) => {
            setTimeout(() => {
              resolve(username !== 'admin');
            }, Math.random() * 300);
          });
        }
      }),
    async: true
  });

  if (submission.status !== 'success') {
    return submission.reply();
  }

  redirect(`/?value=${JSON.stringify(submission.value)}`);
}

```



```nextjs14\src\components\schema.ts
import { conformZodMessage } from '@conform-to/zod';
import { z } from 'zod';

import type { Intent } from '@conform-to/react';

export const taskSchema = z.object({
  content: z.string(),
  completed: z.boolean().optional()
});

export const todosSchema = z.object({
  title: z.string(),
  tasks: z.array(taskSchema).nonempty()
});

export const loginSchema = z.object({
  email: z.string().email(),
  password: z.string(),
  remember: z.boolean().optional()
});

export function createSignupSchema(
  intent: Intent | null,
  options?: {
    // isUsernameUnique is only defined on the server
    isUsernameUnique: (username: string) => Promise<boolean>;
  }
) {
  return z
    .object({
      username: z
        .string({ required_error: 'Username is required' })
        .regex(
          /^[a-zA-Z0-9]+$/,
          'Invalid username: only letters or numbers are allowed'
        )
        // Pipe the schema so it runs only if the username is valid
        .pipe(
          z.string().superRefine((username, ctx) => {
            const isValidatingUsername =
              intent === null ||
              (intent.type === 'validate' &&
                intent.payload.name === 'username');

            if (!isValidatingUsername) {
              ctx.addIssue({
                code: 'custom',
                message: conformZodMessage.VALIDATION_SKIPPED
              });
              return;
            }

            if (typeof options?.isUsernameUnique !== 'function') {
              ctx.addIssue({
                code: 'custom',
                message: conformZodMessage.VALIDATION_UNDEFINED,
                fatal: true
              });
              return;
            }

            return options.isUsernameUnique(username).then((isUnique) => {
              if (!isUnique) {
                ctx.addIssue({
                  code: 'custom',
                  message: 'Username is already used'
                });
              }
            });
          })
        )
    })
    .and(
      z
        .object({
          password: z.string({ required_error: 'Password is required' }),
          confirmPassword: z.string({
            required_error: 'Confirm password is required'
          })
        })
        .refine((data) => data.password === data.confirmPassword, {
          message: 'Password does not match',
          path: ['confirmPassword']
        })
    );
}

```



## TailwindCSSã®è¨­å®š

```nextjs14\src\styles\globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;

```

â€»ä½™åˆ†ãªè£…é£¾ã‚’å‰Šé™¤

ãƒãƒ³ã‚ºã‚ªãƒ³ã¯ã“ã‚Œã§çµ‚äº†ã§ã™ã€‚

----------------------------------------

ã“ã®å…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã¯3ã¤ã®åŸºç¤çš„ãªä½¿ã„æ–¹ã§ã—ãŸã€‚



