<!--
title:   Next.js App router 認証機能付き 開発用テンプレート
tags:    Next.js,Supabase,メール認証
id:      12da291e560c4850b511
private: true
-->

# VNS





# 開発中の確認＆ダッシュボード

Next.js

http://localhost:3000

Storybook

http://localhost:6006/

ローカルの Supabase

http://localhost:54323/projects

サーバーの Supabase

https://app.supabase.com/projects

Vercel

https://vercel.com/dashboard

---

# 便利サイト、チートシート

Tailwind CSS Cheat Sheet

https://tailwindcomponents.com/cheatsheet/

---




# 開発時の重要コマンド

よく使うコマンドや便利ツール等

```
Supabase CLI 更新
scoop update supabase

Next.jsローカルサーバーを起動
npm run dev

storybookを起動
npm run storybook

supabase start
supabase stop
supabase db reset
supabase status

Supabase ダッシュボード
http://localhost:54323

ストーリーブック
npm run storybook

インタラクションテスト (storybookを起動させて)
npm run test-storybook

Vercel
npm vercel login
npm vercel link
npm vercel env pull

インストール時から一定期間後に別ブランチを立てて実行
update可能なパッケージ一覧を取得
npm outdated

npm update

インストール
npm install -g npm-check-updates
npm-check-updates

ncu

全て最新バージョンにアップデートしたい場合は
ncu -u



開発ブランチのマージ

git checkout main
git merge -
※ - 記号は直前にチェックアウトしたブランチを指定してマージします。

JSDocを利用した自動生成ドキュメント
npm run doc

eslintでのチェック ルールに従ってないファイルをリスト表示します。
npx eslint src/**/*


```




# 開発のサイクル

開発のサイクルとして、作業ブランチを作り、そこでコードを書いてテストして、その後にコミットしたら main ブランチに移動後マージします。(これを繰り繰り返します。)

作業ブランチの作成
git checkout -b <branch-name>

※作業します。

main ブランチに移動
git checkout main

ブランチのマージ
直前にいたブランチのマージ
git merge -

（不要になった）ブランチの削除
git branch -d <branch-name>

---

# ルール

書いたコードは src フォルダ以下に移動する
src/

共通の style コード
src/styles

ブランチは基本 2 種類
main ブランチ 公開用のコード
必要に応じて開発用のブランチを作成(ここで開発をする)
この２つを軸に開発していく
一区切りついたら開発用のブランチを main にマージしていく



---



### コロケーション

コロケーションとは、
関連するコードを近くに配置することで、
コードの理解性を向上させる設計パターンの一つです。
コロケーションパターンともいいます。

コロケーションパターンを採用することで
リマインド効果がある
半年前の自分は別人理論
コードを読みやすくする

一つのフォルダの中に一つのコンポーネント単位を置く
コンポーネントは複数のコンポーネントで成り立っておい
一つはデータコンポーネント
一つは表示コンポーネント
をつかう
テストファイルと
Story ファイルも一緒に
コンポーネントフォルダの root に置く

コロケーション | makotot.dev ファイルの配置

https://www.makotot.dev/posts/colocation-translation-ja

インタラクションテスト
ストーリーとテストを一元管理できる
ストーリーファイルにテストを記述する事になるため、
ストーリーとテストを一元管理できます。

テストを実行する方法は主に 2 つで、
通常はブラウザ上で Storybook を
表示して実行します。

テストランナーをセットアップすることで、
CLI での実行が可能になります。

# ディレクトリ構成

```tree
src
├── app
│   ├── layout.tsx
│   └── page.tsx
├── components
│   ├── ui
│   │   ├── alert-dialog.tsx
│   │   ├── button.tsx
│   │   ├── dropdown-menu.tsx
│   │   └── ...
│   ├── main-nav.tsx
│   ├── page-header.tsx
│   └── ...
├── lib
│   └── utils.ts
├── styles
│   └── globals.css
├── next.config.js
├── package.json
├── postcss.config.js
├── tailwind.config.js
└── tsconfig.json

```

参考
Next.js - shadcn/ui

https://ui.shadcn.com/docs/installation/next

---





---




# テンプレートで使用するツールの調査

Next.js をインストール

<details><summary>インストールする予定のツール (長い)</summary>

(未)＝未インストール＆インストール候補

※ 重要なのは必要になった時に調べてインストールする。
一気に全部入れても混乱するだけで使いこなせません。

Next.js by Vercel - The React Framework

https://nextjs.org/

TypeScript: JavaScript With Syntax For Types.

https://www.typescriptlang.org/

Tailwind CSS - Rapidly build modern websites without ever leaving your HTML.

https://tailwindcss.com/

Find and fix problems in your JavaScript code - ESLint - Pluggable JavaScript Linter

https://eslint.org/

Prettier · Opinionated Code Formatter

https://prettier.io/

The Open Source Firebase Alternative | Supabase

https://supabase.com/

Storybook: Frontend workshop for UI development

https://storybook.js.org/

GitHub Japan | GitHub

https://github.co.jp/

Vercel

https://vercel.com/

(未) tRPC - Move Fast and Break Nothing. End-to-end typesafe APIs made easy. | tRPC

https://trpc.io/

tRPC は App router 未対応です。

[tRPC App router 対応状況](https://github.com/trpc/trpc/issues/3297)

## テスト関連

(未) Vitest | A blazing fast unit test framework powered by Vite

https://vitest.dev/

サンプル
next.js/examples/with-vitest at canary · vercel/next.js · GitHub

https://github.com/vercel/next.js/tree/canary/examples/with-vitest

(未) Chromatic: Storybook deployment, review, and test

https://www.chromatic.com/

(未) Testing Library | Testing Library

https://testing-library.com/

(未) JavaScript Component Testing and E2E Testing Framework | Cypress

https://www.cypress.io/

(未) Fast and reliable end-to-end testing for modern web apps | Playwright

https://playwright.dev/

(未) Jest · 🃏 Delightful JavaScript Testing

https://jestjs.io/ja/

## i18n 国際化

(未) react-i18next

Introduction - react-i18next documentation

https://react.i18next.com/

サンプル
next.js/examples/app-dir-i18n-routing at canary · vercel/next.js · GitHub

https://github.com/vercel/next.js/tree/canary/examples/app-dir-i18n-routing

# 他のインストール候補

## UI ＆ CSS

### Next.js の app router に対応している UI コンポーネント集

shadcn/ui

https://ui.shadcn.com/

Next.js - shadcn/ui

https://ui.shadcn.com/docs/installation/next

React の UI コンポーネントなら@shadcn/ui がちょうどいい

https://zenn.dev/mottox2/articles/react-shadcn-ui

(未) Kuma UI

https://www.kuma-ui.com/

(未) Mantine next example

https://v7.mantine.dev/

Can I use Mantine with Next.js app dir?
Currently, it is not recommended, we are working on new major version that will resolve all of the current issues related to server side rendering.

> Mantine を Next.js app dir で使用できますか？
> サーバーサイドレンダリングに関する現在の問題をすべて解決する新しいメジャーバージョンを開発中です。

この version7 が開発中です。

### Next.js の app router に対応している CSS

(未) vanilla-extract — Zero-runtime Stylesheets-in-TypeScript.

https://vanilla-extract.style/

CSS・TypeScript の相性が抜群。vanilla-extract が最高の CSS 開発体験をくれた

https://zenn.dev/moneyforward/articles/vanilla-extract

## デザイン

Figma

https://www.figma.com/

## 開発時の利用ツール

### DB関連

#### SQLクライアント

DBeaver Community

https://dbeaver.io/download/

TablePlus | Modern, Native Tool for Database Management

https://tableplus.com/download

A5:SQL Mk-2 - フリーの SQL クライアント/ER 図作成ソフト (松原正和)

https://a5m2.mmatsubara.com/

# その他

(未) Zod | Documentation

https://zod.dev/

(未) Prisma | Next-generation ORM for Node.js & TypeScript

https://www.prisma.io/

</details>


























# テンプレートを使用する方法

このリポジトリ↓がテンプレートとして利用できます。

masakinihirota/vns


https://github.com/masakinihirota/vns
https://github.com/masakinihirota/vns

「Use this template」
緑ボタンを押します。

新しいリポジトリが出来るのでそこから開発を始めます。



# この記事の趣旨

このリポジトリは既存のツールを組み合わせているだけなので何の機能もありません。
だからサンプルやデモではなくテンプレートです。

ただ、現在、複数の機能をまとめるだけでも微妙な設定変更が必要で、それには多くの調査が必要になるためここにテンプレートとして記録に残しておきます。

この記事ではNext.js の↓公式サンプルを利用したテンプレートを作成します。

next.js/examples/with-supabase at canary · vercel/next.js

https://github.com/vercel/next.js/tree/canary/examples/with-supabase



またこのリポジトリは
Supabaseで推奨↓されている方法です。

Supabase Auth with the Next.js App Router | Supabase Docs

https://supabase.com/docs/guides/auth/auth-helpers/nextjs

```
Automatic Configuration (recommended)#

npx create-next-app -e with-supabase

```

と書かれています。




# 前提条件

Supabaseのアカウントは作成して、
プロジェクトを作ってあるものとします。

開発環境や技術選定にあるツールはある程度知っているものとします。



# 開発環境

Windows 10
PowerShell
VSCode with GitHub Copilot chat
Next.js 13 app dir
Supabase
Storybook
shadcn/ui
Vercel
i18n
JSDoc



# 技術選定

Next.js
Supabase
メール認証（cookie）
GitHub認証
shadcn/ui
Storybook
ダークモード
i18n



# 追加予定

GitHub認証
Supabase
shadcn/ui
i18n
JSDoc
Storybook
Vercel


----------------------------------------
----------------------------------------
----------------------------------------

ハンズオン インストール

# Next.jsを認証付きのサンプルをインストール

テンプレートを作ります。

Next.js公式サンプルをインストールします。

npx create-next-app -e with-supabase



# NextUIをインストール

Next.js | NextUI - Beautiful, fast and modern React UI Library

https://nextui.org/docs/frameworks/nextjs

npm i @nextui-org/react framer-motion

npm i -D @types/tailwindcss

```tailwind.config.js
import {nextui} from "@nextui-org/react";

/** @type {import('tailwindcss').Config} */
const config = {
  content: [
    // ...
    "./node_modules/@nextui-org/theme/dist/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {},
  },
  darkMode: "class",
  plugins: [nextui()]
}

export default config;

```


```app\globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;

```


```app\page.tsx
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs"
import { cookies } from "next/headers"
import Link from "next/link"
import LogoutButton from "../components/LogoutButton"

export default async function Index() {
  const supabase = createServerComponentClient({ cookies })

  const {
    data: { user },
  } = await supabase.auth.getUser()

  return (
    <div className="flex flex-col items-center w-full">
      <nav className="flex justify-center w-full h-16 border-b border-b-foreground/10">
        <div className="flex items-center justify-between w-full max-w-4xl p-3 text-sm text-foreground">
          <div />
          <div>
            {user ? (
              <div className="flex items-center gap-4">
                Hey, {user.email}!
                <LogoutButton />
              </div>
            ) : (
              <Link
                href="/login"
                className="px-4 py-2 no-underline rounded-md bg-btn-background hover:bg-btn-background-hover"
              >
                Login
              </Link>
            )}
          </div>
        </div>
      </nav>
      <h1 className="text-3xl font-bold underline">Hello world!</h1>
    </div>
  )
}

```



動作確認
npm run dev

Hello world!の文字にTailwindCSSのプロパティが有効だったら成功です。




インストールの続き

touch app/providers.tsx

```app/providers.tsx
'use client'

import {NextUIProvider} from '@nextui-org/react'

export function Providers({children}: { children: React.ReactNode }) {
  return (
    <NextUIProvider>
      {children}
    </NextUIProvider>
  )
}

```

これはクライアントコンポーネントです。

ダークモードを設定する場合トップページのLayoutに設定をするのですが
でもそこのLayoutで設定をするとツリーの頂点から
クライアントコンポーネントになってしまいます。
そんなときはこのようなテクニックで
NextUIのラップ部分だけを切り出してクライアントコンポーネントにして
あとはサーバーコンポーネントに戻しています。







次に、ルートレイアウトページに移動し、それをNextUIProviderでラップします：

```app/layout.tsx
import "@/styles/globals.css"

import { Providers } from "./providers"

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="jp" className="dark">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}


```



```app\page.tsx
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs"
import { cookies } from "next/headers"
import Link from "next/link"
import LogoutButton from "../components/LogoutButton"

export default async function Index() {
  const supabase = createServerComponentClient({ cookies })

  const {
    data: { user },
  } = await supabase.auth.getUser()

  return (
    <div className="flex flex-col items-center w-full min-h-screen bg-background">
      <nav className="flex justify-center w-full h-16 border-b border-b-foreground/10">
        <div className="flex items-center justify-between w-full max-w-4xl p-3 text-sm text-foreground">
          <div />
          <div>
            {user ? (
              <div className="flex items-center gap-4">
                Hey, {user.email}!
                <LogoutButton />
              </div>
            ) : (
              <Link
                href="/login"
                className="px-4 py-2 no-underline rounded-md bg-btn-background hover:bg-btn-background-hover"
              >
                Login
              </Link>
            )}
          </div>
        </div>
      </nav>
      <h1 className="text-3xl font-bold underline">Hello world!</h1>
    </div>
  )
}

```

※NextUIは自動的にlightとdarkの2つのテーマをアプリケーションに追加します。

ダークテーマを使用するには、
dark/lightクラスを追加することで、どちらのテーマも使用できます。

html
body
main
要素のclassNameに追加するだけです。


<html lang='en' className='light'>



詳しくはテーマのドキュメントをご覧ください。

Customize theme | NextUI - Beautiful, fast and modern React UI Library

https://nextui.org/docs/customization/customize-theme



NextUIコンポーネントを使う
"use client"ディレクティブを使わなくても、
NextUIコンポーネントを直接サーバーコンポーネントにインポートできるようになりました

※↑重要


```app/page.tsx
import {Button} from '@nextui-org/button';

...

    <div>
      <Button>Click me</Button>
    </div>

```

動作確認

npm run dev

ボタンが押せるようになっていて、TailwindCSSも効いています。


これでトップページでもクライアントコンポーネント("use client")にせずに、
使用できるようになりました。


----------------------------------------
----------------------------------------

参考

【Next.js】NextUI の導入方法
https://zenn.dev/nelf03/articles/d6d8ec97904470

AuthenticationのAuthUIコンポーネントを作ってみる

mkdir src/app/authui
touch src/app/authui/page.tsx


```page.tsx
import { Card, CardHeader, CardBody, CardFooter } from '@nextui-org/card';
import { Divider } from '@nextui-org/divider';
import { Input } from '@nextui-org/input';
import { Button } from '@nextui-org/button';

export default function Home() {
  return (
    <main className='p-20'>
      <Card className='max-w-sm mx-auto'>
        <CardHeader className='flex items-center justify-center'>
          <div className='text-lg font-medium'>Sign up</div>
        </CardHeader>
        <Divider />
        <CardBody>
          <div className='flex flex-col gap-3'>
            <Input type='text' label='Name' size='sm' />
            <Input type='email' label='Email' size='sm' />
            <Input type='password' label='Password' size='sm' />
          </div>
        </CardBody>
        <CardFooter>
          <Button className='w-full' color='primary'>
            Sign Up
          </Button>
        </CardFooter>
      </Card>
    </main>
  );
}

```

----------------------------------------
----------------------------------------

# 動的にテーマを切り替える

※テーマを固定した時のソースコードは不要になります。

light/dark

npm i next-themes

Heroiconsを導入
npm install @heroicons/react

touch src/components/ThemeSwitcher.tsx


```src\app\layout.tsx
import "@/styles/globals.css";

import React from "react";

import { Providers } from "./providers";

/**
 * The root layout component that wraps the `Providers` component and returns an `html` element.
 *
 * @param {Object} props The props object.
 * @param {React.ReactNode} props.children The content to display inside the `Providers` component.
 * @return {JSX.Element} The rendered `html` element.
 */
export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="jp">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}

```



```src\app\providers.tsx
"use client";

import { NextUIProvider } from "@nextui-org/react";
import { ThemeProvider as NextThemesProvider } from "next-themes";
import React from "react";

/**
 * The component that wraps the `NextUIProvider` component and provides global app context.
 *
 * @param {Object} props The props object.
 * @param {React.ReactNode} props.children The content to display inside the `NextUIProvider` component.
 * @return {JSX.Element} The rendered `NextUIProvider` component.
 */
export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <NextUIProvider>
      <NextThemesProvider attribute="class" defaultTheme="dark">
        {children}
      </NextThemesProvider>
    </NextUIProvider>
  );
}

```


```src\components\ThemeSwitcher.tsx
"use client";

import { MoonIcon } from "@heroicons/react/24/outline";
import { SunIcon } from "@heroicons/react/24/solid";
import { Switch } from "@nextui-org/switch";
import { useTheme } from "next-themes";
import { useEffect, useState } from "react";

/**
 * The component that renders a theme switcher.
 *
 * @return {JSX.Element} The rendered `ThemeSwitcher` component.
 */
export function ThemeSwitcher() {
  const [mounted, setMounted] = useState(false);
  // eslint-disable-next-line no-unused-vars
  const { theme, setTheme } = useTheme();

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return null;

  return (
    <div>
      <Switch
        defaultSelected
        size="lg"
        color="primary"
        startContent={<SunIcon />}
        endContent={<MoonIcon />}
        onValueChange={(isSelected) => setTheme(isSelected ? "light" : "dark")}
      />
    </div>
  );
}

```



```src\app\page.tsx
import { Button } from "@nextui-org/button";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import Link from "next/link";

import { ThemeSwitcher } from "@/components/ThemeSwitcher";

import LogoutButton from "../components/LogoutButton";

/**
 * The index page component that displays the user's information and a logout button.
 *
 * @return {JSX.Element} The rendered index page component.
 */
export default async function Index() {
  const supabase = createServerComponentClient({ cookies });

  const {
    data: { user },
  } = await supabase.auth.getUser();

  return (
    <div className="flex flex-col items-center w-full min-h-screen bg-background">
      <nav className="flex justify-center w-full h-16 border-b border-b-foreground/10">
        <div className="flex items-center justify-between w-full max-w-4xl p-3 text-sm text-foreground">
          <div />
          <div>
            {user ? (
              <div className="flex items-center gap-4">
                Hey, {user.email}!
                <LogoutButton />
              </div>
            ) : (
              <Link
                href="/login"
                className="px-4 py-2 no-underline rounded-md bg-btn-background hover:bg-btn-background-hover"
              >
                Login
              </Link>
            )}
          </div>
        </div>
      </nav>
      {/* 認証に関係のないエリア
      Buttonコンポーネントなどお試し用のエリア */}
      <h1 className="text-3xl font-bold underline">VNS.BLUE</h1>
      <Link href="/authui">authui</Link>

      <Button>Click me</Button>
      <ThemeSwitcher />
    </div>
  );
}

```


これで太陽と月のアイコンが表示されているはずです。
アイコンをクリックするとライトモードとダークモードが切り替わります。

これで動的なモード切り替えボタンの設定は終了です。

# 参考

NextUI - Beautiful, fast and modern React UI Library

https://nextui.org/

pacocoursey/next-themes: Perfect Next.js dark mode in 2 lines of code. Support System preference and any other theme with no flashing

https://github.com/pacocoursey/next-themes

【Next.js】NextUI でダークモードに対応する方法

https://zenn.dev/nelf03/articles/b4e5eef6a3b99a



----------------------------------------



# 環境ファイルを作る

Vercelにデプロイしてから連携してあるので
.envは不要

※Supabaseでプロジェクトを作成済みで、
プロジェクトの設定情報は知っているものとします。

touch .env.local

```.env.local
NEXT_PUBLIC_SUPABASE_URL=https://zhlmcrnnjbsfhbnctenz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ey***********************************74

```

.env.local.example
は削除します。





# srcフォルダの作成 ディレクトリの移動

mkdir src

srcの下にappディレクトリとcomponentsディレクトリを移動します。


tsconfig.jsonファイルを一部変更

```tsconfig.json
    "paths": {
      "@/*": ["./src/*"]
    }

```




tailwind.config.jsファイルを一部変更

```tailwind.config.js
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",

```

※src/pages はNext.jsのpages dirを使っていたときの名残です。
Next.js 13 は pages dir と app dir の両方を同時に使えるので残しておきます。


動作確認

npm run dev



# 微調整

mkdir src/styles

src\styles\globals.css
へ移動します。


パスの修正をします。

```src\app\layout.tsx
import "@/styles/globals.css"

```


動作確認

npm run dev




package.jsonファイルを一部変更

```package.json
  "name": "vns.blue",
  "version": "0.1.0",

```

※名前は自由につけてください。





# eslintのインストール

npm i eslint eslint-config-next


touch .eslintrc.json

.eslintrc.json(初期)

```.eslintrc.json
{
  "extends": "next/core-web-vitals"
}

```



## tsconfig.json

TypeScriptを開発しやすくする

```tsconfig.json (変更箇所)
    "strict": false,
    "strictNullChecks": true,

```

"strict": false は、以下の設定を無効にします。

"noImplicitAny": true：暗黙的にany型として解釈される式を許可しません。
"strictNullChecks": true：nullとundefinedの扱いに関する厳密な型チェックを有効にします。
"strictFunctionTypes": true：関数の型チェックを厳密に行います。
"strictPropertyInitialization": true：クラスのプロパティの初期化を厳密に行います。
"noImplicitThis": true：thisの型チェックを厳密に行います。

↑この５つのうち

"strictNullChecks"だけ有効にします。


----------------------------------------







# VSCode の設定

VSCode の拡張機能を入れます。

ESLint - Visual Studio Marketplace

https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint

Prettier - Code formatter - Visual Studio Marketplace

https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode

Headwind - Visual Studio Marketplace

https://marketplace.visualstudio.com/items?itemName=heybourn.headwind

※拡張機能 Headwind はTailwindCSSの className を全て同じように並べ替えます。

【自動整形】VSCode で Prettier を使う方法【設定必要です】 | RalaCode

https://ralacode.com/blog/post/vscode-prettier/

```setting.json (追記)
  // フォーマットをprettierで実行
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  // 貼り付け時にフォーマット
  "editor.formatOnPaste": false,
  // 入力直後にフォーマット
  "editor.formatOnType": false,
  // 保存直後にフォーマット
  "editor.formatOnSave": true,

  "editor.codeActionsOnSave": {
    // import文を自動で探して挿入する。
    "source.addMissingImports": true,
    // 保存時にeslintを実行
    "source.fixAll.eslint": true
  },

```

※設定をする事で言語別に(TypeScript, markdown, html等)フォーマットの設定ができます。

VSCodeのフォーマット

Default FormatterをPrettierにする設定。

```setting.json
"editor.defaultFormatter": "esbenp.prettier-vscode"

```








### .eslintignore ファイルの作成

.eslintignore を作成します。

touch .eslintignore

↓lint 対象から外したいファイルを設定します。

```.eslintignore
# config
.eslintrc.json
.prettierrc
next.config.js
tailwind.config.js
tsconfig.json
postcss.config.js

# build dir
build/
bin/
obj/
out/
.next/

# 自動生成されたファイル
package-lock.json

# Storybook
*.stories.ts
*.stories.tsx

# CSSファイル
*.css

# mdxファイル
*.mdx

# すべての画像ファイルを除外する
**/*.png
**/*.jpg
**/*.jpeg
**/*.gif
**/*.ico

```








----------------------------------------


# prettier

公式サイト Install Prettier

https://prettier.io/docs/en/install.html

prettier のインストール

npm install -D prettier

eslint と設定が衝突するのを避けるための設定

npm install -D eslint-config-prettier

空の.prettierrc を作成して、Prettier を使用していることをエディターやその他のツールに知らせます。

touch .prettierrc

```.prettierrc

```

Prettier を VSCode で使うにはデフォルトのフォーマッターを Prettier に設定する必要があります。

.eslintrc.json に prettier 設定の追加をします。

```.eslintrc.json
{
  "extends": [
    "next/core-web-vitals",
    "prettier"
  ]
}

```

package.json に format コマンドを追加します。

```package.json (追記)
"scripts": {
  "format": "prettier --write ."
  ...

```

## .prettierrc 設定ファイルの追加

.prettierrc ファイルを設定します。

```.prettierrc
{
  "tabWidth": 2,
  "useTabs": false
}

```

※ルールは各自で好きなように設定してください。

↓ このプラグインは推奨されなくなりました。
eslint-plugin-prettier

次に、.prettierignore ファイルを作成して、
どのファイルをフォーマットしないかを Prettier CLI とエディターに知らせます。

touch .prettierignore

```.prettierignore
# Ignore artifacts:
node_modules
build
coverage

# dotfile
.env*

# markdown
*.md

# next.js
/.next/
/out/

# production
/build

package-lock.json

*.stories.ts
*.stories.tsx

.next
.plop
.editorconfig
.gitignore
.eslintignore
.prettierignore
*-lock.yaml
*.log*

```



## Prettier コマンド一覧

※通常は VSCode 側を設定すれば、保存時に自動で実行されるので、コマンドを打つことはほとんどありません。

動作確認のため prettier を実行します。

全体をフォーマットします。
npx prettier . --write

src ディレクトリ以下をフォーマットします。
npx prettier src/ --write

巨大プロジェクトの場合に時間短縮のためフォルダを指定したい場合
npx prettier [フォルダ名] --write

直接ファイルを指定する場合
npx prettier src\app\page.tsx --write

prettier が実行済みかの確認（上書きはしない）
npx prettier . --check



# eslint-plugin-import

Next.js 開発 ESLint で import 文の自動挿入、自動削除、自動ソート - Qiita

https://qiita.com/masakinihirota/items/fae505a58892b00550a7

npm install -D eslint-plugin-unused-imports --legacy-peer-deps


```.eslintrc.json
{
  "extends": ["next/core-web-vitals", "prettier"],
  "plugins": ["unused-imports"],
  "rules": {
    "unused-imports/no-unused-imports": "error"
  }
}

```

※ ↑この設定は必要な最小限の設定にしてあるので、自動挿入、自動削除の確認用として有効です。





さらに、並べ替えのルールを追加します。

```.eslintrc.json
{
  "extends": ["next/core-web-vitals", "prettier"],
  "plugins": ["unused-imports"],
  "rules": {
    // TypeScriptで未使用の変数を許可するかどうかを指定します。この例では、offに設定されているため、未使用の変数を許可します。
    "@typescript-eslint/no-unused-vars": "off",
    // 未使用のインポートに関するルールを指定します。この例では、warnに設定されているため、未使用のインポートがある場合に警告を出します。
    "unused-imports/no-unused-imports": "warn",
    // モジュールのインポート順序に関するルールを指定します。この例では、配列の中に複数のグループが定義されています。各グループは、groupsプロパティで定義されています。
    "import/order": [
      "warn",
      {
        "groups": [
          // builtin: Node.js に組み込まれているモジュール
          // external: npm install 等 プロジェクト外部からインストールされたモジュール
          // internal: プロジェクト内のモジュールで、パスを指定してインポートされたもの
          // parent: 親モジュール 相対パスを使用してインポートされたもの
          // sibling: 兄弟モジュール 相対パスを使用してインポートされたもの
          // index: インデックスファイルで、相対パスを使用してインポートされたもの
          // object: オブジェクトファイルで、相対パスを使用してインポートされたもの
          // type: 型ファイルで、相対パスを使用してインポートされたもの
          "builtin",
          "external",
          "internal",
          ["parent", "sibling"],
          "index",
          "object",
          "type"
        ],
        // それぞれのgroupsとの間は1行分空けます。
        "newlines-between": "always",
        // 特定のグループの import 文を除外するかどうかを指定します。
        "pathGroupsExcludedImportTypes": ["builtin", "external"],
        // order オプションは、アルファベット順にします。
        // caseInsensitive オプションは、大文字小文字を無視してアルファベット順に並べるかどうかを指定します。
        "alphabetize": { "order": "asc", "caseInsensitive": true },
        "pathGroups": [
          // pattern: インポートパスのパターンを指定します。この例では、src/ディレクトリ以下のすべてのファイルを指定しています。
          // group: インポートパスが一致した場合に、どのグループに属するかを指定します。この例では、internalグループに属するように指定しています。
          // position: インポートパスが一致した場合に、どの位置に挿入するかを指定します。この例では、beforeに指定しているため、他のグループよりも前に挿入されます。
          {
            "pattern": "src/**",
            "group": "internal",
            "position": "before"
          }
        ]
      }
    ]
  }
}

```















## ESlintにTypeScriptのルールを追加

typescript-eslint

https://typescript-eslint.io/

npm install --save-dev @typescript-eslint/parser

※↑上記サイトの他のプラグインを使用すると、ESLintの他の機能が正常に動作しなくなるため、そのプラグインは外しました。

```.eslintrc.json
{
  "extends": ["eslint:recommended", "next/core-web-vitals", "prettier"],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    // tsx ファイル内のJSX構文を正しく解析できるようになります。
    "ecmaFeatures": {
      "jsx": true
    },
    "ecmaVersion": 2020,
    "sourceType": "module",
    "jsx": "react"
  },
  // react: Reactの構文を解析するためのルールを提供します。
  // import: import文の構文を解析するためのルールを提供します。
  // unused-imports: 未使用のimport文を検出するためのルールを提供します。
  "plugins": ["react", "import", "unused-imports"],
  "root": true,
  "rules": {
    // TypeScriptで未使用の変数を許可するかどうかを指定します。この例では、offに設定されているため、未使用の変数を許可します。
    "@typescript-eslint/no-unused-vars": "off",
    // 未使用のインポートに関するルールを指定します。この例では、warnに設定されているため、未使用のインポートがある場合に警告を出します。
    "unused-imports/no-unused-imports": "warn",
    // モジュールのインポート順序に関するルールを指定します。この例では、配列の中に複数のグループが定義されています。各グループは、groupsプロパティで定義されています。
    "import/order": [
      // エラーだと動作が止まります。
      // 警告だと警告表示はされますが動作は止まりません。
      "warn",
      {
        "groups": [
          // builtin: Node.js に組み込まれているモジュール
          // external: npm install 等 プロジェクト外部からインストールされたモジュール
          // internal: プロジェクト内のモジュールで、パスを指定してインポートされたもの
          // parent: 親モジュール 相対パスを使用してインポートされたもの
          // sibling: 兄弟モジュール 相対パスを使用してインポートされたもの
          // index: インデックスファイルで、相対パスを使用してインポートされたもの
          // object: オブジェクトファイルで、相対パスを使用してインポートされたもの
          // type: 型ファイルで、相対パスを使用してインポートされたもの
          "builtin",
          "external",
          "internal",
          ["parent", "sibling"],
          "index",
          "object",
          "type"
        ],
        // それぞれのgroupsとの間は1行分空けます。
        "newlines-between": "always",
        // 特定のグループの import 文を除外するかどうかを指定します。
        "pathGroupsExcludedImportTypes": ["builtin", "external"],
        // order オプションは、アルファベット順にします。
        // caseInsensitive オプションは、大文字小文字を無視してアルファベット順に並べるかどうかを指定します。
        "alphabetize": { "order": "asc", "caseInsensitive": true },
        "pathGroups": [
          // pattern: インポートパスのパターンを指定します。この例では、src/ディレクトリ以下のすべてのファイルを指定しています。
          // group: インポートパスが一致した場合に、どのグループに属するかを指定します。この例では、internalグループに属するように指定しています。
          // position: インポートパスが一致した場合に、どの位置に挿入するかを指定します。この例では、beforeに指定しているため、他のグループよりも前に挿入されます。
          {
            "pattern": "src/**",
            "group": "internal",
            "position": "before"
          }
        ]
      }
    ]
  }
}

```

import文の自動削除や自動挿入は保存ボタンを押すと実行されます。（VSCode 側で Prettier が自動実行の設定がされている場合）

(1度で動かない時は 保存ボタンを2,3回押してみてください。)

JavaScript と TypeScript のそれぞれの lint 設定

各個人それぞれが必要になったらインストールしてください。

Getting Started | typescript-eslint

https://typescript-eslint.io/getting-started/

Linting with Type Information | typescript-eslint

https://typescript-eslint.io/linting/typed-linting/

Configurations | typescript-eslint

https://typescript-eslint.io/linting/configs/












## ESlintでのチェックを実行する

### *.tsxファイルのみをチェックする場合

npx eslint src/**/*.tsx

### 全ファイルをチェックする場合

npx eslint src/**/*

※チェックをしないファイルタイプは .eslintignore に登録します。


↑上記コマンドを実行してエラーや警告を消します。





----------------------------------------





# JSDoc

ESLint を使って JSDoc / TSDoc の記述を必須にします。

https://zenn.dev/wakamsha/articles/setup-eslint-plugin-jsdoc

TypeDocでもNext.js製サイトのドキュメントが書きたい - NIFTY engineering

https://engineering.nifty.co.jp/blog/16643

>コンポーネントはStoryBook、コンポーネント以外はTypeDocに記述するようにして書き分ける

JSDocでは出力からStorybookを除外するように設定をします。



## JSDocのインストール

今回はグローバルインストールします。

npm install -g jsdoc

※各自の環境に合わせて好きな方法でインストールしてください。


### ESLintのgoogleルールをインストール

npm install --save-dev eslint-config-google



## ESLintにJSDocを強制する場合の設定

.eslintrc.jsonに追記します。

"google"
↑このルールは、JSDocを強制的に使用するよう促します。

※JSDocが書いてないとエラーが出ます。

```.eslintrc.json

  "env": {
    "es6": true
  },
  "extends": [
    "eslint:recommended",
    "next/core-web-vitals",
    "google",       <<<<追加
    "prettier"
  ],
  "parser
・・・

```

eslint-config-google - npm

https://www.npmjs.com/package/eslint-config-google

※Google スタイルを ESLint の推奨ルール セットと組み合わせて使用​​するには、両方を拡張し、必ずgoogle最後にリストします。

eslint-config-* の比較表

https://zenn.dev/tapioca/articles/5685d794f6452b

Rules Reference - ESLint - Pluggable JavaScript Linter

https://eslint.org/docs/latest/rules/





コードのチェック
npx eslint src/**/*

今回、ESLintのgoogle規則を追加したのでJSDocが書かれてない関数が表示されるはずです。


それぞれ各関数に↓下を参照してJSDocを書いてください



## VSCodeでJSDocを書く方法

関数がある上の行にカーソルを持ってきて


### 自分で直接書く方法

/** ＋エンターキー
でJSDocの↓テンプレートが自動挿入されます。

```
/**
 *
 * @param inputs
 * @returns
 */
 export default function

```



### 提案して貰う方法

関数のすぐ上の部分にカーソルを持ってきて、
AI (GitHub Copilot chat)のトリガーキーを押すと、
提案が表示されます。

提案が表示されない場合は、↓直接 AI(GitHub Copilot chat)に聞きます。



### AI(GitHub Copilot chat)に直接聞く方法

関数を指定して（関数部分を選択したり、マウスカーソルをその上においたりします）
「JSDocを書いてください」
とお願いする方法。



コンポーネントの場合は@moduleをつけます。

例 JSDocのコメント

```src\app\ModeTogglePage\page.tsx
/**
 * テーマを切り替えるためのドロップダウンメニューを表示するコンポーネント。
 * @module ModeToggle
 * @return {JSX.Element} テーマを切り替えるためのドロップダウンメニューを含む React 要素。
 */
export default function ModeToggle() {
  const { setTheme } = useTheme();


```

※リファクタリングした後でも、AIに修正を依頼すると更新されたJSDocを提案してくれます。




### JSDocの使用例

↓なにか関数を作ります。

```
function increment(num: number): number {
  return num + 1;
}
```

↓関数の上の行にカーソルを持ってきて
`/** ＋エンターキー`
で JSDoc の↓テンプレートが自動挿入されます。

```
/**
 *
 * @param num
 * @returns
 */
function increment(num: number): number {
  return num + 1;
}

```

このままではエラーが出るので GitHub Copilot chat に↓修正をしてもらいます。

```
/**
 *
 * @param {number} num - 数値。
 * @return {number} 引数に1を加えた数値。
 */
function increment(num: number): number {
  return num + 1;
}
```

↓ 説明を追加します。
説明も GitHub Copilot chat で提案してもらいます。

```
/**
 * 引数に1を加えた数値を返す関数。
 * @param {number} num - 数値。
 * @return {number} 引数に1を加えた数値。
 */
function increment(num: number): number {
  return num + 1;
}

```

完成です。



----------------------------------------

## JSDocからドキュメントを自動作成する。

typedoc
TypeScript用 JSDocドキュメント生成ツール

Overview | TypeDoc

https://typedoc.org/guides/overview/



typedoc - npm

https://www.npmjs.com/package/typedoc





### インストール

npm -D install typedoc

typedoc --options <filename>

touch typedoc.json

```typedoc.json
{
  "entryPoints": ["src"],
  "entryPointStrategy": "expand",
  "out": "doc_jsdoc",
  "exclude": ["src/stories/**/*", "src/**/*.stories.ts"]
}

```



↓scriptsを追加します。

```package.json
  "scripts": {
    "doc": "typedoc",
・・・

```

※実行時にtypedoc.jsonを指定しなくてもデフォルトで読み込んでくれます。
※↑JSDocインストール項目の最初で説明したようにStorybookは除外します。

テストファイルも不要ならば除外します。





### 実行

npm run doc

↑実行するとdocsフォルダが作成されます。

ブラウザで
doc_jsdoc\index.html
を開くとドキュメントが表示されます。



# JSDocのリファレンス

TypeScript: Documentation - JSDocリファレンス

https://www.typescriptlang.org/ja/docs/handbook/jsdoc-supported-types.html

@type
@param (or @arg or @argument)
@return
@typedef
@callback
@template
@class (or @constructor)
@this
@extends (or @augments)
@enum

Use JSDoc: Index

https://jsdoc.app/





----------------------------------------

i18n


(an i18next guide)



これはvns-darkリポジトリの記事
これをvnsに移行する

















----------------------------------------












