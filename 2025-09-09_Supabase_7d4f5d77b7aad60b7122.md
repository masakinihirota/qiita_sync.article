<!--
title:   ９月までに Supabase 非同期型認証 Signing Keys (getUsersからgetClaimsに)
tags:    Supabase
id:      7d4f5d77b7aad60b7122
private: true
-->
JWT Signing Keys は公開鍵暗号方式です。鍵(key)の名前も公開鍵暗号方式に沿って変更されます。

公開鍵と秘密鍵は別のものなので非対称キーと説明されています。
逆に同じ鍵(対称キー)を使っているのが秘密鍵方式です。この秘密鍵方式は相手にも鍵を渡す必要があるのでネットワーク上での利用はセキュリティリスクが高くなります。

ぶっちゃけ
既存のアプリでは
`getUsers()` 部分を `getClaims()` に変えるだけで移行は完了です、ただし性能は従来通りのままです。

本来の性能を引き出すためには、非対称のJWTキーを生成して設定することで発揮する二段構えになっています。

現在のAPIキーは2025年9月末で使用できなくなります。

>Legacy API keys will be deleted and removed from the Docs / Dashboard.
You have to migrate to use the new API keys by this point or your app will break.



# 前提知識

Supabaseではキーの名前が変わります。(現在、過渡期で期限は2025年9月)

anon key (匿名キー)
から
publishable key (公開鍵)

service_role Key (サービスの役割キー)
から
secret key (秘密鍵)



と公開鍵暗号方式の従来の名前に沿った名前に変更されます。

つまり、JWT Signing Keys (JWT署名キー)は秘密鍵に相当します。

対称型のキーから非対称型のキーへ

秘密鍵暗号方式から公開鍵暗号方式へ
秘密鍵は1つだけで誰にも公開してはいけません、自分も相手も同じ鍵を使います、つまり対称の鍵です。
公開鍵暗号方式は公開鍵と秘密鍵を2つ作ります。相手は公開鍵を使い、自分は秘密鍵を使います、つまり非対称の鍵です。

## 公開鍵暗号方式の解説
公開鍵暗号方式は、秘密鍵暗号方式が抱える **「鍵配送問題」** を解決するために生まれました。秘密鍵暗号方式（対称型）では、通信する両者が同じ鍵を共有する必要があり、その鍵を安全に相手に渡すことが大きな課題でした。一方、公開鍵暗号方式（非対称型）では、公開鍵と秘密鍵のペアを用いることで、この問題を根本的に解決します。

## 公開鍵暗号方式への移行

非対称型キーは、公開鍵と秘密鍵という2つの異なる鍵を使用します。

公開鍵: 誰にでも公開できる鍵で、データの暗号化や署名の検証に使われます。
秘密鍵: 鍵の所有者だけが持つ鍵で、データの復号や署名に使われます。

アリスがボブにメッセージを送る場合、アリスはボブの公開鍵を使ってメッセージを暗号化します。この暗号化されたメッセージは、ボブが持つ秘密鍵でしか復号できません。これにより、鍵を事前に安全に共有する必要がなくなります。

Supabaseのキー名称変更は、この公開鍵暗号方式の考え方に沿ったものです。
anon key（匿名キー）は、ユーザー認証などのためにクライアントサイドで公開されるため、publishable key（公開キー）というより適切な名前に変更されました。
一方、サーバーサイドでの認証や署名に使われるJWT Signing Keysは、決して公開してはならないため、秘密鍵に相当します。









# 本編

Signing Keys
https://supabase.com/blog/jwt-signing-keys

👇️ローカルのデータを確認

```terminal
supabase status

Stopped services: [supabase_imgproxy_vns-masakinihirota supabase_edge_runtime_vns-masakinihirota supabase_analytics_vns-masakinihirota supabase_vector_vns-masakinihirota]
supabase local development setup is running.

         API URL: http://127.0.0.1:54321
     GraphQL URL: http://127.0.0.1:54321/graphql/v1
  S3 Storage URL: http://127.0.0.1:54321/storage/v1/s3
          DB URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres
      Studio URL: http://127.0.0.1:54323
    Inbucket URL: http://127.0.0.1:54324
      JWT secret: super-secret-jwt-token-with-at-least-32-characters-long  ＜＜ココ
        anon key: eyJh*****
service_role key: eyJh*****
   S3 Access Key: 6257*****
   S3 Secret Key: 8501*****
       S3 Region: local

```

👆️JWT secretの値は
JWT secret: super-secret-jwt-token-with-at-least-32-characters-long
となっています。
このままでは使えません、JWT secretの値は自分で作成します。

※これは公開鍵方式の秘密鍵にあたるので、使用するのでしたら公開してはいけません。

👇️JWT secretの作成方法

```terminal
supabase gen -h

Run code generation tools

Usage:
  supabase gen [command]

Available Commands:
  keys        Generate keys for preview branch
  signing-key Generate a JWT signing key  ＜＜コレ
  types       Generate types from Postgres schema

```

👇️実際の生成

```terminal
supabase gen signing-key

#アルゴリズムの指定も可能
supabase gen signing-key --algorithm ES256

```



```
Flags
ES256 - ECDSA with P-256 curve and SHA-256 (recommended)
RS256 - RSA with SHA-256

--algorithm <[ RS256 | ES256 ]>
Optional
Algorithm for signing key generation.

--append
Optional
Append new key to existing keys file instead of overwriting.

```

• NIST P-256曲線 (非対称) ES256: 楕円曲線はRSAよりも高速で、同等のセキュリティを提供します。署名が短いため、データ転送サイズやクッキーサイズの管理に役立ちます。
• RSA 2048 (非対称) RS256: 最も古く広くサポートされている公開鍵暗号方式ですが、特定の側面で楕円曲線よりも大幅に遅くなる場合があります。P-256楕円曲線の使用が推奨されています。

生成した鍵を、`signing_key.json`ファイルを作ってそこに保存します。

supabaseフォルダと同じ場所に置きます。

```
supabase
    ├── .branches
    ├── .temp
    ├── migrations
    │   └── 20250908144020_remote_schema.sql
    ├── schemas
    ├── config.toml
    ├── seed.sql
    └── signing_key.json  ＜＜ココ

```


👇️`signing_key.json`ファイルを、Supabase設定ファイル(config.toml)に追加します。
[auth]項を探してそこに追加してください。

```config.tom
...
[auth]
signing_keys_path = "./signing_key.json"

```

※ここで場所やファイル名を自由に指定できます。

Supabaseクライアント (これはSupabaseにアクセスするためのクライアントのことを指しています。)

これまでは supabase/ssrを利用していましたが

今までは対称型のキーを使っていましたが
これからは非対称のJWTキーを使うようになります。
この非対称のJWTキーを使うことによりローカル内で認証を確認できるようになり、ネットワークコストを抑えることが出来ます。



## JWT とは

JSON Web Token (JWT) | Supabase Docs
https://supabase.com/docs/guides/auth/jwts#verifying-a-jwt-from-supabase

## JWT Signing Keys とは

JWT Signing Keys | Supabase Docs
https://supabase.com/docs/guides/auth/signing-keys

## JWT Signing Keys の紹介(公式Blog)

Introducing JWT Signing Keys
https://supabase.com/blog/jwt-signing-keys


## Supabaseで認証キーを使用する新しい方法

https://www.youtube.com/watch?v=htzj9SkkhhA

Next.js の Middlewareなどページ読み込みごとに認証を行う場合、認証の効率を大幅に向上させます。