<!--
title:   コードジェネレーター入門 コンポーネントの自動生成ツールplopを使用したハンズオン (Next.js app router Storybook TailwindCSS Jestの複数ファイルを同時に作る)
tags:    Jest,Next.js,plop,storybook,tailwindcss
id:      bf0b9caedc858d0f23dd
private: false
-->
# 今回のリポジトリ
masakinihirota/plop
https://github.com/masakinihirota/plop



# 環境&tool
Windows10
VSCode
GitHub Copilot
GitHub Copilot chat

Next.js
Storybook
TailwindCSS
Jest (or vitest)
plop





# テンプレートをまとめて一箇所に出力するという考え方
Next.jsを使用してStorybookを開発する場合、コンポーネントコロケーションパターンを採用して開発します。

ページをコンポーンというブロックに分け、Storybookを使いコンポーネント単位で管理します。

各ファイルはコンポーネント毎に１つのフォルダに入れて管理をします。
コンポーネントファイル
ストーリーファイル
テストファイル

※ツールでtypescriptをコンポーネント単位でプロテクトをするツール
※vitestの In-source testingで コンポーネントファイルとテストファイルを同じファイル内に書く。

plopは、コンポーネントを追加するたびにテンプレートファイルを使用して生成します。



# 事前準備インストール

すでにアプリを作成している場合はそちらを利用してください。
plopはアプリ本体に直接影響を与えません、テンプレートファイルを追加していくだけです、たとえ既存のファイルと同じ文字列を入力しても上書きになる前に停止します。

Next.js
Storybook
TailwindCSS
Jest
が使えるようにインストールしておく。

Next.jsのインストール
npx create-next-app@latest

Storybookのインストール
npx storybook@latest init

Jestのインストール
npm install --save-dev jest
npm install --save-dev @types/jest
npm install --save-dev @testing-library/jest-dom

testing-libraryのインストール
npm install --save-dev @testing-library/react

これで事前準備は終わりました、これからplopに関することだけに集中してきます。

## plopのインストール

グローバルにインストールする方法
npm install -g plop

※今回はグローバルにplopをインストールしていきます。
それも
src/componentsの直下に全てを自動生成するようにテンプレートを書いていきます。

理由は、プロジェクト毎に設定をする必要がなくなること、
コマンドが短くなること。の2つです。サクッと作っていきましょう。



※グローバルにインストールするとCLI（コマンドライン）から、どこからでもplopが使える。

動かすコマンドも
plop
で動かすことが出来る。


package.jsonファイルとplopfile.mjsがある場所をrootとして、
その下のフォルダ内に移動しても
root場所を探し出してrootを基準にしてコンポーネントを自動生成してくれる。

plopfile.mjsにtemplateファイルを設定する。
        templateFile: "templates/component/component.tsx.hbs",







# plopの守るべきルール
rootにpackage.jsonがある。
package.jsonと同じ位置にplopfile.mjsを置く

plopfile.mjsにルールを書き、
templatesフォルダにテンプレートファイルを入れる。



# plopハンズオン

## 目的
plopツールを使い、テンプレートを利用してコンポーネントファイルを自動生成します。

場所は
src/components/*
に出力するようにします。

Storybookも
src/components/*
以下のみ見るように設定します。


## 本編



###globals.cssの移動

globals.cssをTailwindCSSの設定だけにする。

```src\app\globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;



```

↑このファイル
src\app\globals.css
を
/src/styles/globals.css
に移動させる

これは自分がここにおいたほうが管理しやすいと思ったため。





### storiesフォルダを移動

storiesフォルダを
src\components\stories
に移動する。
※Storybook関連のファイルをすべてsrc\components\の下に置き、この一箇所でStoriesファイルを管理するため。
不要なら消しても大丈夫です。





### Storybookの設定

Storybookの設定をcomponentsのみに限定する。

このように設定する。
`stories: ["../src/components/**/*.mdx", "../src/components/**/*.stories.@(js|jsx|ts|tsx)"],`



```.storybook\main.ts
import type { StorybookConfig } from "@storybook/nextjs"
const config: StorybookConfig = {
  stories: ["../src/components/**/*.mdx", "../src/components/**/*.stories.@(js|jsx|ts|tsx)"],
  addons: ["@storybook/addon-links", "@storybook/addon-essentials", "@storybook/addon-interactions"],
  framework: {
    name: "@storybook/nextjs",
    options: {},
  },
  docs: {
    autodocs: "tag",
  },
}
export default config



```



StorybookでもTailwindCSSが使えるようにする。

`import "../src/styles/globals.css"`
を↓のファイルに追加する。

```.storybook\preview.ts
import type { Preview } from "@storybook/react"
import "../src/styles/globals.css"

const preview: Preview = {
  parameters: {
    actions: { argTypesRegex: "^on[A-Z].*" },
    controls: {
      matchers: {
        color: /(background|color)$/i,
        date: /Date$/,
      },
    },
  },
}

export default preview



```



## plopの設定

plopは全体として2種類のファイルが必要
コントロールファイル（＝plopfile.mjs）とテンプレートファイルと言うふうに分けてみる。

### コントロールファイルの作成

plopfile.mjsファイルはroot直下に置くこと。

```plopfile.mjs
/* eslint-disable import/no-anonymous-default-export */
// ESLintのルールを無効にするためのコメントです。import/no-anonymous-default-exportというルールは、デフォルトエクスポートが無名関数である場合に警告を出すルールです。このルールを無効にすることで、このファイルでデフォルトエクスポートが無名関数であっても、警告が出なくなります。

const pad00 = (num) => String(num).padStart(2, "0")

const date = new Date()
const year = date.getFullYear()
const month = pad00(date.getMonth() + 1)
const day = pad00(date.getDate())
const hms = `${pad00(date.getHours())}:00:00`
const datePrefix = `${year}-${month}-${day}`

const categories = ["Other", "Tech", "BlogOps"]

export default function (
  // JSDocコメントを使用して、import('plop').NodePlopAPIという型を指定しています。これは、plopというライブラリが提供するNodePlopAPIという型をインポートしていることを示しています。この型は、plopfile.mjsで使用されるplopオブジェクトの型を定義しています。
  /** @type {import('plop').NodePlopAPI} */
  plop,
) {
  plop.setGenerator("component", {
    description: "Create a new component",
    prompts: [
      {
        type: "input",
        name: "path",
        message: "どこにコンポーネントを置きますか？(例: src/components/)",
      },
      {
        type: "input",
        name: "name",
        message: "コンポーネントの名前を入力してください",
      },
    ],
    actions: [
      {
        type: "add",
        path: "src/components/{{path}}/{{pascalCase name}}/index.tsx",
        templateFile: "templates/component/component.tsx.hbs",
      },
      {
        type: "add",
        path: "src/components/{{path}}/{{pascalCase name}}/{{pascalCase name}}.test.tsx",
        templateFile: "templates/component/component.test.tsx.hbs",
      },
      {
        type: "add",
        path: "src/components/{{path}}/{{pascalCase name}}/{{pascalCase name}}.stories.tsx",
        templateFile: "templates/component/component.stories.tsx.hbs",
      },
    ],
  })
}



```


## plopテンプレートファイルの作成

templates\component\
このフォルダの中にテンプレートファイルを置きます。





```templates\component\component.stories.tsx.hbs
import type { Meta, StoryObj } from "@storybook/react";
import { {{pascalCase name}} } from '.';

type T = typeof {{pascalCase name}}

export default {
  component: {{pascalCase name}},
} satisfies Meta<T>;

export const Default: StoryObj<T> = {};


```





```templates\component\component.test.tsx.hbs
import { render, screen } from "@testing-library/react";
import { {{pascalCase name}} } from ".";

test('renders {{pascalCase name}} component', () => {
  render(<{{pascalCase name}} />);

  const titleElement = screen.getByRole( "heading", { level: 1, name: /{{pascalCase name}} Component/i });

  expect(titleElement).toBeInTheDocument();
});


```





```templates\component\component.tsx.hbs
import { FC } from 'react';

type Props = {};

export const {{pascalCase name}}: FC<Props> = (props) => {
  return (
    <div className="">
      <h1>{{pascalCase name}} Component</h1>
    </div>
  );
};



```

className=""
↑ここにTailwindCSSの設定を書く

これで入力は終了です。



##  plopの動作確認

plopをグローバルインストールした場合

plop
で動く。

基本的に1行で入力可能
plop フォルダ名 コンポーネント名

フォルダ名やコンポーネント名を省略してもインタラクティブに質問される。



### 実際の使用例

↓完成するとこのように出力されます。
例

```
06-19 23:10:51> plop aaa/bbb
? コンポーネントの名前を入力してください ccc
✔  ++ \src\components\aaa\bbb\Ccc\index.tsx
✔  ++ \src\components\aaa\bbb\Ccc\Ccc.test.tsx
✔  ++ \src\components\aaa\bbb\Ccc\Ccc.stories.tsx



```





```
06-19 23:11:02> plop eee/fff jjj
✔  ++ \src\components\eee\fff\Jjj\index.tsx
✔  ++ \src\components\eee\fff\Jjj\Jjj.test.tsx
✔  ++ \src\components\eee\fff\Jjj\Jjj.stories.tsx



```





※フォルダ名とファイル名をCLIから1行で入力することが出来ます。
aaa/bbb、eee/fff が指定フォルダ名
jjj が指定コンポーネント名

コンポーネント名を指名しないとインタラクティブに
「コンポーネントの名前を入力してください」と聞いてきます。

※自動生成されたフォルダやファイルを削除する場合
フォルダごとまとめて削除するだけで大丈夫です。


npm run storybook
Storybookを起動して動作を確認します。

あとは適当にコンポーネントをインポートして使ってみます。

↓こんな感じです。

![plop001.PNG](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44761/da89fe4e-0b58-bc56-ce0d-4a76d0db7b33.png)

テンプレートだけなのでStorybookの中身はゼロです。
右上に警告が出ています。


確認が終了したら以上でハンズオンは終了です。




# テンプレートの書き方

templates\component\component.tsx.hbs

テンプレートファイルは
.hbsと言う拡張子で書きます。

パス
{{path}}

パスカルケース
{{pascalCase name}}
CurrentUserItem のように書きます。
要素語( current user item )の最初を大文字で書き始めます。

ケバブケース
{{ kebabCase name}}
current-user-item のように書きます。
ハイフン で要素語( current user item )を連結します。





# What's plop？
plopは、コードジェネレーターの1つで、テンプレートファイルを使用してコンポーネントやファイルを自動生成することができます。

plopを使用することで、開発者は手動でコンポーネントやファイルを作成する手間を省くことができます。

これは典型的な、後で楽をするために導入に苦労するタイプのツールです。
AI時代になってGitHub Copilot があれば不要かもって思っています。
※GitHub Copilot とGitHub Copilot chatは便利ですので布教したいですね。



hygenよりもplopが選ばれるのは
ESM（import/export）が使えるから？？？
この理由がよくわからない。
hygenを使ったことがない、比較はできないので評価はしない。



## VSCodeの拡張機能

File Templates - Visual Studio Marketplace
https://marketplace.visualstudio.com/items?itemName=SamKirkland.plop-templates

このVSCodeの拡張機能は、右クリックからplopのテンプレートを使ってコンポーネントを自動生成できるようになります。今のところマウスからでも自動生成できるようになるだけです。

この拡張機能はデフォルトで、グローバルにインストールされたplopを使用することを想定しています。

npm install -g plop

ローカルのplopを使用する場合は、package.jsonの「scripts」レコードに「add-form-template」：「plop」を追加します。

```
"scripts": {
	"add-from-template": "plop"
}

```





# 拡張子.hrbってなに？

.hbsはJavaScriptテンプレートエンジンHandlebarsで使われていた拡張子です。

## Handlebarsとは？

Handlebarsとはいわゆるテンプレートエンジンで、
JavaScriptの値を参照してHTMLを生成します。

公式
Handlebars
https://handlebarsjs.com/
Handlebarsとplopは直接関係なさそうです、
過去の遺産（＝拡張子）をそのまま使っている感じですかね。





# その他

AI開発とは
ChatGPTやGitHub Copilot chatを利用して開発する手法

コンポーネントコロケーションパターン - Qiita
https://qiita.com/masakinihirota/items/27f961dfa6871aad0550
コロケーションパターンとも呼ばれている。
アトミックデザインとは水と油。

コンポーネントコロケーションパターンは一つにまとめておく手法。
再利用しにくいが、一箇所にまとまってファイルを管理するのでメンテナンス性は高い、小規模開発向け。
Next.js 13の Sever Actionの発表によりコンポーネント単位でfetch（データ取得）が出来るようになり、コンポーネントの凝縮性は高まっていくと思われる。

アトミックデザインはパーツごとに切り分けて管理する手法。
再利用しやすい、どこのファイルがあるかすぐに分からずメンテナンス性は低い、大規模開発向け。





# 参考サイト



## 関連URL

Visual Studio Code - Code Editing. Redefined
https://code.visualstudio.com/

Next.js by Vercel - The React Framework
https://nextjs.org/

Storybook: Frontend workshop for UI development
https://storybook.js.org/

Tailwind CSS - Rapidly build modern websites without ever leaving your HTML.
https://tailwindcss.com/

Jest · 🃏 Delightful JavaScript Testing
https://jestjs.io/ja/

Vitest | A blazing fast unit test framework powered by Vite
https://vitest.dev/

Consistency Made Simple : PLOP
https://plopjs.com/



## その他

mymactive/my-code-generator-templates: Templates of code generator
https://github.com/mymactive/my-code-generator-templates

【PLOP CLI】新しいファイルをテンプレートから生成するCLI
https://zenn.dev/anozon/articles/gatsby-plop-newpost

Features | Guide | Vitest
https://vitest.dev/guide/features.html#in-source-testing
In-source testing
コードとテストを同居させる機能。
AI開発と相性が良いと思われる。

PLOPでComponentファイルを雛形から生成しよう
https://zenn.dev/shwld/articles/c26345ed8e781b