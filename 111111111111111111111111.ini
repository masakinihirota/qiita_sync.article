













chriscarrollsmithã•ã‚“ãŒ9æ™‚é–“å‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ â€¢
ç§ã¯ä¸€æ—¥ã®å¤§éƒ¨åˆ†ã‚’è²»ã‚„ã—ã¦ã€æœ€åˆã®æ•°å›ã®ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ã„ãã¤ã‹ã®ç•°ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒã«æ•´ç†ã—ã¾ã—ãŸã€‚ã„ãã¤ã‹ã®å ´åˆã«ã¯ã‚ãšã‹ãªå¤‰æ›´ã‚’åŠ ãˆã¾ã—ãŸã€‚ï¼ˆã“ã‚Œã‚‰ã®ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®PRã®é–‹ãæ–¹ã«ã¤ã„ã¦ã©ã®ã‚ˆã†ã«æ‰±ã†ã‹ã€ã‚ãªãŸãŒç´ æ™´ã‚‰ã—ã„ä»•äº‹ã«å¯¾ã—ã¦ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã©ã†ã‹ã€ç§ã«çŸ¥ã‚‰ã›ã¦ãã ã•ã„ã€‚ï¼‰

https://github.com/chriscarrollsmith/nextjs-subscription-payments/tree/supabase-auth ã§ã¯ã€supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆæ–¹æ³•ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™
https://github.com/chriscarrollsmith/nextjs-subscription-payments/tree/stripe-checkout ã§ã¯ã€æœ€æ–°ã®Stripe APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã€ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã®å‹•ä½œã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™
https://github.com/chriscarrollsmith/nextjs-subscription-payments/tree/ui-refactor ã§ã¯ã€Cardã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç‹¬è‡ªã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•ã—ã€Buttonã«displayNameã‚’è¨­å®šã—ã¦ã„ã¾ã™
supabase-authã®éƒ¨åˆ†ã¯è‰¯ã•ãã†ã§ã™ãŒã€ã¾ã åŒ…æ‹¬çš„ã«ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚“ã§ã„ãã¤ã‹ã®ã“ã¨ã‚’å­¦ã³ã¾ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ãªãŸã‚ˆã‚Šã‚‚å¤šãè¿½åŠ ã—ã¾ã—ãŸãŒã€ãã‚Œä»¥å¤–ã¯ã‚ãªãŸã®ã‚³ãƒ¼ãƒ‰ã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚ui-refactorã‚‚ç§ã«ã¨ã£ã¦ã¯è‰¯ã•ãã†ã§ã™ãŒã€Card.tsxã‚’Cardã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®ã—ã€index.tsãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€ä»–ã®uiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ä¸€è‡´ã•ã›ã¾ã—ãŸã€‚

stripe-checkoutã®éƒ¨åˆ†ã«ã¤ã„ã¦ã¯ä¸ç¢ºã‹ã§ã™ã€‚stripe.tsã§APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚ãªãŸã®ã‚‚ã®ã«å¤‰æ›´ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€å‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚å‹ã¯ã€node_modulesã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®stripeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã£ã¦è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ã‚»ã‚¹ãŒStripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚READMEã«ã¯ã€'stripe.ts'ã§æŒ‡å®šã•ã‚ŒãŸAPIãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒStripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨stripeãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‹å®šç¾©ã§è¨±å¯ã•ã‚Œã‚‹APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚

ã¾ãŸã€create-checkoutãƒ«ãƒ¼ãƒˆã§å¤‰æ›´ã—ãŸå†…å®¹ã®ä¸€éƒ¨ã‚‚èª¿æ•´ã—ã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãŸã‚ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’Stripeãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«æä¾›ã™ã‚‹ãŸã‚ã«ã€cancel_urlã‚’æˆ»ã—ã¾ã—ãŸã€‚ãã—ã¦ã€ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®ã‚µãƒãƒ¼ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹ä»£ã‚ã‚Šã«ã€'trial_period_days: price.trial_period_days'ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Stripeãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰åˆ¶å¾¡ã•ã‚Œã‚‹ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã¨éãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã®ä¸¡æ–¹ãŒå‹•çš„ã«è¨±å¯ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚ï¼ˆStripeã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€trial_endã¾ãŸã¯trial_period_daysã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¸€ç›®ã§è¦‹ã‚‹é™ã‚Šã€å¾Œè€…ã®æ–¹ãŒã‚ˆã‚Šå®‰å…¨ã«æ€ãˆã¾ã™ã€‚ï¼‰

ã¾ã ãƒˆãƒ¼ã‚¹ãƒˆã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚«ãƒãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å…¨ãè¦‹ã¦ã„ã¾ã›ã‚“ãŒã€ãã‚Œã‚‰ã¯ç§è‡ªèº«ãŒè¿½åŠ ã—ãŸã‹ã£ãŸæ©Ÿèƒ½ã§ã‚ã‚Šã€ã‚ãªãŸã®ãŠã‹ã’ã§å¤šãã®æ™‚é–“ã‚’ç¯€ç´„ã§ãã‚‹ã®ã§ã€æ˜æ—¥ã¯ãã‚Œã‚‰ã«å–ã‚Šçµ„ã‚“ã§ãƒ©ã‚¤ãƒ–ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã®ãŒæ¥½ã—ã¿ã§ã™ï¼









dalkommatt commented 6 hours ago
I spent most of the day reviewing your first couple commits and sorting them into three different branches, in some cases with slight changes. (Let me know how or if you want me to handle opening PRs from these branches, because I want you to get credit for your excellent work.)

Thank you, yeah maybe let's see if Thor or Jon wants to take a look at the current PR first. My last PR was also quite big but did end up getting merged with some revisions. In the meantime are you able to suggest the changes here?

The supabase-auth stuff looks good, though I haven't comprehensively tested it yet. Required some reading of docs, and I learned some things. I added a few more comments than you, but otherwise my branch is in line with your code. Your ui-refactor also looks good to me, although I've placed Card.tsx into a Card subfolder and exported it from an index.ts file to match the rest of the ui components.

Not sure that I changed much as far as auth goes, it's still using supabase-provider.tsx with Auth UI. I think the main thing is that I switched sign out to a server action. Matching Card with the other components is a good change!

The stripe-checkout stuff I'm unsure about. When I try to change my API version in stripe.ts to match yours, I get a type error. The type is apparently set by my install of the latest version of the stripe library in node_modules. It's possible that the installation process is somehow pulling my account's API version from my Stripe dashboard. There probably needs to be some documentation in the README about how to make sure the API version specified in 'stripe.ts' matches the API version of one's Stripe account and the API version permitted by the stripe module's type definitions.

Come to think of it I may have updated my Stripe version from the Stripe dashboard at some point. The reason I changed the version in stripe.ts is because I was getting a type error Type '"2022-11-15"' is not assignable to type '"2023-10-16"'.ts(2322) Do you not get that?

I also adjusted some of what you changed in the create-checkout route. I put the cancel_url back in, so that Stripe checkout will provide a 'back' button for the user to cancel checkout if they want. And instead of dropping all support for free trials, I used 'trial_period_days: price.trial_period_days,' which should dynamically allow for both trialing and non-trialing subscription, as controlled from the Stripe dashboard. (The Stripe docs say setting trial_end or trial_period_days is preferred over setting trial_from_plan, though I can't see why, as the latter seems more secure to me at a glance.)

Dropped cancel_url is my mistake, definitely should be corrected. Nice idea on the trial period too.

I haven't looked at your toast or password recovery code yet at all, but I am excited to dive into that and also do some live testing tomorrow, because those are features I've been wanting to add myself, and you are going to save me a lot of time!

Yeah I think you'll find a useEffect in the toaster listening for URL param changes is quite an elegant solution for handling notifications globally with all the components going server side. Password recovery is not working like expected currently so be aware. I was hoping someone from Supabase could take a look at it. We're not supposed to @ people, right ğŸ˜…

