













chriscarrollsmithさんが9時間前にコメントしました •
私は一日の大部分を費やして、最初の数回のコミットをレビューし、いくつかの異なるブランチに整理しました。いくつかの場合にはわずかな変更を加えました。（これらのブランチからのPRの開き方についてどのように扱うか、あなたが素晴らしい仕事に対してクレジットを受けることができるかどうか、私に知らせてください。）

https://github.com/chriscarrollsmith/nextjs-subscription-payments/tree/supabase-auth では、supabaseクライアントの作成方法を更新しています
https://github.com/chriscarrollsmith/nextjs-subscription-payments/tree/stripe-checkout では、最新のStripe APIバージョンにアップグレードし、チェックアウトの動作を変更しています
https://github.com/chriscarrollsmith/nextjs-subscription-payments/tree/ui-refactor では、Cardコンポーネントを独自のファイルに移動し、ButtonにdisplayNameを設定しています
supabase-authの部分は良さそうですが、まだ包括的にテストしていません。ドキュメントを読んでいくつかのことを学びました。コメントはあなたよりも多く追加しましたが、それ以外はあなたのコードと一致しています。ui-refactorも私にとっては良さそうですが、Card.tsxをCardサブフォルダに配置し、index.tsファイルからエクスポートして、他のuiコンポーネントと一致させました。

stripe-checkoutの部分については不確かです。stripe.tsでAPIバージョンをあなたのものに変更しようとすると、型エラーが発生します。型は、node_modulesにインストールされた最新バージョンのstripeライブラリによって設定されているようです。インストールプロセスがStripeダッシュボードからアカウントのAPIバージョンを取得している可能性があります。READMEには、'stripe.ts'で指定されたAPIバージョンがStripeアカウントのAPIバージョンとstripeモジュールの型定義で許可されるAPIバージョンと一致するようにする方法についてのドキュメントが必要です。

また、create-checkoutルートで変更した内容の一部も調整しました。ユーザーがチェックアウトをキャンセルするための「戻る」ボタンをStripeチェックアウトに提供するために、cancel_urlを戻しました。そして、無料トライアルのサポートを完全に削除する代わりに、'trial_period_days: price.trial_period_days'を使用しました。これにより、Stripeダッシュボードから制御されるトライアルと非トライアルの両方が動的に許可されるはずです。（Stripeのドキュメントでは、trial_endまたはtrial_period_daysを設定することが推奨されていますが、一目で見る限り、後者の方がより安全に思えます。）

まだトーストやパスワードリカバリのコードを全く見ていませんが、それらは私自身が追加したかった機能であり、あなたのおかげで多くの時間を節約できるので、明日はそれらに取り組んでライブテストを行うのが楽しみです！









dalkommatt commented 6 hours ago
I spent most of the day reviewing your first couple commits and sorting them into three different branches, in some cases with slight changes. (Let me know how or if you want me to handle opening PRs from these branches, because I want you to get credit for your excellent work.)

Thank you, yeah maybe let's see if Thor or Jon wants to take a look at the current PR first. My last PR was also quite big but did end up getting merged with some revisions. In the meantime are you able to suggest the changes here?

The supabase-auth stuff looks good, though I haven't comprehensively tested it yet. Required some reading of docs, and I learned some things. I added a few more comments than you, but otherwise my branch is in line with your code. Your ui-refactor also looks good to me, although I've placed Card.tsx into a Card subfolder and exported it from an index.ts file to match the rest of the ui components.

Not sure that I changed much as far as auth goes, it's still using supabase-provider.tsx with Auth UI. I think the main thing is that I switched sign out to a server action. Matching Card with the other components is a good change!

The stripe-checkout stuff I'm unsure about. When I try to change my API version in stripe.ts to match yours, I get a type error. The type is apparently set by my install of the latest version of the stripe library in node_modules. It's possible that the installation process is somehow pulling my account's API version from my Stripe dashboard. There probably needs to be some documentation in the README about how to make sure the API version specified in 'stripe.ts' matches the API version of one's Stripe account and the API version permitted by the stripe module's type definitions.

Come to think of it I may have updated my Stripe version from the Stripe dashboard at some point. The reason I changed the version in stripe.ts is because I was getting a type error Type '"2022-11-15"' is not assignable to type '"2023-10-16"'.ts(2322) Do you not get that?

I also adjusted some of what you changed in the create-checkout route. I put the cancel_url back in, so that Stripe checkout will provide a 'back' button for the user to cancel checkout if they want. And instead of dropping all support for free trials, I used 'trial_period_days: price.trial_period_days,' which should dynamically allow for both trialing and non-trialing subscription, as controlled from the Stripe dashboard. (The Stripe docs say setting trial_end or trial_period_days is preferred over setting trial_from_plan, though I can't see why, as the latter seems more secure to me at a glance.)

Dropped cancel_url is my mistake, definitely should be corrected. Nice idea on the trial period too.

I haven't looked at your toast or password recovery code yet at all, but I am excited to dive into that and also do some live testing tomorrow, because those are features I've been wanting to add myself, and you are going to save me a lot of time!

Yeah I think you'll find a useEffect in the toaster listening for URL param changes is quite an elegant solution for handling notifications globally with all the components going server side. Password recovery is not working like expected currently so be aware. I was hoping someone from Supabase could take a look at it. We're not supposed to @ people, right 😅

