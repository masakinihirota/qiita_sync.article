<!--
title:   Supabaseのバックアップ
tags:    Supabase
id:      1a8a9b838b8807d85c42
private: false
-->
Supabaseを利用している皆さん、データのバックアップは万が一の事態に備えるためのとても大切な作業です。この記事では、Supabaseの全データをバックアップする方法から、日々の自動バックアップ、そして役立つアドバイスまで、具体的な手順を交えてご紹介します。

### 1. 全データ（スキーマ＋データ）のバックアップ方法

Supabaseにおいて「全体」とは、 **「スキーマ（テーブル定義・インデックス・関数・トリガーなどの構造）」**と**「データ（テーブル内の全レコード）」** の両方を指します。これらの完全なバックアップを取得するには、以下のコマンドを使用します。

```bash
supabase db dump -f backupAll.sql
```
このコマンドは、リモートのSupabaseデータベースからスキーマとデータの両方を`backupAll.sql`というファイルにダンプします。

もしローカル環境のデータベースをバックアップしたい場合は、`--local`オプションを追加します。
```bash
supabase db dump -f backupAll_local.sql --local
```

**【補足】特定の要素のみをバックアップする場合**
*   **データのみ**: `supabase db dump --data-only -f backupData.sql`
*   **ロール（ユーザー・権限）のみ**: `supabase db dump --role-only -f backupRoles.sql`
*   **スキーマのみ**: `supabase db dump --schema -f backupSchema.sql`
*   **特定のスキーマ（例: `public`と`auth`）のみ**: `supabase db dump -s public,auth -f backupPartial.sql`

これらのオプションも、必要に応じて`--local`を付けてローカルDBに対して実行できます。

### 2. 全データのリストア方法

Supabaseのリストア順序には重要なルールがあります。基本は**「ロール → スキーマ → データ」**の順です。完全なリストアを行う場合は、まずロールのバックアップをリストアし、次に全体（スキーマ＋データ）のバックアップをリストアします。

### 3. 毎日バックアップする方法

毎日バックアップを行うには、バックアップコマンドをスクリプト化し、それを定期的に実行する仕組みを構築するのが一般的です。
タイムスタンプ付きでローカルにバックアップする `backup-supabase.ps1` というスクリプトの例。

```powershell
# backup-supabase.ps1
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$filename = "backupAll_local_$timestamp.sql"
$backupDir = "backup"

if (!(Test-Path $backupDir)) {
    New-Item -ItemType Directory -Path $backupDir | Out-Null
}

try {
    supabase db dump -f "$backupDir\$filename" --local
    if ($LASTEXITCODE -eq 0) {
        Write-Host "バックアップ完了: $backupDir\$filename"
    } else {
        Write-Host "バックアップに失敗しました (exit code: $LASTEXITCODE)"
    }
} catch {
    Write-Host "エラーが発生しました: $_"
}

```

このスクリプトは、日々のバックアップを自動化するために利用できます。
例えば、WindowsのタスクスケジューラやLinuxのcronジョブなどを利用して、毎日特定の時刻にこのスクリプトを実行するように設定することで、自動的に日次バックアップが作成されます。

### 4. 毎日バックアップからリストアする方法

日次バックアップからリストアする場合も、基本的な手順は「2. 全データのリストア方法」と同じです。異なる点は、リストアしたい特定の日のバックアップファイルを選択することです。

例えば、`backupAll_2025-08-27.sql`というタイムスタンプ付きのバックアップファイルからリストアしたい場合：

1.  **ロールのリストア**:
    その日のロールバックアップファイル（例: `backupRoles_2025-08-27.sql`）を使ってリストアします。

    `bash
    supabase db execute --file backupRoles_2025-08-27.sql

    `

2.  **全体（スキーマ＋データ）のリストア**:
    その日の全体バックアップファイル（例: `backupAll_2025-08-27.sql`）を使ってリストアします。

    `bash
    supabase db execute --file backupAll_2025-08-27.sql

    `

**繰り返しになりますが、リストアは**「ロール」→「全体（スキーマ＋データ）」**の順で実行することが大切です**。

### 5. その他のアドバイス（Tips）

*   **リストア順序の徹底**: 最も大切なアドバイスは、リストアする際の順序「ロール→全体（スキーマ＋データ）」を必ず守ることです。これにより、多くのエラーを未然に防ぐことができます。
*   **`psql`コマンドの活用**: 大量のデータを扱う場合や、より安定したリストアを求める場合は、`supabase db execute`の代わりに`psql`コマンドの利用を検討してください。`psql`の方が高速かつ確実な場合があります。
*   **ローカルとリモートの使い分け**: `supabase db execute`はデフォルトでリモートDBに適用されるため、ローカルDBに適用したい場合は必ず`--local`オプションを使用することを忘れないでください。
*   **部分バックアップの検討**: 全体を常にバックアップするだけでなく、必要に応じて特定のスキーマ（例: `public`や`auth`）のみをバックアップする`supabase db dump -s <schema_name>`オプションも活用できます。
* Secrets（機密情報）の管理: APIキーや外部サービスの認証情報など、SupabaseのVaultで管理しているSecretsはdb dumpコマンドには含まれません。
* DashboardのVaultで設定したSecretsは、別途安全な場所にメモ・保管しておく必要があります。
* Supabaseの公式バックアップ機能: 有料プラン（Pro以上）で提供されている公式の自動バックアップ機能の活用

Supabaseのバックアップとリストアは、サービスを安定して運用するために不可欠なプロセスです。これらの手順とアドバイスを参考に、あなたのSupabaseプロジェクトを安全に保ってください。



## コマンドまとめ

```powershell
supabase db dump -f backupAll.sql	（全体＝スキーマ＋データ）
supabase db dump --data-only -f backupData.sql	（データのみ）
supabase db dump --role-only -f backupRoles.sql	（ロールのみ）
# ※現状 supabase db dump にスキーマオンリーはありません

# サーバーのSupabaseのバックアップ
supabase db dump -f backupAll.sql
supabase db dump --data-only -f backupData.sql
supabase db dump --role-only -f backupRoles.sql

# ローカルのSupabaseのバックアップ
supabase db dump -f backupAll_local.sql  --local
supabase db dump --role-only -f backupRoles_local.sql --local
supabase db dump --data-only -f backupData_local.sql --local

# スキーマを指定します。
supabase db dump -s public,auth -f backupPartial.sql
supabase db dump -s public,auth -f backupPartial_local.sql --local

# フォルダも一緒に指定します。(フォルダは作成しておきます)
supabase db dump -f backup/backupAll_local.sql  --local
supabase db dump -f backup/backupAll_local.sql  --local

# タイムスタンプ付きバックアップローカル
./backup-supabase.ps1

```