<!--
title:   Supabaseã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆã‚¢ (Postgres ã‚’Windowsã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«)
tags:    Supabase
id:      1a8a9b838b8807d85c42
private: false
-->
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æ–¹æ³•

### 1. åŸºæœ¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰

Supabase CLI ã® `supabase db dump` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚

åŸºæœ¬å‹

```terminal
supabase db dump -f backup.sql

```

â€»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Linkå…ˆã®ãƒªãƒ¢ãƒ¼ãƒˆã®Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€ãƒªãƒ¢ãƒ¼ãƒˆã®Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰`backup.sql`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¾ã™ã€‚

ã‚‚ã—ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸã„å ´åˆã¯ã€ğŸ‘‡ï¸ `--local`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```terminal
supabase db dump -f backup_local.sql --local

```

**ã€è£œè¶³ã€‘ç‰¹å®šã®è¦ç´ ã®ã¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹å ´åˆ**
*   **ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»æ¨©é™ï¼‰ã®ã¿**: `supabase db dump --role-only -f backupRoles.sql`
*   **ç‰¹å®šã®ã‚¹ã‚­ãƒ¼ãƒï¼ˆä¾‹: `public`ã¨`auth`ï¼‰ã®ã¿**: `supabase db dump -s public,auth -f backupPartial.sql`
*   **ãƒ‡ãƒ¼ã‚¿ã®ã¿**: `supabase db dump --data-only -f backupData.sql`

### 2. æ¯æ—¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹æ–¹æ³•

æ¯æ—¥ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¡Œã†ã«ã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆåŒ–ã—ã€ãã‚Œã‚’å®šæœŸçš„ã«å®Ÿè¡Œã—ã¾ã™ã€‚

powershellã§ã®ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ `backup-supabase.ps1` ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¾‹ã€‚

```powershell
# backup-supabase.ps1
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$filename = "backupAll_local_$timestamp.sql"
$backupDir = "backup"

if (!(Test-Path $backupDir)) {
    New-Item -ItemType Directory -Path $backupDir | Out-Null
}

try {
    supabase db dump -f "$backupDir\$filename" --local
    if ($LASTEXITCODE -eq 0) {
        Write-Host "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: $backupDir\$filename"
    } else {
        Write-Host "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ (exit code: $LASTEXITCODE)"
    }
} catch {
    Write-Host "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $_"
}

```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€æ—¥ã€…ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€Windowsã®ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚„Linuxã®cronã‚¸ãƒ§ãƒ–ãªã©ã‚’åˆ©ç”¨ã—ã¦ã€æ¯æ—¥ç‰¹å®šã®æ™‚åˆ»ã«ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€è‡ªå‹•çš„ã«æ—¥æ¬¡ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã™ã€‚



# å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã®Supabaseå…¨ä½“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚³ãƒãƒ³ãƒ‰

https://supabase.com/docs/guides/platform/migrating-within-supabase/backup-restore

ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜å ´æ‰€ã®è¨­å®šã‚’ã—ã¾ã™ã€‚
ä¾‹ãˆã°ã€supabaseãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã® `supabase/backup` ã«ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚(å ´æ‰€ã¯è‡ªç”±ã§ã™)

```
supabase/
â”œâ”€â”€ backup
â”‚   â”œâ”€â”€ data.sql
â”‚   â”œâ”€â”€ roles.sql
â”‚   â””â”€â”€ schema.sql
â”œâ”€â”€ migrations
â”œâ”€â”€ .gitignore
â”œâ”€â”€ config.toml
â””â”€â”€ signing_key.json

```

## Supabaseã®ã‚µãƒ¼ãƒãƒ¼å´ã¨ãƒ­ãƒ¼ã‚«ãƒ«å´ãã‚Œãã‚Œã®å ´åˆã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

```terminal
# ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
# ãƒ­ãƒ¼ãƒ«
supabase db dump -f supabase/backup/roles.sql --role-only
# ã‚¹ã‚­ãƒ¼ãƒ
supabase db dump -f supabase/backup/schema.sql
# ãƒ‡ãƒ¼ã‚¿
supabase db dump -f supabase/backup/data.sql --use-copy --data-only

# ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
# ãƒ­ãƒ¼ãƒ«
supabase db dump --local -f supabase/backup/roles_local.sql --role-only
# ã‚¹ã‚­ãƒ¼ãƒ
supabase db dump --local -f supabase/backup/schema_local.sql
# ãƒ‡ãƒ¼ã‚¿
supabase db dump --local -f supabase/backup/data_local.sql --use-copy --data-only

```

1. ãƒ­ãƒ¼ãƒ«ã‚’å–å¾—
1. ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—
1. ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–ã£ã¦ãã‚‹ã¨æŒ‡å®šã—ã¦ã„ã‚‹ã€‚



---

# DBã®ãƒªã‚»ãƒƒãƒˆ

localã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å ´åˆ
â€»--db-url ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ¥ç¶šæ–‡å­—åˆ—ã‚’æŒ‡å®šã—ã¾ã™ã€‚
--local ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ãˆã°ã„ã„ã®ã§ã™ãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã®æ¥ç¶šæ–‡å­—åˆ—ã‚’æŒ‡å®šã—ãŸå ´åˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è¨˜éŒ²ã—ã¦ãŠãã¾ã™ã€‚

```terminal
supabase db reset --db-url postgresql://postgres:postgres@127.0.0.1:54322/postgres

```



---

# ãƒªã‚¹ãƒˆã‚¢ã®æ–¹æ³•

ãƒªã‚¹ãƒˆã‚¢ã¯Supabaseã®æœ‰æ–™ã§ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã‹ã€psqlã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã‹ã€ã‚‚ã—ãã¯DBeaverãªã©ã®ãƒ„ãƒ¼ãƒ«ã§å¾©å…ƒã—ã¾ã™ã€‚

â€»Supabaseã®CLIã«ã¯ãƒªã‚¹ãƒˆã‚¢ã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚



## å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

Restore Dashboard backup | Supabase Docs
https://supabase.com/docs/guides/platform/migrating-within-supabase/dashboard-restore

## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å«ã¾ã‚Œãªã„ã‚‚ã®

ã¾ãšã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ç›´æ¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œãªã„ä»¥ä¸‹ã®é …ç›®ã¯ **å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“**

*   **Edge Functions**
*   **Auth Settings (èªè¨¼è¨­å®š) ã¨ API ã‚­ãƒ¼**
*   **Realtime settings (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨­å®š)**
*   **Database extensions (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ‹¡å¼µæ©Ÿèƒ½) ã¨è¨­å®š**

# psqlã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

## å‚è€ƒ

https://qiita.com/tom-sato/items/037b8f8cb4b326710f71

Postgresã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
Postgres ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒšãƒ¼ã‚¸ã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚

## PostgreSQL ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆ

https://www.postgresql.org/download/windows/

PostgreSQLã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã—ã¾ã™ã€‚

### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆ

```
C:\Program Files\PostgreSQL\17

```

## ãƒ‘ã‚¹ã®è¨­å®š

ã‚·ã‚¹ãƒ†ãƒ PATHã«Postgresã‚’è¿½åŠ ã—ã¾ã™ã€‚

https://qiita.com/masakinihirota/items/6b508d507197b03da17b

```
C:\Program Files\PostgreSQL\17\bin

```

(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®)ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆï¼‹\bin ã‚’è¿½åŠ ã—ã¾ã™ã€‚
PATHã‚’è¿½åŠ ã—ãŸå¾Œã¯PCã‚’å†èµ·å‹•ã—ã¾ã™ã€‚

â€»\binã‚’è¿½åŠ ã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã§ãã ã•ã„ã€‚





## psqlã®å‹•ä½œç¢ºèª

VSCodeã®Powershellãªã©ã‚’ç«‹ã¡ä¸Šã’ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

```terminal
09-12 20:41:21> psql --version
psql (PostgreSQL) 17.6

```



## æ¥ç¶šæ–‡å­—åˆ—ã®ä½œæˆ

ã‚µãƒ¼ãƒãƒ¼ã®å ´åˆ

![æ¥ç¶šæƒ…å ±1.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44761/58220bb0-4fae-4734-8ea5-8d4428a9f754.png)

![æ¥ç¶šæƒ…å ±2.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44761/98cd732c-5dce-4bf7-9690-63150e85fb87.png)



### Supabase ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šæ–‡å­—åˆ—

```terminal
# us-east(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤)
postgresql://postgres.[PROJECT-REF]:[YOUR-PASSWORD]@aws-0-us-east-1.pooler.supabase.com:5432/postgres

# northeast-1
# Transaction pooler
postgresql://postgres.[PROJECT-REF]:[YOUR-PASSWORD]@aws-0-ap-northeast-1.pooler.supabase.com:6543/postgres

# northeast-1
# Session pooler
postgresql://postgres.[PROJECT-REF]:[YOUR-PASSWORD]@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres

```

[PROJECT-REF]ã¯Supabaseã§ä½œæˆã—ãŸProject ID
[YOUR-PASSWORD]ã¯DBã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

Project IDã¯ã€Supabaseã®ã‚µãƒ¼ãƒãƒ¼ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å·¦ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® Project Settings ï¼ Settings ï¼ General ï¼ Project Settings ï¼ Project ID ã§ç¢ºèªã§ãã¾ã™ã€‚




### Supabase ãƒ­ãƒ¼ã‚«ãƒ«ã¸ã®æ¥ç¶šæ–‡å­—åˆ—

`supabase status` ã‚³ãƒãƒ³ãƒ‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```terminal
supabase status
...
DB URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres

```

ğŸ‘†ï¸ DB URLãŒãƒ­ãƒ¼ã‚«ãƒ«ã¸ã®æ¥ç¶šæ–‡å­—åˆ—



## ãƒªã‚¹ãƒˆã‚¢ã®å®Ÿè¡Œ

æ¥ç¶šæ–‡å­—åˆ—ã®æº–å‚™ãŒã§ããŸã‚‰ã€`psql`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã—ã¾ã™ã€‚

```terminal

# ã‚µãƒ¼ãƒãƒ¼ã®Supabaseã‚’ãƒªã‚¹ãƒˆã‚¢
psql \
  --single-transaction \
  --variable ON_ERROR_STOP=1 \
  --file roles.sql \
  --file schema.sql \
  --command 'SET session_replication_role = replica' \
  --file data.sql \
  --dbname [æ¥ç¶šæ–‡å­—åˆ—]

# ãƒ­ãƒ¼ã‚«ãƒ«ã®Supabaseã‚’ãƒªã‚¹ãƒˆã‚¢

psql --single-transaction --variable ON_ERROR_STOP=1 --file supabase/backup/roles_local.sql --file supabase/backup/schema_local.sql --command 'SET session_replication_role = replica' --file supabase/backup/data_local.sql --dbname postgresql://postgres:postgres@127.0.0.1:54322/postgres

```

`[æ¥ç¶šæ–‡å­—åˆ—]`ã¨`/SQLfile/path`ã‚’
ãã‚Œãã‚Œç½®ãæ›ãˆã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãŒå¾©å…ƒã•ã‚Œã¾ã™ã€‚



ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯é€±1å›ï½æ¯æ—¥å®Ÿè¡Œã—ã¾ã™ã€‚

ã‚¿ã‚¹ã‚¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚„ã€GitHub Actions ã® Scheduled workflow ã‚’ä½¿ã„ã¾ã™
`supabase db dump ã‚³ãƒãƒ³ãƒ‰` ã§SQLãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã—ã€ãã‚Œã‚’åœ§ç¸®ï¼†æš—å·åŒ–ã®ã†ãˆé©å½“ãªå ´æ‰€ã«ä¿å­˜ã—ã¾ã™ã€‚

ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®æ•°ã‚„ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä¿å­˜å…ˆã‚„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è€ƒãˆç›´ã—ã¾ã™ã€‚

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å®Œå…¨è‡ªå‹•åŒ–ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚

ä»¥ä¸Šã§çµ‚äº†ã§ã™ã€‚
