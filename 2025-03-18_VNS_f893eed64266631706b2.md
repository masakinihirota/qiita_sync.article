<!--
title:   masakinihirota-template GitHub Copilot による設計と実装
tags:    VNS
id:      f893eed64266631706b2
private: true
-->
# 開発コマンド

```terminal
# CLIアップデート
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase
# update
scoop update supabase

# Shadcn コンポーネントの追加
pnpm dlx shadcn@latest add badge

# Supabaseコマンド
supabase db push
supabase start
supabase start && supabase migration up
supabase stop
supabase stop --no-backup
supabase status
supabase db reset
supabase link
supabase projects list

※--no-backup を使用すると、supabase のローカル プロジェクト データがすべて削除されるため、注意して使用してください。

※supabase db reset
これは新しくDBを再構築します
新しくマイグレーションを適用します。
シードファイル(`supabase/seed.sql`)があるならそれも読み込みます。
元のデータは消えます。

「--linked」とか「--db-url」フラグを一緒につけると、サーバーSupabaseのデータベースも同じようにリセットされます。




SQLファイルをSupabase側から反映させる方法はresetコマンドを使用します。
Supabaseが立ち上がる時にマイグレーションファイルを読み込みます。

#サーバー
supabase gen types typescript --project-id [Reference ID] > types/types_db.ts

※[Reference ID] Supabaseの Reference ID を入力します。

publicの場合 --schema オプションは省略できます。
`--schema public`

成功すると型ファイルが生成されます。



#ローカル
supabase gen types typescript --local --schema public > types/types_db.ts
supabase gen types typescript --local > types/types_db.ts

supabase gen types typescript --local > types/types_db.ts



supabase db diff
supabase migration new
supabase migration list

supabase db dump --data-only -f supabase/seed.sql

# ローカルの設定をサーバーに反映させるコマンド
supabase push

# Supabase サーバーのダッシュボードからの変更がある場合に取り入れます。
supabase pull


# package.jsonスクリプト
pnpm run dev
pnpm db:generate
pnpm db:migrate
pnpm db:push
pnpm db:studio
pnpm db:seed

# Stopコマンドで現在のデータは保存されます。
# バックアップはDBeaver(外部DBツール)を利用します。

# 直接Drizzleコマンドを実行
npx drizzle-kit generate
npx drizzle-kit push
npx drizzle-kit migrate
npx drizzle-kit pull

# package.json script
pnpm db:generate
pnpm db:migrate
pnpm db:seed
pnpm db:studio

```

※`npx drizzle-kit pull` は `npx drizzle-kit introspect` のエイリアスです。



Supabase CLI | Supabase Docs

https://supabase.com/docs/guides/cli/getting-started?queryGroups=platform&platform=windows






# URL

## ローカル

Next.jsアプリ
http://localhost:3000

Storybook
http://localhost:6006/

ローカルの Supabase
http://127.0.0.1:54323/project/default



## サーバー

Supabaseダッシュボード
Dashboard | Supabase
https://supabase.com/dashboard/projects

Vercelダッシュボード
https://vercel.com/dashboard

公開サイト
Next.js and Supabase Starter Kit
https://vns-masakinihirota.vercel.app/



## package.jsonのscript

※ package.jsonのscriptを自分なりに使いやすいように整理します。

各CLIをインストールしているので、直接実行するので、不要なscriptを削除したいと思います。



----------------------------------------

# 作業の流れ

## 設計書を書く

Webアプリmasakinihirotaの設計書

## タスクリストを作る

AIに設計書から実装するタスクに分解してもらい、そのタスクをリスト化したもの。

Webアプリなのでコンポーネント、ページ単位で作業を分割してもらう。
その作業をタスクとして扱い、タスクリストを作る。

進捗管理も兼ねます。



# 実装方法

設計書をタスクリストに機能ごとにタスク分解してタスク化を行い登録します。

タスクをステップに分けて段階的に実装してきます。

その人の価値観を知るサイトmasakinihirotaというウェブサイトを作ります。

Next.jsSupabaseで作ります。

その人の好きな作品を登録してもらい。

どのくらい好きかを絶対相対評価で決めます。

絶対相対評価とは一番好きな作品を一つ選び、それを絶対評価として1番目に置きます。

2番目からは1番好きな作品と同じか、少し下がるかとの評価を決めます。

一番好きな作品をティア１として２番めはティア２に入れます３番目はティア３４番意向は「普通・もしくは自分に合わない作品」として分類します。

それを表示するページを作ります。

機能は評価した作品のリストと、作品を登録するページに飛ぶリンクと、作品を評価、分類するティアをリストに添えます。

評価の変更をすれば、それに合わせてティアは自動で移動します。



第三版 VSCode の Rules for AI 全体のルール設定 #githubcopilot - Qiita
https://qiita.com/masakinihirota/items/fa7854f30e6c657d0cda

便利なMCP 2025年4月版 (もう古いコードの提案はしなくなるMCP他) #Supabase - Qiita
https://qiita.com/masakinihirota/items/8971aa8ccead3193e77f



## VNS masakinihirotaのテンプレートの作成

Webアプリmasakinihirotaを作ります。

### プロジェクト全体の設計

プロジェクトを作成するために、
複数のリポジトリにそれぞれ役割を与えて管理しやすくします。

### リポジトリの役割

Webアプリで必要な
* 設計書 リポジトリ
* Webアプリ本体 リポジトリ
* GitHub Copilotへの指示書 リポジトリ
* ドキュメント リポジトリ
* サンプル、資料置き場

👆これらのリポジトリを、
VSCodeのワークスペースで一つにまとめます。
GitHub Copilotはワークスペース全体をみてくれます。




### アプリ本体 リポジトリ

アプリ本体のコードが置いてあります。
Next.js等を利用しています。

masakinihirota/vns-masakinihirota
https://github.com/masakinihirota/vns-masakinihirota



### GitHub Copilotへの指示書 リポジトリ

GitHub Copilotへの指示書

masakinihirota/vns-masakinihirota-custom-instructions
https://github.com/masakinihirota/vns-masakinihirota-custom-instructions

このリポジトリには、
* GitHub Copilotへの指示書
* 設計書から作成したタスクリスト
* タスクリストから作成したプロンプトファイル
* タスクリストを使った進捗管理
の役割があります。

設計書を元に、開発に必要なタスクをリストアップします。
タスクは、機能単位や工程単位で細かく分割します。
進捗管理を同時に行います。

#### GitHub Copilotへの指示書

プロジェクト全体への指示書です。
このプロジェクトの統一されたルールです。

#### タスクリスト

設計書から作成したリストです。

#### プロンプトファイル

機能ごとに実装するための、GitHub Copilotへの指示書です。
機能を実装する事に作成する必要があります。

### Webアプリの設計書 リポジトリ

アプリの目的、機能、技術スタック、データベース設計、API設計、画面遷移図等

masakinihirota/vns-masakinihirota-design
https://github.com/masakinihirota/vns-masakinihirota-design



### ドキュメント リポジトリ

Webアプリのドキュメント

※重要
このプロジェクトにおいて、このドキュメントに書かれたことが最も優先されます。

masakinihirota/vns-masakinihirota-doc
https://github.com/masakinihirota/vns-masakinihirota-doc



### サンプル リポジトリ

GitHub Copilotに読んでもらうサンプル
その他の資料などを置きます。

masakinihirota/vns-masakinihirota-sample
https://github.com/masakinihirota/vns-masakinihirota-sample

※プライベートリポジトリは表示されません



----------------------------------------
----------------------------------------


# 土台の作成

テンプレート

Supabase UI Libraryを利用して土台を作ります。

👇 ソーシャルログインの実装

Social Authentication
https://supabase.com/ui/docs/nextjs/social-auth

```terminal
pnpm dlx shadcn@latest add https://supabase.com/ui/r/social-auth-nextjs.json

```

##Supabaseのインストール

```terminal
supabase init

```

## アイコン

```terminal
pnpm add react-icons

```



----------------------------------------

# 採用技術

## フロントエンド
- **Next.js**: Reactベースのフレームワーク。サーバーサイドレンダリングや静的サイト生成が可能。
- **React**: ユーザーインターフェースを構築するためのJavaScriptライブラリ。
- **Shadcn/UI**: UIコンポーネントライブラリ。Radix UIと統合して使用。
- **Radix UI**: アクセシブルでカスタマイズ可能なUIコンポーネント。
- **Tailwind CSS**: ユーティリティファーストのCSSフレームワーク。レスポンシブデザインを簡単に実装。

## バックエンド
- **Node.js**: JavaScriptランタイム。サーバーサイドのスクリプトを実行。
- **Supabase**: オープンソースのFirebase代替。リアルタイムデータベースや認証機能を提供。
- **Drizzle ORM**: 型安全なORM。データベーススキーマを定義し、型安全なクエリを記述。
- **Hono**: 高速なWebフレームワーク。APIサーバーとして使用。

## 状態管理
- **Zustand**: 軽量でスケーラブルな状態管理ライブラリ。
- **TanStack Query**: データのフェッチ、キャッシュ、同期を行うライブラリ。

## テスト

### テストの種類

1. **ユニットテスト**: 個々の関数やコンポーネントが正しく動作するかを確認します。
2. **統合テスト**: 複数のコンポーネントが連携して正しく動作するかを確認します。
3. **エンドツーエンドテスト**: 実際のユーザーの操作をシミュレーションし、システム全体が正しく動作するかを確認します。

### テストツール

- **Vitest**: 高速なユニットテストフレームワーク。TypeScriptに対応しており、簡単に設定できます。
- **Jest**: 豊富な機能を持つテストフレームワーク。スナップショットテストやモック機能が充実しています。

### 関連するTips

- テストを書く際は、シンプルで明確なテストケースを心がけましょう。
- テスト駆動開発（TDD）を取り入れることで、より堅牢なコードを作成できます。
- 継続的インテグレーション（CI）ツールを使用して、自動的にテストを実行する環境を整えましょう。

## バリデーション
- **Zod**: 型安全なスキーマバリデーションライブラリ。

## 支払い処理
- **Stripe**: 支払い処理とサブスクリプション管理を行うサービス。

## その他
- **Vercel**: Next.jsアプリケーションのホスティングプラットフォーム。
- **GitHub**: ソースコード管理とバージョン管理を行うプラットフォーム。
- **DBeaver**: データベース管理ツール。
- **pgAdmin 4**: PostgreSQLデータベースの管理ツール。

これらの技術を組み合わせて、効率的でスケーラブルなWebアプリケーションを構築します。



----------------------------------------

# 環境変数の設定

Supabase の環境変数の作成
Stripe の環境変数の作成
Google認証の環境変数の作成
GitHub認証の環境変数の作成
匿名認証の環境変数の作成

をそれぞれ作成します。

----------------------------------------

## Google認証

Googleダッシュボード

https://console.cloud.google.com/home/dashboard

GoogleのOAuth認証情報の取得


Google Cloud Platformで新しいプロジェクトを作成します。

Web を選択

Web アプリケーションの場合、サインイン ボタンを次の2つの方法で設定できます。

* ボタンには独自のアプリケーション コードを使用します。
* Google のあらかじめ構築されたログイン フローまたはワンタップ フローを使用します。



```config.toml
[auth.external.google]
enabled = true
client_id = "env(GOOGLE_CLIENT_ID)"
secret = "env(GOOGLE_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = "http://localhost:54321/auth/v1/callback"

```






### Google Auth Platformの作成

1. Google Cloud PlatformのAPIとサービスライブラリにアクセスします。

👇Google Cloud Platform にアクセスします。
https://console.cloud.google.com/

必要に応じてGoogle Cloud Platformにログインします。
複数アカウントがある場合は、使用するアカウントを選択します。
Google Cloudでプロジェクトの作成を行います。
上部にプロジェクトを作成する場所があります。

青い「新しいプロジェクト」
👆ボタンを押します。

「作成」ボタンを押します。

トップメニューで、作成したプロジェクトが選択されていることを確認してください。表示されていない場合は、プロジェクト一覧から選択してください。

ダッシュボードへ行きます。


2. Google Auth Platform

OAuthの概要

Google Auth Platform はまだ構成されていません
アプリケーションの ID を構成すること、および Google API の呼び出しと Google でログインのための認証情報を管理することを開始します。

同意画面の設定ページ
https://console.cloud.google.com/apis/credentials/consent
「開始」ボタンを押します。

1.
* アプリの情報
アプリ名の入力

* ユーザーサポートメール
ドロップダウンメニューから選択

をそれぞれ登録します。

次へ

2.
* 対象
User Typeを選択します。
外部

Google アカウントを持つすべてのテストユーザーが使用できます。アプリはテストモードで起動し、アプリを使用できるのは、テストユーザーのリストに追加されたユーザーに限られます。アプリを本番環境に移す準備ができたら、アプリの確認が必要となる場合があります。 ユーザーの種類の詳細

次へ

3.
* 連絡先情報
メールを入力

4.
終了

同意
をチェックします。

続行

作成
ボタンを押します。

### OAuthクライアントの作成

OAuth の概要 – Google Auth Platform – masakinihirota – Google Cloud コンソール
https://console.cloud.google.com/auth/overview

👆TOP画面から

画面右のOAuthの概要
指標
このプロジェクトの OAuth クライアントはまだ構成されていません。
OAuthクライアントを作成 <<<ボタンを押します。

API 認証情報ページに移動します。

* アプリケーションの種類
ウェブアプリケーション

* 名前
masakinihirota

Supabaseのローカル環境のOAuth認証のGoogle設定

承認済みの JavaScript 生成元には、アプリのURLを入力します。
承認済みのリダイレクト URIには、apiのコールバックを受け取るAPI URLを入力します。

今回の例では
アプリはローカルとサーバーに作り、
ローカルは開発環境
サーバーは実運用

ローカルはDockerでSupabaseを立ち上げ
サーバーはVercelにデプロイした時にもらえるURL、もしくは自分で設定した独自ドメイン。

コールバックは認証する
サーバーはアプリのURL＋コールバック
http://<PROJECT_ID>.supabase.co/auth/v1/callback
のような形になります。



設定例

### サーバー、ローカル

* 承認済みのリダイレクト URI

サーバー
https://puqapokjzmloymkjvvoi.supabase.co/auth/v1/callback
ローカル
http://localhost:54321/auth/v1/callback


👆自分の環境にあった設定をします。
一つの 承認済みのリダイレクト URI にサーバーとローカルの2つの設定をします。分けてOAuth 2.0 クライアント IDを作る必要はありません。


作成ボタンを押します。

5分程かかります。

OAuth アクセスは、OAuth 同意画面に表示されているテストユーザー に制限されます。

これらの設定が終わるとクライアントIDとクライアントシークレットが表示されます。

クライアントID
*****
クライアントシークレット
*****

JSONをダウンロード
もしくはメモをしておきます。

## Supabaseのサーバーの設定

クライアントIDとクライアントシークレットを
Supabase ダッシュボードの Google Auth Provider セクションに追加します。

## Supabaseのローカルの設定

クライアントIDとクライアントシークレットを
config.tomlファイルに追加します。
.env.* 環境変数を使用します。

環境変数ファイルに追加

.env
.env.local
などに追加します。

```.env.local
GOOGLE_CLIENT_ID="*****"
GOOGLE_SECRET="*****

NEXT_PUBLIC_SUPABASE_URL="http://127.0.0.1:54321"
NEXT_PUBLIC_SUPABASE_ANON_KEY="*****"

```

接頭辞 NEXT_PUBLIC_ をつけると環境変数がクライアント(ブラウザ)から見れるようになります。

## Google の事前構築済み構成

Google Cloud コンソール
同意画面の設定ページに移動します。
アプリのプライバシー ポリシーと利用規約へのリンクを必ず追加してください。

👇API 認証情報ページに移動します。

認証情報 – API とサービス – Google Cloud コンソール
https://console.cloud.google.com/apis/credentials

認証情報の設定が完了すると、クライアントIDが表示されます。

これをSupabaseダッシュボードのGoogleAuthProviderセクションのClientIDsフィールドに追加します。

OAuthクライアントIDとシークレットは空白のままにしておきます。

Googleの事前構築されたアプローチを使用する場合は、これらは必要ありません。



Authentication | Supabase
https://supabase.com/dashboard/project/_/auth/providers

Setting up Server-Side Auth for Next.js | Supabase Docs
https://supabase.com/docs/guides/auth/server-side/nextjs




```config.toml
[auth]
enabled = true
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
# site_url = "http://127.0.0.1:3000"
site_url = "http://localhost:3000"

# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
# additional_redirect_urls = ["https://127.0.0.1:3000"]
additional_redirect_urls = ["http://localhost:3000"]

```

※Supabaseの再起動
※ローカルサーバーの再起動
ファイルや、フォルダを追加したり編集すると、再起動したほうが正常に動くパターンが多いため。




### 参考

Login with Google | Supabase Docs
https://supabase.com/docs/guides/auth/social-login/auth-google

話題のSupabaseでサクッとGoogle認証機能をつくってみた！ #React - Qiita
https://qiita.com/kaho_eng/items/a37ff001ea9eae226183

【Supabase】ローカル開発でOAuthの処理に苦しめられたので解決策のメモ書きを残します
https://zenn.dev/masa5714/articles/8922dfb9e0c9ff


----------------------------------------

# GitHub認証

## GitHubで 認証を設定

ローカル設定

Application name
vns-masakinihirota

Homepage URL
http://127.0.0.1:3000

Authorization callback URL
http://localhost:54321/auth/v1/callback

※callback URL はlocalhostと設定します。
127.0.0.1:54321
192.168.2.1:54321
ではエラーになります。



### 環境変数

ローカル設定

```config.toml
[auth.external.github]
enabled = true
client_id = "env(GITHUB_CLIENT_ID)"
secret = "env(GITHUB_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = "http://localhost:54321/auth/v1/callback"

```

.envファイルに追記します。

```.env
...
GITHUB_REDIRECT_URI="http://localhost:54321/auth/v1/callback"
GITHUB_CLIENT_ID="Ov*****"
GITHUB_SECRET="e1*****"

BASE_URL=http://localhost:3000

```

独自ドメイン(未設定)
https://masakinihirota.com/

Vercelの付与されたURI
vns-masakinihirota.vercel.app

ローカル開発環境
http://192.168.1.2:3000


Vercelとローカル開発環境で切り分けたい
将来独自ドメインでもスムーズに移行したい場合


----------------------------------------



## 人間の判断

匿名認証の利用者が多くなったら設定するつもり。
Enable CAPTCHA Protection | Supabase Docs
https://supabase.com/docs/guides/auth/auth-captcha

## GitHubのOAuth認証情報の取得

## サーバー
Login with GitHub | Supabase Docs
https://supabase.com/docs/guides/auth/social-login/auth-github?queryGroups=environment&environment=server

## ローカル
Local development with schema migrations | Supabase Docs
https://supabase.com/docs/guides/local-development/overview#use-auth-locally



----------------------------------------

## 匿名認証

Google認証、GitHub認証を参考に
AIで作成



# 人との判別

Cloudflare Turnstile demo: Sample Form with Cloudflare Turnstile
https://2captcha.com/demo/cloudflare-turnstile

Enable CAPTCHA Protection | Supabase Docs
https://supabase.com/docs/guides/auth/auth-captcha?queryGroups=captcha-method&captcha-method=hcaptcha-1



----------------------------------------

## 環境変数のファイル

ローカル開発環境
`.env.local`
本番環境
`.env`

```.gitignore
# env files
.env*
.env*.local
.env*.production

```

```.env.local
# Supabase
NEXT_PUBLIC_SUPABASE_URL="http://127.0.0.1:54321"
NEXT_PUBLIC_SUPABASE_ANON_KEY="*****"
# Google OAuth
GOOGLE_CLIENT_ID="*****"
GOOGLE_SECRET="*****"
# GitHub OAuth
GITHUB_CLIENT_ID="*****"
GITHUB_SECRET="*****"

```

利用したい👆OAuth認証の分を用意します。



----------------------------------------

# Supabaseの設定(ローカル)

## Supabase のルール for AI

AI Prompts | Supabase Docs
https://supabase.com/docs/guides/getting-started/ai-prompts

### 使い方

リポジトリ内の.githubフォルダ内に置きます。

GitHub Copilot `#<filename>` で指定できます。

👆GitHub Copilotは「#」記号でファイルを指定できます。

## 環境変数

```.env.local
GOOGLE_CLIENT_ID=YOUR_CLIENT_ID
GOOGLE_SECRET=YOUR_CLIENT_SECRET

```


## Tips

<details><summary>Tips Supabase</summary>

Supabaseをローカルで動かすと重くなりすぎちゃう問題を解決する【Windows勢向け】
https://zenn.dev/masa5714/articles/3b5ea07c15f159


開発中は使わない機能を切っておくことで、PCが軽くなる場合があります。

例えば、↓リアルタイム、inbucket（メール）、ストレージ
のenabledの項目をfalseで切っておきます。

設定例

```supabase\config.toml
[realtime]
enabled = false

・・・

[inbucket]
enabled = false

・・・

[storage]
enabled = false

```

</details>



----------------------------------------

# Supabaseの設定(サーバー)

ウェブ上でSupabaseのプロジェクトを作ります。

## Supabaseのプロジェクトとリンク

```terminal
supabase link
supabase db push

```

## Vercel と Supabase の連携

### Supabaseの環境変数

Vercelのマーケットプレイス

Supabase for Vercel
https://vercel.com/marketplace/supabase

👆VercelのマーケットプレイスにSupabaseがあるので
インストールすると
Supabaseのプロジェクトと繋がり、
環境変数の設定を自動でしてくれます。

Vercel の画面で、 Settings > Integrations > Browse Marketplace ボタンを押す。
Supabase を検索し連携を行います。

Supabaseの環境変数がVercelにコピーされます。

👇インストールされている環境変数のリスト

```vercel 環境変数
POSTGRES_URL
POSTGRES_PRISMA_URL
POSTGRES_URL_NON_POOLING
POSTGRES_USER
POSTGRES_HOST
POSTGRES_PASSWORD
POSTGRES_DATABASE
SUPABASE_SERVICE_ROLE_KEY
SUPABASE_ANON_KEY
SUPABASE_URL
SUPABASE_JWT_SECRET
NEXT_PUBLIC_SUPABASE_ANON_KEY
NEXT_PUBLIC_SUPABASE_URL

```



## サーバーの認証設定

Supabaseに戻ります。

プロジェクトの「Authentication」→「Sign In/Up」で
メール
Google
GitHub
有効化(Enable)にします。

👆必要な認証を許可します。

----------------------------------------

## サーバーとのマイグレーションの差が出たときの修正

Supabaseのマイグレーション
サーバー側の適用方法

↓REMOTE（サーバー）側への適用方法

```terminal
supabase migration repair 20230618024722 --status applied
supabase migration repair 20231017082823 --status applied

```

Supabaseのマイグレーション
ローカル側の削除方法
マイグレーションのファイルを消すだけ

↓REMOTE（サーバー）側の削除方法

```terminal
supabase migration repair 20231017052010 --status reverted
supabase migration repair 20231017082823 --status reverted

```



## Supabaseのバックアップ

```terminal
#スキーマのみ
supabase db dump -f supabase/schema.sql

#データのみ
supabase db dump -f supabase/seed.sql --data-only

```

データの保存、バックアップはデータベース管理ツールを使用します。

----------------------------------------

# Supabase

※開発で利用するSupabaseはWeb上のサーバーと、
Docker Desktopで立ち上げたのと2種類あります。
これらを便宜上サーバー、ローカルと呼びます。

Docker Desktopを利用して
ローカル環境にSupabaseを導入します。

## Supabaseの公式ドキュメントと記事

Local Dev with CLI | Supabase Docs

https://supabase.com/docs/guides/cli

## 参考

Supabase ローカル開発環境 ＋ サーバー運用 2023年9月 (with Next.js 13 App router) #Docker - Qiita

https://qiita.com/masakinihirota/items/be94b4c74a7850a4b79c

Supabase ローカル開発環境 ＋ リモートサーバー #PostgreSQL - Qiita

https://qiita.com/masakinihirota/items/f12d16c31e6775f26b84

Next.js 13 App router と Supabase での４つのアクセス方法 #Next.js - Qiita

https://qiita.com/masakinihirota/items/b4b168a056dc10776d87

Supabase Auth スキーマ と そのテーブルの詳細 #PostgreSQL - Qiita

https://qiita.com/masakinihirota/items/7f65f732ecbafbd5cb00

















----------------------------------------

## git開発ブランチ

main		メイン
dev			開発

devで開発してチェックしてエラーがなく、ビルドが通ったらmainにマージして
mainはgithubへpushします。

これはhuskyを使うと半自動化されます。
重要な決定は人間の手で、それ以外は自動化にします。



## GitHubへpush

GitHubにリポジトリを作成します。




----------------------------------------

#  デプロイ先候補

Vercel
Cloudflare Workers

# Vercel

## VercelでGitHubと連携

Vercelのアカウントを作って、GitHubのリポジトリと接続します。

## Vercel CLI のインストール

Vercel CLI Overview

https://vercel.com/docs/cli

```terminal
# インストール
npm i -g vercel
vercel --version
vercel link

```

## アプリをVercelにデプロイ

VercelとGitHubのリポジトリをリンクさせることで
GitHubにプッシュしたと同時にVercelにもデプロイされます。
## 環境変数の設定

Vercelに登録された環境変数をローカルにも反映する。

```terminal
vercel env pull

```

👆Vercelに登録されているアプリの環境変数をローカルに保存します。

.env.localファイルが作成されます。
既存のファイルがあると上書きするか聞いてきます。



## Vercelでのビルド

コードとその環境変数がきちんと設定されていると
ビルドが通ります。

Vercelのプロジェクトを開きDomainsを見てみると
アプリの公開しているURLが表示されています。

これでもうすでに自分のアプリが世界に公開されている状態になっています。

これでコードとDBと公開の基礎的な部分は、完了しました。
あとは機能を追加していくだけです。






----------------------------------------

# Drizzle ORM

Drizzle ORM - PostgreSQL

https://orm.drizzle.team/docs/get-started/supabase-new

Drizzle | Supabase Docs

https://supabase.com/docs/guides/database/drizzle

```termina
pnpm add drizzle-orm postgres dotenv
pnpm add -D drizzle-kit tsx

#bun のインストール
powershell -c "irm bun.sh/install.ps1|iex"

```

※Drizzleではコードの実行にbunを推奨しています。



.envファイルの追加

```.env
# Drizzleの環境変数
# ローカルのSupabaseへの接続用
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres

```

## スキーマファイル用のフォルダの作成

```
lib
└── drizzle
    ├── schema
    │   └── schema.ts
    ├── drizzle.ts
    ├── queries.ts
    └── seed.ts

```

## Drizzle設定ファイル

`drizzle.config.ts` をrootに置きます。

```drizzle.config.ts Supabase UI用
import { config } from "dotenv";
import { defineConfig } from 'drizzle-kit';
config({ path: ".env" });

export default defineConfig({
    // フォルダ内にあるスキーマファイルを読み込む
    schema: './schema',
    // Supabase へのマイグレーションファイルを出力するディレクトリ
    out: "./supabase/migrations",
    dialect: "postgresql",
    dbCredentials: {
      url: process.env.POSTGRES_URL!,
    },
});

```

```drizzle.config.ts スターター用

import { config } from "dotenv";
import { defineConfig } from "drizzle-kit";
config({ path: ".env" });

export default defineConfig({
  // フォルダ内にあるスキーマファイルを読み込む
  schema: './lib/db/schema',
  // Supabase へのマイグレーションファイルを出力するディレクトリ
  out: "./supabase/migrations",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});

```

# Drizzle DBクライアント

Supabaseはpoolerをfalseに設定します。

```Drizzle DBクライアント Supabase(サーバー)用
import 'dotenv/config'

import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

const connectionString = process.env.DATABASE_URL

// Disable prefetch as it is not supported for "Transaction" pool mode
export const client = postgres(connectionString, { prepare: false })
export const db = drizzle(client);

```



## スキーマファイルの例

```schema.ts
import { pgTable, serial, text, varchar } from "drizzle-orm/pg-core";
export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  fullName: text('full_name'),
  phone: varchar('phone', { length: 256 }),
});

```



# Drizzleの基本的な使用手順

スキーマファイルの登録場所
`./schema\*.ts`
ここにスキーマファイルを作成します。

Drizzleのスキーマファイル(*.ts)を編集します。
このTypeScriptのコードからSQL文を生成してマイグレーションファイルに保存。
マイグレーションファイルをpushでSupabaseに反映させます。

## 実際の手順

スキーマファイルの新規作成、編集します。

スキーマファイルが完成したら

```terminal
npx drizzle-kit generate

```

👆スキーマファイル(*****.ts)ファイルからマイグレーションファイル(純正なSQL文)を作ります。

👇スキーマファイルからSupabaseに反映させる方法。
2種類あります。

```terminal
# 記録、履歴が残らない方法
npx drizzle-kit push

# 記録、履歴が残る方法
npx drizzle-kit migrate

```

のどちらかでSupabaseに反映させます。

開発中は何度も気軽に変更できる `push`を使用します。即反映。
本番運用中は変更記録を保存する `migrate`を使用します。ちょっと時間がかかる。
と使い分けます。

* マイグレーションファイルを新しく作る方法

```terminal
# Drizzleの場合
npx drizzle-kit generate

# Supabaseの場合
supabase migration new [Name]

```



# drizzle-kit コマンド一覧

`npx drizzle-kit` コマンドは、Drizzle ORM のためのツールキットです。以下は各コマンドの説明です。

ヘルプコマンド

`npx drizzle-kit -h`

```terminal
drizzle-kit [command]

#👇commandリスト
generate: マイグレーションファイルを生成します。
migrate: マイグレーションを実行します。
push: スキーマの変更を直接データベースに適用します。
studio: Drizzle Studio を起動します。
drop: 指定したマイグレーションファイルを削除して、連動しているスナップショットも更新します。


check: マイグレーションの状態を確認します。

introspect: データベースのスキーマを調査します。

up: スナップショットを新しいバージョンにアップグレードするために使用されます。

```



# RLS

	未完成

開発中は特にAIを用いての開発は
RLSを有効にしないほうがいいです。

設定は最後にします。



----------------------------------------

huskyの


# husky チェック

## husky のインストール

```terminal
pnpm add -D husky lint-staged
npx husky init

touch .husky/pre-commit
touch .husky/pre-push

```

```package.json
...
  "scripts": {
    ...
    "prepare": "husky"
  }

...
  "lint-staged": {
    "*.{ts,tsx}": "pnpm check"
  }

```

※lint-stagedはコミット前にBiomeを実行しています。



## コミット時の自動実行

```.husky/pre-commit
npx lint-staged

```


## プッシュ時の自動実行

githubへのpushの前にbuildを実行します。

```.husky/pre-push
pnpm run build

```

これでエラーがあるとビルドが通らず、pushできなくなります。

pre-commit機能でgitにコミットする前にlintチェック等をします。
pre-push機能でgithubにpushする前にビルドします。



----------------------------------------

# Biome 整形

## CLI

はじめる | Biome
https://biomejs.dev/ja/guides/getting-started/

```terminal
pnpm add --save-dev --save-exact @biomejs/biome
pnpm biome init

```



## 設定

スターターでエラー、警告が出てきたものをoffに設定。

```biome.json
{
  "$schema": "https://biomejs.dev/schemas/1.9.4/schema.json",
  "vcs": {
    "enabled": false,
    "clientKind": "git",
    "useIgnoreFile": false
  },
  "files": {
    "ignoreUnknown": false,
    "ignore": []
  },
  "formatter": {
    "enabled": true,
    "formatWithErrors": false,
    "ignore": [],
    "indentStyle": "space"
  },
  "organizeImports": {
    "enabled": true
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "double"
    }
  },
  "json": {
    "parser": { "allowComments": true },
    "formatter": {
      "enabled": true,
      "indentStyle": "space",
      "lineWidth": 80
    }
  },
  "linter": {
    "ignore": [],
    "rules": {
      "recommended": true,
      "suspicious": {
        "noExplicitAny": "off",
        "noArrayIndexKey": "off"
      },
      "style": {
        "noNonNullAssertion": "off",
        "useSelfClosingElements": "off",
        "noUnusedTemplateLiteral": "off",
        "useImportType": "off",
        "noUselessElse": "off"
      },
      "a11y": {
        "useButtonType": "off"
      },
      "correctness": {
        "useExhaustiveDependencies": "off",
        "noSwitchDeclarations": "off"
      },
      "complexity": {
        "noForEach": "off"
      }
    }
  }
}

```

### エラー、警告の解除方法

Biomeの場合
エラーが出た時に、そのエラーをoffにしたい時は
そのルール名が同時に表示されるので、
`biome.json` のその場所に適したルールを
追加して"off"に設定します。

例
VSCodeではエラーメッセージに
`linter/complexity/noForEach`
のようにでてくるので

```biome.json
...
  "linter": {
...
      "complexity": {
        "noForEach": "off"
      }
  }

```

のように追加します。



## チェック

package.jsonにスクリプトの追加
appとcomponentsフォルダが対象の場合

```package.json
    "lint": "biome lint --write app lib components",
    "format": "biome format --write app lib components",
    "check": "biome check --write app lib components"

```



### 1ファイルをチェックする使い方

```
pnpm biome check --write <files>

```

### まとめてチェックする使い方

```terminal
pnpm lint
pnpm format
pnpm check

```

### check コマンド

複数のツールを一度に実行するためのコマンドです。現在は以下のことを行います。

ファイルのフォーマット
ファイルのリント
インポートの整理

## VScodeの拡張機能

マーケットプレイスからBiomeを探します。

```settings.json
"editor.codeActionsOnSave": {
  "quickfix.biome": true,
  "source.organizeImports.biome": true
},
"editor.defaultFormatter": "biomejs.biome",
"[typescript]": {
   "editor.defaultFormatter": "biomejs.biome"
},

```

※👆の設定の場合、言語ごとに設定をします。


<details><summary>Biomeのルール</summary>

https://zenn.dev/ako/articles/b8a686843f6b83

```

"rules": {
      "a11y": {
        "noAriaUnsupportedElements": "error", // ARIAの役割、状態、およびプロパティをサポートしない要素には、これらの属性がないことを強制
        "noBlankTarget": "error", // target="_blank"を使う時、rel=“noreferrer”を強制
        "noDistractingElements": "error", // 存在しない要素でエラー
        "noNoninteractiveElementToInteractiveRole": "error", // インタラクティブなARIAロールが非インタラクティブHTML要素に割り当てられないように
        "noPositiveTabindex": "error", // tabIndexで整数使うとエラー
        "noRedundantAlt": "error", // 暗黙的なロールでのroleの使用でエラー
        "useAltText": "error", // alt必要な要素で強制
        "useAriaPropsForRole": "error", // ARIAロールで必須のARIA属性を強制
        "useHtmlLang": "error", // HTMLのlangを使う
        "useIframeTitle": "error", // iframeでtitleを強制
        "useMediaCaption": "error", // audio, video要素で、track要素を強制
        "useValidAnchor": "error", // すべてのアンカーが有効である
        "useValidAriaProps": "error", // 正しいaria-*を使う
        "useValidAriaValues": "error", // 正しいARIAを使う
        "useValidLang": "error" // lang属性で正しい言語・国を使う
      },
      "complexity": {
        "noBannedTypes": "warn", // 誤解を招く型でエラー
        "noExtraBooleanCast": "error", // 無駄なBooleanでエラー
        "noForEach": "warn", // forEachでエラー。for ofを使う
        "noMultipleSpacesInRegularExpressionLiterals": "error", // 正規表現の連続スペースでエラー
        "noStaticOnlyClass": "error", // staticだけのclassでエラー
        "noUselessConstructor": "error", // 無駄なconstructorでエラー
        "noUselessRename": "error", // 無駄な as でエラー
        "noUselessSwitchCase": "error", // 無駄なswitchのcaseでエラー
        "useLiteralKeys": "error", // オブジェクトで、 a[b]ではなく、a.bを使う
        "useOptionalChain": "error", // オプショナルチェーンを使うようにする
        "useSimplifiedLogicExpression": "error" // 無駄な論理式でエラー出す 例） const bool =  true || foo
      },
      "correctness": {
        "noChildrenProp": "error", // コンポーネントのchildrenをPropsで渡すとエラー
        "noConstAssign": "error", // constを再代入でエラー
        "noConstantCondition": "error", // 条件式の中身が定数でエラー（確定するから）
        "noEmptyPattern": "error", // 空のオブジェクトを禁止 const {} = a, const {a: {}} = foo
        "noPrecisionLoss": "error", // 桁数の多すぎる数字でエラー（制度が落ちる）
        "noRenderReturnValue": "error", // ReactDOM.renderの代入を許可しない const foo = ReactDOM.render()
        "noSelfAssign": "error", // a = aを許可しない
        "noSetterReturn": "error", // classのsetメソッドが値を直接返すのを禁止
        "noStringCaseMismatch": "error", // 違う文字のCaseとの比較でエラー 例）toUpperCaseした文字と、そうでない文字との比較
        "noUnnecessaryContinue": "error", // ループ文の最初でcontinueするとエラー
        "noUnreachable": "error", // 到達不可能なコードでエラー
        "noInvalidConstructorSuper": "error", // extendsしてたらconstructorでsuperを強制
        "noUnsafeOptionalChaining": "error", // 安全でないオプショナルチェーンでエラー
        "noUnusedVariables": "warn", // 未使用の変数でエラー
        "noVoidElementsWithChildren": "error", // childrenの無い要素に入れるとエラー
        "noVoidTypeReturn": "error", // 返り値がvoid型の関数が、returnするとエラー
        "useIsNan": "error", // NaNを比較するとエラー
        "useValidForDirection": "error" // forループで、終了しない条件だとエラー
      },
      "performance": {
        "noDelete": "error" // delete演算子使うとエラー
      },
      "security": {
        "noDangerouslySetInnerHtml": "warn" // dangerouslySetInnerHTML禁止
      },
      "style": {
        "noArguments": "error", // 定義してない変数使うとエラー
        "noNegationElse": "warn", // 条件で!fooのように書いてelseがあるとエラー
        "noNonNullAssertion": "warn", // foo!.varの書き方でエラー
        "noParameterAssign": "error", // 関数の引数を関数内で更新するとエラー
        "noUnusedTemplateLiteral": "error", // 普通の文字列でテンプレート文字列使うとエラー
        "noVar": "error", // var使うとエラー
        "useConst": "error", // letで再代入されないお変数はエラー、constにする
        "useExponentiationOperator": "error", // 階乗でMath.pow使うとエラー、**に置換
        "useNamingConvention": "off", // snakeCaseでエラー、optionで変えられる
        "useSelfClosingElements": "error", // <div></div>のように子供の無い要素でエラー、<div/>に置換
        "useShorthandArrayType": "error", // 型でArray使うとエラー、[]に置換
        "useTemplate": "error" // 文字の足し算は全てテンプレート文字列にする
      },
      "suspicious": {
        "noArrayIndexKey": "error", // JSXのmapでkeyにindexを渡すとエラー
        "noAssignInExpressions": "error", // 条件式に中で再代入するとエラー
        "noAsyncPromiseExecutor": "error", // new Promise()の中でasync関数使用するとエラー
        "noCatchAssign": "error", // catch(e)のeに再代入するとエラー
        "noClassAssign": "error", // classに再代入するとエラー
        "noCommentText": "error", // JSX内の正しくないコメントでエラー <div>// a</div> => <div>{/* a */}</div>
        "noCompareNegZero": "error", // -0と比較するとエラー
        "noConsoleLog": "warn", // console.logでエラー
        "noDoubleEquals": "error", // 比較で==を禁止、===にする
        "noDuplicateCase": "error", // switchの重複するcaseでエラー
        "noDuplicateClassMembers": "error", // classの重複するメソッドでエラー
        "noDuplicateJsxProps": "error", // コンポーネントの重複するPropsでエラー
        "noDuplicateObjectKeys": "error", // 重複するオブジェクトのkeyでエラー
        "noDuplicateParameters": "error", // 関数の重複するparamsでエラー
        "noEmptyInterface": "error", // 空のinterfaceの定義でエラー
        "noExplicitAny": "warn", // anyの仕様を禁止
        "noExtraNonNullAssertion": "error", // 間違った非nullアサーションでエラー
        "noFunctionAssign": "error", // functionの再代入するとエラー
        "noImportAssign": "error", // importで使う値を再代入するとエラー
        "noPrototypeBuiltins": "error", // エラーの恐れのあるオブジェクトのプロパティでエラー 例 propertyIsEnumerable, isPrototypeOf
        "noRedeclare": "error", // 同じ名前の宣言でエラー
        "noRedundantUseStrict": "error", // use strictが同じファイルで重複するとエラー
        "noSelfCompare": "error", // 同じ値の比較でエラー
        "noShadowRestrictedNames": "error", // 予約語で命名するとエラー
        "noUnsafeDeclarationMerging": "error", // 同じ名前のclassとinterfaceを定義するとエラー
        "useDefaultSwitchClauseLast": "error", // switchでdefaultが最後でないとエラー
        "useGetterReturn": "error", // classのgetメソッドでreturnをしないとエラー
        "useValidTypeof": "error" // typeofで比較する値が正しくないとエラー
      },
      "nursery": {
        "noDuplicateJsonKeys": "error", // JSONオブジェクトで同じkey使うとエラー
        "noEmptyCharacterClassInRegex": "error", // 正規化の[]の中が空だとエラー
        "noExcessiveComplexity": "warn", // 複雑なコード書くとエラー(階層が深くなる)
        "noGlobalIsFinite": "error", // isFiniteでは無く、Number.isFiniteを使う
        "noGlobalIsNan": "error", // isNaNでは無く、Number.isNaNを使う
        "noUselessElse": "warn", // 無駄なelseは早期リターンにする
        "useArrowFunction": "warn", // アロー関数を強制
        "useCollapsedElseIf": "warn", // elseの中の無駄な条件をelse ifに強制する
        "useExhaustiveDependencies": "warn", // useEffect等のHooksの依存配列が正しくないとエラー
        "useGroupedTypeImport": "error", // import {type A, type B}を、import type {A, B}に強制
        "useHookAtTopLevel": "error", // HooksはTopレベルで使わないとエラー
        "useIsArray": "error", // instanceof Arrayではなく、Array.isArray()を強制
        "useShorthandAssign": "error" // 短い書き方を強制 a = a + 1 => a += 1
      }
    }
  }

```

</details>



----------------------------------------

# Hono

Hono - Web framework built on Web Standards
https://hono.dev/docs/

HonoをNext.jsで利用するため調べたメモ(+Supabase) #Drizzle - Qiita
https://qiita.com/masakinihirota/items/a6b8e438a76543819f27

今ホットなHonoを使ってNext.jsのRoute Handlersをハイジャックする
https://zenn.dev/chot/articles/e109287414eb8c


optional Catch-all Segment を使って API ルートを作成します。

インストール

```terminal
pnpm add hono

```

👆honoを追加するだけ



サンプル

app\api\[...route]\route.ts

```route.ts
import { Hono } from 'hono'
import { handle } from 'hono/vercel'

export const runtime = 'edge'

const app = new Hono().basePath('/api')

app.get('/hello', (c) => {
  return c.json({
    message: 'Hello from Hono!'
  })
})

export const GET = handle(app)

```



app\hono\page.tsx

```page.tsx
import { useEffect, useState } from 'react'

export default function Home() {
  const [message, setMessage] = useState()

  useEffect(() => {
    const fetchData = async () => {
      const res = await fetch('/api/hello')
      const { message } = await res.json()
      setMessage(message)
    }
    fetchData()
  }, [])

  if (!message) return <p>Loading...</p>

  return <p>{message}</p>
}

```

サーバーを再起動させて
http://localhost:3000/hono
にアクセスします。
Honoが動作しています。



----------------------------------------

# フォルダ構造の基本

ルーティングとコンポーネントを別々に管理する

フェッチはどっちにするかその時考える。

Next.js App routerでの ルーティングとコンポーネントを別々に管理 #AppRouter - Qiita
https://qiita.com/masakinihirota/items/2695cba68816794e33d3



----------------------------------------

# 共通のレイアウト

app\(unauth)\layout.tsx

## ヘッダーにアプリの作る機能のボタンを並べる

ダークモード
言語
広告
Pricing
Account



----------------------------------------

# ncuの導入 パッケージのアップデート

ncuは現在のバージョンを調べる＆更新してくれるツールです。

npmパッケージのvulnerability対応フロー - Qiita
https://qiita.com/riversun/items/7f1679509f38b1ae8adb

```terminal
# パッケージが最新か確認します。
pnpm outdated

# 全て最新バージョンにアップデートしたい場合は
ncu -u

```


## メジャーかマイナーか、どこまでバージョンアップするのかを選ぶ

### メジャーバージョンまで最新にしたい場合

```terminal
# インストール
npm i -g npm-check-updates

# 全て最新バージョンにアップデートしたい場合は
ncu -u

# としてから、インストールが必要
pnpm install

```

### マイナーバージョンまで最新にする場合

```terminal
pnpm update

```

## もう一度確認する

```terminal
pnpm outdated

# 確認してこれで良いのならインストールをする。
npm install --legacy-peer-deps
pnpm install --legacy-peer-deps

```

----------------------------------------

# i18n 国際化

next-intlで実装

i18nルーティングなしのApp Router設定 – Next.jsの国際化（i18n）
https://next-intl.dev/docs/getting-started/app-router/without-i18n-routing

```terminal
pnpm add next-intl

```

---

言語を切り替えるスイッチ

Examples – Internationalization (i18n) for Next.js
https://next-intl.dev/examples#app-router-without-i18n-routing

next-intl example
https://next-intl-example-app-router-without-i18n-routing.vercel.app/login

## stripeでカスタマーポータルでサポートされている言語

ブルガリア語 (bg)
簡体字中国語 (zh)
繁体字中国語: 香港 (zh-Hant-HK)
繁体字中国語: 台湾 (zh-Hant-TW)
クロアチア語 (hr)
チェコ語 (cs)
デンマーク語 (da)
オランダ語 (nl)
英語、アメリカ (en)
英語、イギリス (en-GB)
エストニア語 (et)
フィンランド語 (fil)
フィンランド語 (fi)
フランス語、フランス (fr)
フランス語、カナダ (fr-CA)
ドイツ語 (de)
ギリシャ語 (el)
ハンガリー語 (hu)
インドネシア語 (id)
イタリア語 (it)
日本語 (ja)
韓国語 (ko)
ラトビア語 (lv)
リトアニア語 (lt)
マレー語 (ms)
マルタ語 (mt)
ノルウェーブークモール語 (nb-NO)
ポーランド語 (pl)
ポルトガル語、ポルトガル (pt)
ポルトガル語、ブラジル (pt-BR)
ルーマニア語 (ro)
ロシア語 (ru)
スロバキア語 (sk)
スロベニア語 (sl)
スペイン語、スペイン (es)
スペイン語、ラテンアメリカ (es-419)
スウェーデン語 (sv)
タイ語 (th)
トルコ語 (tr)
ベトナム語 (vi)



----------------------------------------

# shadcn/ui UI集 ダークモード

Next.js - shadcn/ui

https://ui.shadcn.com/docs/installation/next

## インストール

※スターターに組み込まれています。

```terminal
pnpm dlx shadcn@latest init
# 例: buttonを追加
pnpm dlx shadcn@latest add button

```

後から必要なコンポーネントを追加します。



## ダークモード

Next.js - shadcn/ui
https://ui.shadcn.com/docs/dark-mode/next


Next.js App Router 開発用テンプレートに shadcn/ui でダークモードを実装する。 #DarkMode - Qiita

https://qiita.com/masakinihirota/items/7cf6181ba61fe9dc3802

### インストール

```terminal
pnpm add next-themes
npx shadcn@latest add dropdown-menu

```

```terminal
touch components\theme-provider.tsx

```


----------------------------------------

https://www.shadcnui-blocks.com/

shadcn/uiを活用したブロックやカスタマイズコンポーネントを提供するサードパーティのサイトです。

Navbar 03 - Navbar section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/navbar-03

Hero 01 - Hero section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/hero-01

Footer 05 - Footer section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/footer-05

Features 01 - Features section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/features-01

Timeline 03 - Timeline section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/timeline-03

Testimonial 01 - Testimonial section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/testimonial-01

Testimonial 05 - Testimonial section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/testimonial-05

Pricing 03 - Pricing section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/pricing-03

Team 03 - Team section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/team-03

Logos 02 - Logos section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/logos-02

Contact 01 - Contact section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/contact-01

Stats 01 - Stats section Shadcn UI block
https://www.shadcnui-blocks.com/blocks/stats-01


```terminal

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/navbar-03.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/hero-01.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/footer-05.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/features-01.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/timeline-03.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/testimonial-05.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/pricing-03.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/faq-03.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/team-03.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/logos-02.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/contact-01.json

npx shadcn add https://shadcn-ui-blocks.akashmoradiya.com/r/stats-01.json

```



----------------------------------------

## 追加

左サイドバー

Building Blocks for the Web - shadcn/ui
https://ui.shadcn.com/blocks/sidebar

👆この1番目を採用



----------------------------------------

# ユーザー管理

一般ユーザー
管理者 adminユーザー

# 権限

app
	(auth)
		匿名認証
			人であること
			BOTではない
		OAuth認証
			リーダーのみがアクセス可能
			メンバーがアクセス可能(リーダーもメンバーの一人)

app
	(auth)
		(admin)
			管理者のみアクセス可能

app
	非認証

例
/posts ← 一般ユーザーも閲覧可
/posts/:postId ← 一般ユーザーも閲覧可
/mypage ← 一般ユーザーも閲覧可
/admin-dashboard ← 管理者のみ閲覧可
/admin-settings ← 管理者のみ閲覧可



# 管理者画面

【Next.js】管理者用ページを Route Groups で実現する
https://zenn.dev/chot/articles/next-layout-for-admin-page



「管理者専用ページ」の場合、単にユーザーが存在するだけではなく、そのユーザーが管理者であるかどうかを確認する必要があります。Supabaseでは、ユーザーのロールや権限を確認するために、カスタムクレームやデータベースのユーザーテーブルを使用することが一般的です。

管理者の判断方法
カスタムクレームを使用する方法
SupabaseのJWTトークンにカスタムクレームを追加し、isAdminのようなフラグを含めることができます。これをsupabase.auth.getUser()で取得して確認します。

データベースでロールを確認する方法
ユーザー情報を格納するテーブル（例: users）にroleカラムを追加し、adminやuserなどのロールを設定します。ログイン後にこの情報を取得して確認します。

```
 // ユーザーのロールを確認
  const { data: roleData, error: roleError } = await supabase
    .from("users")
    .select("role")
    .eq("id", userData.user.id)
    .single();

```

管理者専用ページの実装例
以下は、データベースでロールを確認する方法を使用した例です。

ユーザー専用ページの判断方法
現在のProtectedPageの実装では、ユーザーが存在するかどうかのみを確認しています。この方法は、一般的なユーザー専用ページには十分です。ただし、特定の条件（例: 特定のロールや権限）を追加したい場合は、上記のようにデータベースやカスタムクレームを使用して条件を拡張できます。

関連するTips
**SupabaseのRLS（Row Level Security）**を活用すると、データベースレベルでロールや権限を制御できます。これにより、バックエンドでのセキュリティが強化されます。
redirectの使用: リダイレクト先のURLは、環境変数や定数として管理すると、変更が容易になります。
エラーハンドリング: supabase.auth.getUser()やデータベースクエリのエラーを適切にログに記録し、デバッグを容易にしましょう。
頑張ってください！管理者ページの実装は少し複雑ですが、しっかりと権限管理を行うことで安全性が向上します。💪





## 管理者情報

テーブルに管理者情報を格納する場合、既存のカラムを活用するか、新しいカラムを追加する方法があります。以下にそれぞれの方法を説明します。

1. 既存のカラムを活用する方法
候補: role カラム
理由: role カラムは文字列型（varchar）で、ユーザーの役割（例: "admin", "user"）を格納するのに適しています。
実装例:
一般ユーザー: role = "user"
管理者: role = "admin"
メリット
既存のカラムを利用するため、テーブル構造を変更する必要がありません。
シンプルでわかりやすい。
デメリット
role カラムが他の用途で使われている場合、管理者情報と競合する可能性があります。
2. 新しいカラムを追加する方法
候補: is_admin カラム
理由: 管理者かどうかを判定するための専用のブール型カラムを追加します。
実装例:
管理者: is_admin = true
一般ユーザー: is_admin = false
SQLでのカラム追加例
メリット
管理者情報を明確に分離できるため、他の用途と競合しません。
クエリがシンプルになります（例: WHERE is_admin = true）。
デメリット
テーブル構造を変更する必要があります。
3. raw_user_meta_data カラムを活用する方法
理由: raw_user_meta_data は JSONB 型で、柔軟にカスタムデータを格納できます。
実装例:
メリット
テーブル構造を変更せずに柔軟なデータを格納できます。
他のカスタム情報（例: プロフィール情報）も一緒に管理可能。
デメリット
JSONB 型のデータを扱うため、クエリがやや複雑になります。



----------------------------------------

# Drizzleを使ったスキーマ管理

auth.usersは認証のためのテーブルです
Webアプリの管理用としてのユーザーテーブルとしては不適です。
ですのでpublicスキーマにユーザー用のテーブル作成します。

masakinihirotaではルートアカウントがユーザー用のテーブルになります。
テーブルrootAccoutをpublicスキーマに作成します。

## Webアプリ用ユーザー管理

### ルートアカウントテーブルの作成

* 認証
auth.users

👆このテーブルからユーザーデータを👇にコピーします。

* Webアプリ利用ユーザー
public.root_account



## DrizzleとSupabaseのルール

### テーブル名のルール

* Drizzleのテーブル名
キャメルケース (emailConfirmedAt)

* Supabaseのテーブル名
スネークケース (email_confirmed_at)



## Supabaseの認証時にPublicスキーマにユーザーデータをコピーする

認証後に、そのユーザーデータ
auth.users テーブル
から
public.root_account
にコピーします。

```
npx drizzle-kit studio

# SQL文を生成
npx drizzle-kit generate
# Supabaseに反映
## 履歴を残す(本番用)
npx drizzle-kit migrate
## DBを直接変更する(開発用)
npx drizzle-kit push

```

----------------------------------------

# 宣言型データベーススキーマ

Drizzle ORMの代替

Supabaseの宣言型データベーススキーマの実践 #PostgreSQL - Qiita
https://qiita.com/masakinihirota/items/ee83b0d210d1dd224046



## 参考

User Management | Supabase Docs

https://supabase.com/docs/guides/auth/managing-user-data#using-triggers
















----------------------------------------
----------------------------------------

これより下は、未実装、未確認





----------------------------------------




##





##








----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

#





##





##





----------------------------------------

# 参考

RLS(Row Level Security)入門ガイド Supabase(Postgres)データセキュリティの基礎 #PostgreSQL - Qiita

https://qiita.com/masakinihirota/items/011c9ee596f6e4bcc78a

Next.js 13 App router と Supabase での４つのアクセス方法 #Next.js - Qiita

https://qiita.com/masakinihirota/items/b4b168a056dc10776d87

Next.js 14 App router Middlewareを複数のファイルに分割する方法 #Next.js - Qiita

https://qiita.com/masakinihirota/items/c84daec1a48ee0a02199

Next.jsでの初心者向け Middleware.ts入門 (v13.1.0) ＋ 公式マニュアル 解説 ＋ 複数のMiddlewareの実装方法 #Next.js - Qiita

https://qiita.com/masakinihirota/items/30a5e06e3288031b9788


# 独自ドメインの設定

Vercelで独自ドメインを設定する方法 | YoheiKoブログ
https://yoheiko.com/blog/vercel%E3%81%A7%E3%81%AE%E7%8B%AC%E8%87%AA%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E8%A8%AD%E5%AE%9A/

Next.js App Router 開発用テンプレートに shadcn/ui でダークモードを実装する。 #DarkMode - Qiita

https://qiita.com/masakinihirota/items/7cf6181ba61fe9dc3802



## 外部への公開ドキュメント用

Nextra
ScreenToGif

Nextra 無料で簡単にドキュメントをMarkdownで編集出来る静的サイトを作るツール (ドキュメント編) #Next.js - Qiita

https://qiita.com/masakinihirota/items/c9c80914b227a1716cdc

ScreenToGif - 画面を録画し、編集して GIF、ビデオ、またはその他の形式で保存します。

https://www.screentogif.com/

## 開発を助ける 外部アプリ&外部ツール データベース関連

pgAdmin 4
DBeaver
Postman

pgAdmin - PostgreSQL Tools

https://www.pgadmin.org/

DBeaver Community | Free Universal Database Tool

https://dbeaver.io/

Postman API Platform | Sign Up for Free

https://www.postman.com/





----------------------------------------
----------------------------------------