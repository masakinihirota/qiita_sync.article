Text-To-SQL with Supabase AI Editor - YouTube
https://www.youtube.com/watch?v=8t1-Bgb4WJs

Transcript:
today let's put the superbase text tosql AI Editor to the test by building a swack Redemption mini site so this is a mini site I don't always want to bring all the t-shirts to meetups so I just built this mini site where I have the email addresses um of the attendees preset and then I can put in my email here I say send me a coach uh and then when I check my email inbox I get an email here hey thanks for attending the superbase Meetup you can use this discount code to get one D mode t-shirt lovely so how can we do this so
I have my superbase project here uh I have a simple uh database table called super Swag Codes and I have the email the swag code and the then uh the claimed Boolean so with the Swag Codes I actually just have um a CSV and I import them from a CSV so I have all the the Swag Codes um and then also the email addresses so that's kind of how I do this I get all the attendee email addresses I put all the Swag Codes just in like um Google sheet file downloaded as CSV and then import the data from the CSV here and now the important thing is
we want to have um RLS enabled here because you know obviously we have an uh email address now this is personal sensitive sensitive data so do make sure you have RLS enabled and then we don't have any policies because we actually don't want to be able to you know uh read this data or um manipulate this data from the client site so we only want to do that securely kind of in the database on the back end now there is is a fine little trick that we can do and that is called remote procedure calls so basically let's have a quick look into
our source code the source code is linked here now one top tip on GitHub as well if you replace the com with def you get a vs code um right in the browser and here I have my app it's um simple Dino freshh um application and I have my index file here uh the index file is uh basically just this um header the product details um the product details are just kind of the image uh if we're going back image and then here there's a email input form uh we can have a quick look so this is the uh email form and the email form is
just a form with um a method post so it's just doing a post um submit when we hit the submit button and so in our index then we have um this Handler here so in the case of a guest get request we're simply just rendering um our form and then in the TA in the case of a post kind of form submit we can get the form data from the request uh we can then get the email from the form data and so now here this is where the magic happens so you know we don't we haven't exposed our um database table at all but we're
calling uh an RPC so a remote procedure call um we're calling a database function that is called update claimed and we're passing in this email input which is the email address and then we're just getting data back the data is um either true or false and we're basically just checking okay you know if it was true then say um thanks and if it was false then just say not found okay great and so let's go to our um superbase project so now in the SQL editor here we have ask superbase AI to build a query
and what we can do is here in the settings we can say include Anonymous database metadata now this is important so that um you know the AI has kind of knowledge about the schema of our super Swag Codes okay and so basically now we're just going to say um create uh SQL function that takes in an email address and updates the claimed column to True um with security definer now security definer is important so um if we execute the function we want the security rule to be the one uh who defined this function rather than the one who's calling the
function from the client side so this is kind of where we get around the RLS issue um so by setting security definer um our function can actually execute here as kind of um an sort of uh service role user here uh postest user and okay let's give that a hit and so we now say Okay create um or replace function update claimed we take in the email as text it says returns void here so we'll still need to update that and then we say update public Swag Codes set claimed to True where um email uh equals the email and the yeah
language security um definer okay this is great now what we can say as well now because currently this's returns void but we actually want to return a Boolean um you know when this was successful so we say update the function to return a bullan if the um update call was uh successful okay let's give that save and so we can now say uh returns Boolean and then we can say return found um and lastly uh we want to say okay you know where email is email um yeah accept changes this is great um and now the last thing however we want um where
email is email and then also we want um and uh well actually you know let's assume we don't we don't know let's let's uh okay update function um to only update uh a row if claimed is not true you know because obviously we want don't want to allow them to do double claimed so we can say yes we email um is email and claimed is not true yep I think that's pretty much it um there we are and then lastly one thing unfortunately the the AI didn't catch here is that email is um ambigous here so we'll say
email input um and then we say where email equals email input and now um we already have this um update claim so we say update claimed AI let's call it that so we can um we can test that out and now we'll just say um run okay there's an issue let's say debug um were there any changes I don't see any changes accept changes let's see run h ahuh okay now I don't really know what the changes were uh create or replace function update claim AI email input text returns bullan
begin uh security definer yes um yeah and there we have it this is this is pretty cool now we can go back into our project so basically you know this is what we're doing here just checking if that is all good so basically now if I try to um claim again uh you say sorry either already claimed or your email Isn't registered Yep this is great that's exactly what we want um and then actually what we're doing here is as well we have a super base function um to send the email code um and so this is working off of uh
a database web hook so you can see here if we're going to um database web hooks we have um this email here send Swag Codes um and we're triggering this on uh update events so anytime there's an update event we then trigger um this function and so we can see when the function is um triggered then we have um this uh record and we're basically um checking if [Music] um so this is the case if payload record claimed so if claimed is not true uh then we're actually not executing this so only if um claimed is set to True uh
then we actually want to send the email um with the claim details and now we also have an um a video I'll link it at the top and the bottom um about sending emails via Edge functions uh using the resend API uh so you can dig into that but that's basically just what we're doing here um we're sending from our custom domain saying super Bas swack incoming and then if we're checking our email here we got this and yeah obviously do follow me on Twitter if you wish to do so all right thanks for
tuning in and see you next time
