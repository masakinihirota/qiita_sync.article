<!--
title:   Next.js App router 認証機能付き 開発用テンプレート
tags:    Next.js,Supabase,メール認証
id:      12da291e560c4850b511
private: true
-->



TODO
Next.js Supabase認証機能付きインストール

npx create-next-app -e with-supabase
を
i18nに対応させる

VNSを設計する

データベースを設計する

データのやり取りを行う

デプロイする




# インストール

npx create-next-app -e with-supabase


# 微調整

## 環境ファイルを作る

Vercelにデプロイしてから連携してあるので
.envは不要

※Supabaseでプロジェクトを作成済みで、
プロジェクトの設定情報は知っているものとします。

touch .env.local

```.env.local
NEXT_PUBLIC_SUPABASE_URL=https://zhlmcrnnjbsfhbnctenz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ey***********************************74

```

.env.local.example
は削除します。






# srcフォルダの作成 ディレクトリの移動

mkdir src

srcの下にappディレクトリとcomponentsディレクトリを移動します。


tsconfig.jsonファイルを一部変更

```tsconfig.json
    "paths": {
      "@/*": ["./src/*"]
    }

```




tailwind.config.jsファイルを一部変更

```tailwind.config.js
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
。。。

```

※src/pages はNext.jsのpages dirを使っていたときの名残です。
Next.js 13 は pages dir と app dir の両方を同時に使えるので残しておきます。


動作確認

npm run dev





mkdir src/styles

src\app\globals.css
を
src\styles\globals.css
へ移動します。


パスの修正をします。

```src\app\layout.tsx
import "@/styles/globals.css"

```



動作確認

npm run dev




package.jsonファイルを一部変更

```package.json
  "name": "vns.blue",
  "version": "0.1.0",

```

※名前は自由につけてください。






# eslintのインストール

npm i eslint eslint-config-next


touch .eslintrc.json

.eslintrc.json(初期)

```.eslintrc.json
{
  "extends": "next/core-web-vitals"
}

```



## tsconfig.json

TypeScriptを開発しやすくする

```tsconfig.json (変更箇所)
    "strict": false,
    "strictNullChecks": true,

```




"strict": false は、以下の設定を無効にします。

"noImplicitAny": true：暗黙的にany型として解釈される式を許可しません。
"strictNullChecks": true：nullとundefinedの扱いに関する厳密な型チェックを有効にします。
"strictFunctionTypes": true：関数の型チェックを厳密に行います。
"strictPropertyInitialization": true：クラスのプロパティの初期化を厳密に行います。
"noImplicitThis": true：thisの型チェックを厳密に行います。

↑この５つのうち

"strictNullChecks"だけ有効にします。


動作確認

npm run dev



# i18n

i18nサンプル(2023src\__vns\lab\nexti18n)の
(これはi18nextの公式Blogサンプルを流用したもの)
src\app\[lng]\ 以下
src\app\i18n\ 以下
をコピーする


ライブラリのインストール
npm i accept-language i18next i18next-browser-languagedetector i18next-resources-to-backend react-cookie react-i18next


```src\app\layout.tsx
import "@/styles/globals.css"

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <main className="flex flex-col items-center min-h-screen bg-background">{children}</main>
      </body>
    </html>
  )
}

```



```src\app\page.tsx
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs"
import { cookies } from "next/headers"
import Link from "next/link"
import LogoutButton from "../components/LogoutButton"

export const dynamic = "force-dynamic"

const examples = [
  { type: "Client Components", src: "app/_examples/client-component/page.tsx" },
  { type: "Server Components", src: "app/_examples/server-component/page.tsx" },
  { type: "Server Actions", src: "app/_examples/server-action/page.tsx" },
  { type: "Route Handlers", src: "app/_examples/route-handler.ts" },
]

export default async function Index() {
  const supabase = createServerComponentClient({ cookies })

  const {
    data: { user },
  } = await supabase.auth.getUser()

  return (
    <div className="flex flex-col items-center w-full">
      <nav className="flex justify-center w-full h-16 border-b border-b-foreground/10">
        <div className="flex items-center justify-between w-full max-w-4xl p-3 text-sm text-foreground">
          <div />
          <div>
            {user ? (
              <div className="flex items-center gap-4">
                Hey, {user.email}!
                <LogoutButton />
              </div>
            ) : (
              <Link
                href="/login"
                className="px-4 py-2 no-underline rounded-md bg-btn-background hover:bg-btn-background-hover"
              >
                Login
              </Link>
            )}
          </div>
        </div>
      </nav>

      <main>
        {/* <Link href={`/${lng}/login`}></Link> */}
        <Link href={`/en`}>英語</Link>
        <Link href="/de">ドイツ語</Link>
        <Link href="/ja">日本語</Link>
      </main>
    </div>
  )
}

```








----------------------------------------




pnpm i @supabase/auth-helpers-nextjs @supabase/supabase-js encoding


    "": "latest",
    "": "latest",
    "encoding": "^0.1.13"
  }
}

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































