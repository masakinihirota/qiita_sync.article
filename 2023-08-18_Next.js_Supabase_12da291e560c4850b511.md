<!--
title:   Next.js App router 認証機能付き 開発用テンプレート
tags:    Next.js,Supabase,メール認証
id:      12da291e560c4850b511
private: true
-->

----------------------------------------

git tagの付け方
コミット後に
git tag <tagname>



----------------------------------------

TODO

Next.js Supabase認証機能付きインストール

npx create-next-app -e with-supabase
を
i18nに対応させる

VNSを設計する

データベースを設計する

データのやり取りを行う

デプロイする


----------------------------------------


# Next.jsインストール

推奨リポジトリをインストールします。

npx create-next-app -e with-supabase

Next.jsの公式サンプルの一つです。
↓このリポジトリをそのまま利用します。

next.js/examples/with-supabase at canary · vercel/next.js

https://github.com/vercel/next.js/tree/canary/examples/with-supabase






動作確認
npm run dev

まだ、動かない
Supabaseの環境ファイルが必要です。

Supabaseのプロジェクトを作って環境変数を取得する必要があります。



# 環境ファイルを作る

※Supabaseでプロジェクトを作成済みで、
プロジェクトの設定情報は知っているものとします。

touch .env.local

```.env.local
NEXT_PUBLIC_SUPABASE_URL=https://zhlmcrnnjbsfhbnctenz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=ey***********************************74

```

.env.local.example
は削除します。



動作確認
npm run dev
npm run build
npm run start

※npm run devで起動していると、npm run buildは動作しません。



----------------------------------------

# GitHubへの PUSH と Vercelへのデプロイ ＋ 独自ドメイン

動作確認できたのでGitHubとVercelに一気にデプロイします。

Next.js ✖️ SupabaseプロジェクトのVercelへのデプロイメモ
https://zenn.dev/shgs/articles/6b7fde20a6a596


## GitHub へのPUSH

GitHubへはVSCodeの機能 ソース管理で簡単にリポジトリが作成され、PUSH出来ました。



## Vercel へのデプロイ

VercelへGitHubに作ったリポジトリをデプロイします。

https://vercel.com/

右上の Add Newボタンを押して
Projectを選択します。

先程作ったリポジトリを選び Importボタンを押します。


Supabaseを使用しているので
Environment Variablesを設定します。


NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJh*************************X8"
NEXT_PUBLIC_SUPABASE_URL="https://gzctqdrrnnkaxwwtzbsw.supabase.co"

環境変数を入力したら Add ボタンを押して一つづつ登録していきます。

デプロイと、ビルドが完了するまでしばらく待ちます。


Congratulationsと表示されたら成功です。



----------------------------------------

## 独自ドメインの設定

Vercelで独自ドメインを設定する方法 | YoheiKoブログ
https://yoheiko.com/blog/vercel%E3%81%A7%E3%81%AE%E7%8B%AC%E8%87%AA%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E8%A8%AD%E5%AE%9A/



----------------------------------------

# Vercel上でSupabaseと連携する

Integrationsに行き

連携するSupabaseを探します。

Vercel | Works With Supabase
https://supabase.com/partners/integrations/vercel

これでSupabaseの環境変数などは自動的に取得されます。


ローカルにVercelが取得した環境変数を取得します。

ローカルでVercelへのログイン
npx vercel login
	GitHubを選択します。



ローカル上からVercelとリンクするプロジェクトの選択
npx vercel link
	リンクするプロジェクトを選択します。



環境変数をローカルに取得します。
npx vercel env pull
	.env.localに出力されます。
	.gitignoreに入れる必要があります。（デフォルトでは記入されています。）

すでに.env.localがある場合は削除してからコマンドを実行すると再生成されます。



これでローカルで開発を行い。
GitHubへPUSHすると
自動的にVercelへデプロイが走るようになります。

環境は、開発中ですと簡単に壊れるので随時「注視」が必要です。



----------------------------------------



# srcフォルダの作成 ディレクトリの移動

mkdir src

srcの下にappディレクトリとcomponentsディレクトリを移動します。


tsconfig.jsonファイルを一部変更

```tsconfig.json
    "paths": {
      "@/*": ["./src/*"]
    }

```




tailwind.config.jsファイルを一部変更

```tailwind.config.js
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  darkMode: "media",
  theme: {
。。。

```

※src/pages はNext.jsのpages dirを使っていたときの名残です。
Next.js 13 は pages dir と app dir の両方を同時に使えるので残しておきます。

darkMode: "media",を追加します。



mkdir src/styles

src\app\globals.css
を
src\styles\globals.css
へ移動します。


パスの修正をします。

```src\app\layout.tsx
import "@/styles/globals.css"

```



src\styles\globals.css内容の修正

```src\styles\globals.css
@tailwind base;
@tailwind components;
@tailwind utilities;

```

src\app\layout.tsx パスの修正

```
import "@/styles/globals.css";

```



package.jsonファイルを一部変更

```package.json
  "name": "vns.blue",
  "version": "0.1.0",

```

※名前は自由につけてください。



# eslintのインストール

npm i eslint eslint-config-next


touch .eslintrc.json

.eslintrc.json(初期)

```.eslintrc.json
{
  "extends": "next/core-web-vitals"
}

```



## tsconfig.json

TypeScriptを開発しやすくする

```tsconfig.json (変更箇所)
    "strict": false,
    "strictNullChecks": true,

```



"strict": false は、以下の設定を無効にします。

"noImplicitAny": true：暗黙的にany型として解釈される式を許可しません。
"strictNullChecks": true：nullとundefinedの扱いに関する厳密な型チェックを有効にします。
"strictFunctionTypes": true：関数の型チェックを厳密に行います。
"strictPropertyInitialization": true：クラスのプロパティの初期化を厳密に行います。
"noImplicitThis": true：thisの型チェックを厳密に行います。

↑この５つのうち

"strictNullChecks"だけ有効にします。


動作確認

npm run dev



----------------------------------------

# i18n

i18n with Next.js 13 and app directory / App Router (an i18next guide)

https://locize.com/blog/next-13-app-dir-i18n/

↑このBlogを参考に↓リポジトリを作成しました。

masakinihirota/i18n

https://github.com/masakinihirota/i18n

i18nサンプル(2023src\__vns\lab\nexti18n)の
(これはi18nextの公式Blogサンプルを流用したものです。)
src\app\[lng]\ 以下
src\app\i18n\ 以下
をコピーします。



ライブラリのインストール
npm i accept-language i18next i18next-browser-languagedetector i18next-resources-to-backend react-cookie react-i18next



動作確認
npm run dev
npm run build
npm run start



----------------------------------------

# Layout


```src\app\layout.tsx
import "@/styles/globals.css";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body>
        {/* ↓ログイン画面に影響を与えている */}
        <main className="flex flex-col items-center min-h-screen bg-background">
          {children}
        </main>
      </body>
    </html>
  );
}

```

動作確認
npm run dev
npm run build
npm run start



```src\app\page.tsx
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import Link from "next/link";
import LogoutButton from "../components/LogoutButton";

export const dynamic = "force-dynamic";

export default async function Index() {
  const supabase = createServerComponentClient({ cookies });

  const {
    data: { user },
  } = await supabase.auth.getUser();

  return (
    // 全体を縦にならべている、幅いっぱいに並べている
    <div className="flex flex-col items-center w-full">
      {/* nav部分 Home ,Advertisement, Dark mode,Language, Login */}
      {/* ナビ部分の高さを決めている、ボーダーラインボトムを描いている ボーダー色は現在の文字色
      ナビ部分とメイン部分の分離箇所 */}
      <nav className="flex justify-center w-full h-16 border-b border-current">
        {/* ナビ部分 上下中央に揃えている 横に均等にならべている 幅いっぱいに使っている */}
        <div className="flex items-center justify-between w-full">
          VNS.BLUE
          <div />
          Dark mode
          <div />
          Language
          <div />
          Advertisement
          <div>
            {user ? (
              <div className="flex items-center gap-4">
                Hey, {user.email}!
                <LogoutButton />
              </div>
            ) : (
              <Link
                href="/login"
                className="px-4 py-2 no-underline rounded-md bg-btn-background hover:bg-btn-background-hover"
              >
                Login
              </Link>
            )}
          </div>
        </div>
      </nav>
      <main className="flex flex-col w-full max-w-4xl p-3 text-xl text-foreground">
        <Link href="./examples/client-component">Client Component Example</Link>
        <Link href="./examples/route-handler">Route Handler Example</Link>
        <Link href="./examples/server-action">Server Action Example</Link>
        <Link href="./examples/server-component">Server Component Example</Link>
        <br />
        {/* <Link href={`/${lng}/login`}></Link> */}
        <Link href={`/en`}>英語</Link>
        <Link href="/de">ドイツ語</Link>
        <Link href="/ja">日本語</Link>
      </main>
      <div />
      <footer className="flex items-center justify-center h-16">
        VNS.BLUE 2023
      </footer>
    </div>
  );
}

```



```src\app\[lng]\layout.js
import { dir } from "i18next";
import { languages } from "../i18n/settings";

export async function generateStaticParams() {
  return languages.map((lng) => ({ lng }));
}

export default function RootLayout({ children, params: { lng } }) {
  return (
    <div lang={lng} dir={dir(lng)}>
      {children}
    </div>
  );
}

```



動作確認
npm run dev
npm run build
npm run start



※LinkボタンでTOP画面に戻ると画面が真っ暗
リロードで治る



----------------------------------------

# Supabaseとのアクセス

Next.js 13 App router と Supabase での４つのアクセス方法 - Qiita

https://qiita.com/masakinihirota/items/b4b168a056dc10776d87


vns\app\_examples
を
vns\app\examples
に変更します。

Supabaseのダッシュボードを開きます。

SQL Editorを開きます。

```
create table if not exists todos (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  title text,
  is_complete boolean default false,
  user_id uuid references auth.users default auth.uid()
);

-- Set up Row Level Security (RLS)
-- See https://supabase.com/docs/guides/auth/row-level-security for more details.
alter table todos
  enable row level security;

create policy "Authenticated users can select todos" on todos
  for select to authenticated using (true);

create policy "Authenticated users can insert their own todos" on todos
  for insert to authenticated with check (auth.uid() = user_id);

```

を貼り付けます。

右下の 「RUN CTRL」ボタンを押して 成功したら メッセージ ↓Successを確認できます。

「Success. No rows returned」

これで todos テーブルが出来ました。



シードファイルをサーバーに適用する

```
insert into todos(title)
values
  ('Create Supabase project'),
  ('Create Next.js app from Supabase Starter template'),
  ('Keep building cool stuff!');

```

シードファイルもテーブル作成と同様にSQL文を貼り付けて実行します。

Supabaseのダッシュボードの Table Editor で todosテーブルを選択すると。
データも入っていることが確認できます。

これでSupabase側の下準備は完了です。

これからNext.jsのコードからSupabaseにアクセスして
そのデータを表示するまでを実践します。


4つの接続方法

1. クライアントから Supabaseのデータを取得する方法
2. ルートハンドラーで Supabaseのデータを取得する方法
3. Server ActionsでSupabaseのDBを操作する方法
4. サーバーコンポーネントで Supabaseのデータを取得する方法


トップページに4つのリンクが表示されます。

```
Client Component Example
Route Handler Example
Server Action Example
Server Component Example

```




動作確認

npm run dev

http://localhost:3000/

正常に動作しているのならば

ログインしていない場合
データは表示されません、
Server Actionは実行されません

ログインしている場合
データが表示されます。
Server Actionを利用してテーブルにデータを挿入できます。
※連打すると連打した分だけデータが挿入されます。

コードの解説はBlog記事を読んでください。

これで最低限のWebアプリが完成しました。



>最低限のWebアプリとは？
ユーザーを登録、ログインできる。
DBを作り、その中にデータを入力して、データにアクセスできる。
ブラウザからデータを指定して呼び出して、画面に表示させる。
ブラウザからデータを入力してDBに登録できる。
その登録したデータを表示できる。



一段落ついたので
gitのタグを作成
tag i18n



----------------------------------------

# 次へ

TODO

このウェブアプリに、新たな機能、目的にあったデータ出力等を実装していきます。

その前にまずは開発しやすいように
基本的な開発環境に整えていきます。



i18n化 終了
	後から追加するほうが複雑化しやすいので先に実装しておきます。
	 [i18n]フォルダを作って言語の動的フォルダを作る必要があります。

huskey
	自動ビルド＆成功時にPUSH

ESlint
	より便利に設定をします。
Prettier

Darkmode

装飾

Storybook

セキュリティ RLS



----------------------------------------

基本的な使い方 huskey v8 コミット時に自動ビルド or 自動テスト 失敗時にコミットは実行されない。 成功時は通常通り。 - Qiita

https://qiita.com/masakinihirota/items/217ae8fc036e605e0482

# huskey インストール

公式サイト
Getting started | 🐶 husky

https://typicode.github.io/husky/getting-started.html

現在のバージョンは
"husky": "^8.0.0"



自動インストール（推奨）

```
npx husky-init && npm install

```



インストールされる中の詳細は公式サイトを御覧ください。



## buildコマンドの追加

ファイルを開いて編集します。

```.husky\pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npm run build   ＜＜＜ここに実行したいnpm scriptを書きます。

```

これでコミット時に「バックグラウンド」で npm run build が走り
buildが失敗するとコミットがされません。＜＜便利
buildが成功するとコミットは通常通りです。

後でlintコマンド等を追加予定。


コマンドの追加コマンド

npm testを追加したい場合

```terminal
npx husky add .husky/pre-commit "npm test"

```



動作確認はこれからはhuskeyまかせ？
npm run devの方だけでも確認する。


git tag huskey



----------------------------------------

ファビコン

VNS.BLUEのイメージの色

青系統の色に決める。

RGB	#
0		00
126		7E
254		FE

#007EFE

ファビコンを作り書き換えます。

src\app\favicon.ico



----------------------------------------




## middleware

2つのリポジトリ
with-supabase
と
i18n
この2つのmiddlewareをまとめます。

middleware.ts
に拡張子を変更します。



```middleware.ts
import { createMiddlewareClient } from "@supabase/auth-helpers-nextjs";
import { NextResponse } from "next/server";

import type { NextRequest } from "next/server";

import acceptLanguage from "accept-language";

import { fallbackLng, languages, cookieName } from "@/app/i18n/settings";

acceptLanguage.languages(languages);

export const config = {
  // matcher: '/:lng*'
  matcher: ["/((?!api|_next/static|_next/image|assets|favicon.ico|sw.js).*)"],
};

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();

  // Create a Supabase client configured to use cookies
  const supabase = createMiddlewareClient({ req, res });

  // Refresh session if expired - required for Server Components
  // https://supabase.com/docs/guides/auth/auth-helpers/nextjs#managing-session-with-middleware
  await supabase.auth.getSession();

  let lng;
  if (req.cookies.has(cookieName))
    lng = acceptLanguage.get(req.cookies.get(cookieName)?.value);
  if (!lng) lng = acceptLanguage.get(req.headers.get("Accept-Language"));
  if (!lng) lng = fallbackLng;

  // Redirect if lng in path is not supported
  if (
    !languages.some((loc) => req.nextUrl.pathname.startsWith(`/${loc}`)) &&
    !req.nextUrl.pathname.startsWith("/_next")
  ) {
    return NextResponse.redirect(
      new URL(`/${lng}${req.nextUrl.pathname}`, req.url)
    );
  }

  const refererHeaderValue = req.headers.get("referer");

  if (refererHeaderValue !== null) {
    const refererUrl = new URL(refererHeaderValue);
    const lngInReferer = languages.find((l) =>
      refererUrl.pathname.startsWith(`/${l}`)
    );
    const res = NextResponse.next();
    if (lngInReferer) res.cookies.set(cookieName, lngInReferer);
    return res;
  }

  return res;
}

```



動作、エラー確認
ブラウザの調査検証画面を開いておく
ブラウザのコンソール画面を開く

npm run dev



----------------------------------------

ここでブラウザのコンソール画面にエラーが出ているのに気づく

```
app-index.js:31 Warning: Extra attributes from the server: class
    at body
    at html
    at RedirectErrorBoundary 

```

原因は
ブラウザの拡張機能

問題解決
https://www.slingacademy.com/article/next-js-warning-extra-attributes-from-the-server/



対応策は
ブラウザのシークレット画面を利用する。とエラーが出てこない。

拡張機能を使用しない。とエラーが出てこない。

<body suppressHydrationWarning={true}>
bodyタグに プロパティを設定するする。

↑suppressHydrationWarningプロパティは、
Reactがクライアント側でレンダリングされたコンポーネントを
ハイドレーションする際に、
警告を抑制するために使用されます。



```src\app\layout.tsx
import "@/styles/globals.css";

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <head />
      <body suppressHydrationWarning={true}>{children}</body>
    </html>
  );
}

```



動作、エラー確認
ブラウザの調査検証画面を開いておく
ブラウザのコンソール画面を開く

npm run dev



----------------------------------------

# eslint & prettier

# eslintの詳細な設定

## .eslintignore ファイルの作成

.eslintignore を作成します。

touch .eslintignore

↓lint 対象から外したいファイルを設定します。

```.eslintignore
# config
.eslintrc.json
.prettierrc
next.config.js
tailwind.config.js
tsconfig.json
postcss.config.js

# build dir
build/
bin/
obj/
out/
.next/

# 自動生成されたファイル
package-lock.json

# Storybook
*.stories.ts
*.stories.tsx

# CSSファイル
*.css

# mdxファイル
*.mdx

# すべての画像ファイルを除外する
**/*.png
**/*.jpg
**/*.jpeg
**/*.gif
**/*.ico

```















































































































































































































































































































































































































































